<!DOCTYPE html>
<!-- ═══════════════════════════════════════════════════════════════
     GlicoLog PWA v6 — Diario personale per la gestione del diabete
     Single-file app: tutto in un unico index.html (CSS + HTML + JS)
     ═══════════════════════════════════════════════════════════════ -->
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#080b10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlicoLog">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&family=Bebas+Neue&display=swap" rel="stylesheet">
<script src="db_crea.js"></script>
<title>GlicoLog</title>
<style>
/* ═══════════════════════════════════════════════════════════════
   SEZIONE: CSS — DESIGN TOKENS
   Variabili CSS globali usate da tutta l'app.
   --bg/bg2: sfondi dark; --card/card2: superfici elevate
   --g verde; --o arancio; --r rosso; --b azzurro; --p viola
   --alc arancio bruciato per alcool; --nut turchese per nutrition
   --mono/'--sans/'--disp: font stack (DM Mono/DM Sans/Bebas Neue)
   ═══════════════════════════════════════════════════════════════ */
:root {
  --bg:    #080b10;
  --bg2:   #0d1117;
  --card:  #111620;
  --card2: #161d28;
  --bdr:   rgba(255,255,255,0.07);
  --bdr2:  rgba(255,255,255,0.13);
  --g:     #00e676;
  --o:     #ffab40;
  --r:     #ff5252;
  --b:     #40c4ff;
  --p:     #ce93d8;
  --txt:   #e8eef6;
  --txt2:  #7a8899;
  --txt3:  #b0bec5;
  --mono:  'DM Mono', monospace;
  --sans:  'DM Sans', sans-serif;
  --disp:  'Bebas Neue', sans-serif;
  --alc:   #ff8a65;
  --nut:   #80cbc4;
}

/* Reset globale + box-sizing */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{background:var(--bg)}
body{font-family:var(--sans);color:var(--txt);background:var(--bg);min-height:100vh;overscroll-behavior:none;font-size:16px}


/* ═══════════════════════════════════════════
   HEADER — barra fissa in cima, logo + orologio
   ═══════════════════════════════════════════ */
.hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px 12px;
  padding-top:calc(14px + env(safe-area-inset-top));
  background:var(--bg);border-bottom:1px solid var(--bdr);
  position:sticky;top:0;z-index:50;position:relative
}
.logo{font-family:var(--disp);font-size:1.65rem;letter-spacing:1px;line-height:1}
.logo em{color:var(--g);font-style:normal}
.clk{text-align:center;position:absolute;left:50%;transform:translateX(-50%);pointer-events:none}
.clk-t{font-family:var(--mono);font-size:1.05rem;font-weight:500;line-height:1}
.clk-d{font-size:0.66rem;color:var(--txt2);margin-top:2px;letter-spacing:0.3px}


/* INSTALL BANNER — invito installazione PWA */
.ibar{
  display:none;margin:10px 14px 0;
  background:rgba(0,230,118,0.05);border:1px solid rgba(0,230,118,0.18);
  border-radius:12px;padding:10px 12px;align-items:center;gap:10px
}
.ibar.on{display:flex}
.ibar-t{flex:1;font-size:0.73rem;color:var(--txt3);line-height:1.4}
.ibar-t strong{color:var(--g);display:block;font-size:0.78rem}
.ibar-b{background:var(--g);color:#000;border:none;border-radius:7px;font-family:var(--sans);font-weight:600;font-size:0.73rem;padding:7px 11px;cursor:pointer;white-space:nowrap}
.ibar-x{background:none!important;color:var(--txt2)!important;border:none;padding:4px;cursor:pointer;font-size:0.9rem}


/* ═══════════════════════════════════════════════════════════════
   ACTION BUTTONS — griglia 3×2 bottoni principali "+Azione"
   .ba      = button base (card sfondo, bordo, flex-column centrato)
   .ba::after = striscia colorata in cima (2px, border-radius 1px)
   .ba:active = scala a 0.92 + sfondo più scuro per feedback tocco
   Varianti colore per striscia + active state:
     .ba-p = verde (pasto)   .ba-s = arancio (spuntino)
     .ba-g = azzurro (glicemia)  .ba-i = viola (insulina)
     .ba-sp = celeste (sport)    .ba-w = celeste sfumato (acqua)
   .ba .ico  = emoji icona grande
   .ba .plus = "+" piccolo monofonted sopra l'icona
   .ba .lbl  = etichetta testo piccolo sotto
   ═══════════════════════════════════════════════════════════════ */
.acts{display:grid;gap:6px;padding:8px 14px 0}
.ba{
  background:var(--card);border:1px solid var(--bdr);border-radius:14px;
  padding:13px 4px 11px;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  position:relative;overflow:hidden;
  transition:transform .12s,background .12s
}
.ba::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:1px}
.ba:active{transform:scale(0.92)}
.ba-p::after{background:var(--g)} .ba-p:active{background:#0b160d}
.ba-s::after{background:var(--o)} .ba-s:active{background:#16100a}
.ba-g::after{background:var(--b)} .ba-g:active{background:#081420}
.ba-i::after{background:var(--p)} .ba-i:active{background:#130c1a}
.ba .ico{font-size:1.25rem;line-height:1}
.ba .plus{font-family:var(--mono);font-size:0.7rem;color:var(--txt2);font-weight:500}
.ba .lbl{font-size:0.68rem;font-weight:600;color:var(--txt2);letter-spacing:0.2px;text-align:center;line-height:1.2}


/* ═══════════════════════════════════════════════════════════════
   STRIP — chip di riepilogo giornaliero
   Barra orizzontale scrollabile di pill/chip compatti.
   .chip.ok = in range (verde), .chip.warn = elevato (arancio),
   .chip.bad = critico (rosso), .chip.hi = bianco = valore neutro
   ═══════════════════════════════════════════════════════════════ */
.strip{display:flex;gap:7px;padding:12px 14px 0;overflow-x:auto;scrollbar-width:none}
.strip::-webkit-scrollbar{display:none}
.chip{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:10px 16px;white-space:nowrap;font-family:var(--mono);font-size:0.82rem;color:var(--txt2);flex-shrink:0;display:inline-flex;align-items:center;gap:5px}
.chip b{font-weight:500}
.chip.ok b{color:var(--g)}.chip.warn b{color:var(--o)}.chip.bad b{color:var(--r)}.chip.hi b{color:var(--txt)}


/* DAY NAV — frecce per navigare tra i giorni */
.daynav{display:flex;align-items:center;gap:8px;padding:12px 14px 8px}
.dn-btn{background:var(--card);border:1px solid var(--bdr2);border-radius:10px;color:var(--txt);width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer;flex-shrink:0;transition:background .12s}
.dn-btn:active{background:var(--card2)}
.dn-lbl{flex:1;text-align:center;font-size:1.05rem;color:var(--txt);font-weight:600;letter-spacing:.2px}
.oggi-b{display:inline-block;background:rgba(0,230,118,.14);color:var(--g);font-size:.65rem;font-weight:700;padding:2px 7px;border-radius:4px;margin-left:6px;vertical-align:middle;letter-spacing:.5px}


/* ═══════════════════════════════════════════
   STATS — sezione statistiche e grafico
   ═══════════════════════════════════════════ */
.sw{padding:12px 14px 0}
.st-tog{
  width:100%;background:var(--card);border:1px solid var(--bdr);border-radius:11px;
  color:var(--txt);font-family:var(--sans);font-weight:600;font-size:0.92rem;
  padding:12px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background .12s
}
.st-tog:active{background:var(--card2)}
.st-tog .arr{font-size:.7rem;transition:transform .2s}
.st-tog.open .arr{transform:rotate(180deg)}
.st-body{display:none;padding-top:8px}
.st-body.show{display:block}
.sgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px}
.sbox{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:10px 6px;text-align:center}
.sbox-v{font-family:var(--mono);font-size:1.2rem;font-weight:500;display:block}
.sbox-l{font-size:.62rem;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-top:3px;display:block}
.cbox{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:12px;margin-bottom:8px;position:relative}
.cbox-t{font-size:.72rem;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px;font-weight:600}
canvas{width:100%!important;display:block}
.exp-b{width:100%;background:var(--card);border:1px solid var(--bdr);border-radius:10px;color:var(--txt2);font-family:var(--sans);font-size:.84rem;font-weight:500;padding:11px;cursor:pointer;margin-bottom:3px;transition:background .12s}
/* MONTHLY CALENDAR — griglia 7×N celle del calendario mensile
   .mcal-day      = cella giorno cliccabile (onclick→goToDay)
   .mcal-day.empty = cella vuota per sfalsamento primo giorno settimana
   .mcal-dn       = numero del giorno (piccolo, in cima)
   .mcal-avg      = valore medio glicemia colorato per range
   .mcal-badges   = container badge ▼bassi / ▲alti
   .mcal-low/.high = badge colorati con conteggio episodi
   .mcal-bar      = barra colorata in fondo proporzionale al valore
   .mcal-wkday    = intestazione L M M G V S D */
.mcal-day{border-radius:8px;padding:4px 3px;min-height:44px;background:var(--card);cursor:pointer;transition:background .1s;position:relative;overflow:hidden}
.mcal-day:hover{background:var(--card2)}
.mcal-day.empty{background:transparent;cursor:default}
.mcal-dn{font-size:.6rem;color:var(--txt2);margin-bottom:1px;font-family:var(--sans);font-weight:500}
.mcal-avg{font-size:.78rem;font-weight:700;line-height:1.15;font-family:var(--sans)}
.mcal-badges{display:flex;gap:2px;flex-wrap:wrap;margin-top:2px}
.mcal-badge{font-size:.55rem;padding:1px 3px;border-radius:3px;font-family:var(--sans);font-weight:700;line-height:1.2}
.mcal-low{background:rgba(255,82,82,.22);color:#ff5252}
.mcal-high{background:rgba(255,171,64,.22);color:#ffab40}
.mcal-bar{position:absolute;bottom:0;left:0;right:0;height:2px}
.mcal-wkday{font-size:.6rem;color:var(--txt2);text-align:center;padding:3px 0;font-family:var(--sans);font-weight:600;letter-spacing:.3px}
.exp-b:active{background:var(--card2)}
.pdf-opt-btn{display:flex;align-items:center;gap:12px;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:11px 13px;cursor:pointer;text-align:left;transition:background .12s}
.pdf-opt-btn:active{background:rgba(0,230,118,.08);border-color:rgba(0,230,118,.3)}
.pdf-opt-icon{font-size:1.4rem;flex-shrink:0}
.pdf-opt-title{font-family:var(--sans);font-size:.85rem;font-weight:600;color:#dde4ee;margin-bottom:2px}
.pdf-opt-sub{font-family:var(--sans);font-size:.7rem;color:#5a6878}


/* ═══════════════════════════════════════════════════════════════
   TIMELINE — lista cronologica voci del giorno
   .tl      = contenitore principale (padding bottom 110px per FAB space)
   .tli     = singola voce timeline (flex: barra sinistra + card destra)
   .tls     = barra verticale sinistra (orario + pallino colorato + linea)
   .tl-t    = orario HH:MM (monospace piccolo, grigio)
   .tl-d    = pallino colorato per tipo (verde=pasto, arancio=spuntino, ecc.)
   .tl-v    = linea verticale tra pallini (nascosta nell'ultimo elemento)
   .tlc     = card contenuto (bordo sottile, raggio 13px, cliccabile)
   .tlr1    = prima riga card: tag a sinistra + bottoni modifica/elimina a destra
   .tag     = chip tipo uppercase: .tc=colazione .tp=pranzo .tce=cena
              .ts2=spuntino .tg=glicemia .ti=insulina .ta=alcool .tsp=sport
   .teb     = bottone matita modifica (trasparente, diventa bianco al hover)
   .teb-del = bottone cestino rosso (semi-trasparente, diventa pieno al hover)
   .tv      = chip valore (monospace, sfondo card2)
              .tv.big=grande, .tv.pre/.post=glicemia, .tv.ins=insulina
              Varianti colore: .ok=verde, .warn=arancio, .bad=rosso/azzurro
   .nchips/.nchip = chip macro nutrienti (C/P/G/F, turchese)
   ═══════════════════════════════════════════════════════════════ */
.tl{padding:12px 14px 110px}
.tl-empty{text-align:center;padding:28px 16px;color:var(--txt2);font-size:.88rem}
.tl-empty .ei{font-size:1.9rem;margin-bottom:8px;opacity:.4}
.tli{display:flex;gap:9px;margin-bottom:11px}
.tls{display:flex;flex-direction:column;align-items:center;width:30px;flex-shrink:0;padding-top:3px}
.tl-t{font-family:var(--mono);font-size:.68rem;color:var(--txt3);line-height:1;text-align:center}
.tl-d{width:8px;height:8px;border-radius:50%;margin:4px 0;flex-shrink:0}
.tl-v{width:1px;flex:1;background:var(--bdr)}
.tlc{
  flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:13px;
  padding:12px 14px;position:relative;cursor:pointer;transition:border-color .12s,background .12s
}
.tlc:active{background:var(--card2);border-color:var(--bdr2)}
.tlr1{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.tag{font-size:.72rem;font-weight:700;letter-spacing:.6px;text-transform:uppercase;padding:3px 8px;border-radius:5px}
.tc{background:rgba(0,230,118,.1);color:var(--g)}
.tp{background:rgba(0,230,118,.07);color:#69f0ae}
.tce{background:rgba(0,200,83,.1);color:#b9f6ca}
.ts2{background:rgba(255,171,64,.1);color:var(--o)}
.tg{background:rgba(64,196,255,.1);color:var(--b)}
.ti{background:rgba(206,147,216,.1);color:var(--p)}
.teb{background:none;border:none;color:var(--txt2);font-size:.75rem;cursor:pointer;padding:2px 4px;line-height:1;transition:color .12s}
.teb:active{color:var(--txt)}
.tl-food{font-size:.92rem;color:var(--txt3);margin-bottom:6px;line-height:1.4}
.tvs{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.tv{font-family:var(--mono);font-size:.82rem;padding:3px 8px;border-radius:5px;background:var(--card2)}
.tv.pre{color:var(--b)}.tv.pre.ok{color:var(--g)}.tv.pre.bad{color:var(--r)}.tv.pre.warn{color:var(--o)}
.tv.post.ok{color:var(--g)}.tv.post.warn{color:var(--o)}.tv.post.bad{color:var(--r)}
.tv.ins{color:var(--p)}
.tv.big{font-size:.9rem;font-weight:500}
.tv.big.ok{color:var(--g)}.tv.big.warn{color:var(--o)}.tv.big.bad{color:var(--r)}
/* Standalone color classes for monthly calendar and other uses */
.ok{color:var(--g)}.warn{color:var(--o)}.bad{color:var(--r)}



/* ALERT BANNER — avviso glicemia alta/bassa */
.alert-banner{margin:8px 14px 0;background:rgba(255,82,82,.1);border:1px solid rgba(255,82,82,.35);border-radius:11px;padding:10px 13px;display:none;align-items:center;gap:10px}
.alert-banner.low-alert{background:rgba(255,30,30,.13);border-color:rgba(255,50,50,.6);box-shadow:0 0 0 2px rgba(255,50,50,.18),0 4px 18px rgba(255,50,50,.18);animation:pulse-red 1.6s ease-in-out infinite}
.alert-banner.on{display:flex}
.alert-icon{font-size:1.3rem;flex-shrink:0}
.alert-txt{flex:1;font-size:.76rem;line-height:1.4}
.alert-txt strong{display:block;font-size:.82rem;margin-bottom:1px}
.alert-banner .alert-val{font-family:var(--mono);font-size:1.1rem;font-weight:500;color:var(--r);flex-shrink:0}
.alert-banner.low-alert .alert-val{color:var(--b)}

/* Icona trend direzionalità glicemia */
.trend-icon{font-size:1rem;line-height:1}

/* Tabs selezione periodo grafico (Oggi / 7gg / 30gg) */
.chart-tabs{display:flex;gap:5px;margin-bottom:10px}
.ctab{flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:8px;color:var(--txt2);font-family:var(--sans);font-size:.72rem;font-weight:600;padding:7px 4px;cursor:pointer;text-align:center;transition:all .12s}
.ctab.on{background:rgba(0,230,118,.08);border-color:var(--g);color:var(--g)}
.trend-sel{display:flex;gap:5px}
.tsb{flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:9px;font-size:1.15rem;padding:9px 4px;cursor:pointer;text-align:center;transition:all .12s;line-height:1}
.tsb.on{background:var(--card2);border-color:var(--bdr2)}
.tsb.t-u2{color:#ff5252}.tsb.t-u2.on{border-color:#ff5252;background:rgba(255,82,82,.13);color:#ff5252}
.tsb.t-u1{color:#ffab40}.tsb.t-u1.on{border-color:#ffab40;background:rgba(255,171,64,.13);color:#ffab40}
.tsb.t-fl{color:#b0bec5}.tsb.t-fl.on{border-color:#b0bec5;background:rgba(176,190,197,.1);color:#e8eef6}
.tsb.t-d1{color:#40c4ff}.tsb.t-d1.on{border-color:#40c4ff;background:rgba(64,196,255,.13);color:#40c4ff}
.tsb.t-d2{color:#7986cb}.tsb.t-d2.on{border-color:#7986cb;background:rgba(121,134,203,.13);color:#7986cb}

/* ═══════════════════════════════════════════════════════════════
   SUGGESTION BANNER — card suggerimento insulina/carboidrati
   Appare dopo ogni salvataggio glicemia e mostra il consiglio
   del motore di suggerimento (calcSuggestion).
   .sc-ins  = background viola (insulina correttiva)
   .sc-carb = background arancio (carboidrati veloci ipoglicemia)
   .sc-ok   = background verde (in range - tutto bene)
   .sc-warn = background rosso (attenzione - tendenza pericolosa)
   .sug-main = valore principale grande (es. "2U" o "15g carbo")
   .sug-disc = disclaimer medico in corsivo piccolo in fondo
   ═══════════════════════════════════════════════════════════════ */
.sug-wrap{display:none;margin:8px 14px 0}.sug-wrap.on{display:block}
.sug-card{border-radius:12px;padding:12px 14px}
.sc-ins{background:rgba(206,147,216,.1);border:1px solid rgba(206,147,216,.3)}
.sc-carb{background:rgba(255,171,64,.1);border:1px solid rgba(255,171,64,.3)}
.sc-ok{background:rgba(0,230,118,.07);border:1px solid rgba(0,230,118,.2)}
.sc-warn{background:rgba(255,82,82,.07);border:1px solid rgba(255,82,82,.2)}
.sug-row{display:flex;align-items:flex-start;gap:10px;margin-bottom:5px}
.sug-ico{font-size:1.25rem;flex-shrink:0;margin-top:1px}.sug-body{flex:1}
.sug-title{font-size:.82rem;font-weight:600;margin-bottom:3px}
.sc-ins .sug-title{color:var(--p)}.sc-carb .sug-title{color:var(--o)}.sc-ok .sug-title{color:var(--g)}.sc-warn .sug-title{color:var(--r)}
.sug-main{font-family:var(--mono);font-size:1.2rem;font-weight:500;margin:4px 0}
.sc-ins .sug-main{color:var(--p)}.sc-carb .sug-main{color:var(--o)}.sc-ok .sug-main{color:var(--g)}
.sug-detail{font-size:.8rem;color:var(--txt3);line-height:1.55;white-space:pre-line}
.sug-disc{font-size:.6rem;color:var(--txt2);font-style:italic;border-top:1px solid rgba(255,255,255,.06);padding-top:5px;margin-top:6px;line-height:1.4}
.sug-close{float:right;background:none;border:none;color:var(--txt2);font-size:.8rem;cursor:pointer;padding:1px 4px}

/* ═══════════════════════════════════════════
   ALCOHOL TRACKER — barra settimanale alcool
   ═══════════════════════════════════════════ */
.alc-row{padding:10px 14px 4px}
.alc-wide{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:16px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;position:relative;overflow:hidden;transition:background .12s;width:100%;text-align:left}
.alc-wide::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--alc);border-radius:1px}
.alc-wide:active{background:var(--card2)}
.alc-left{display:flex;align-items:center;gap:8px;flex:1}
.alc-lbl{font-size:.92rem;font-weight:700;color:var(--txt)}
.alc-sub{font-size:.78rem;color:var(--txt2)}
.alc-bar-wrap{flex:0 0 110px;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.alc-bar-nums{font-family:var(--mono);font-size:.82rem;font-weight:700;color:var(--alc)}
.alc-bar-track{width:100%;height:7px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden}
.alc-bar-fill{height:100%;background:var(--alc);border-radius:3px;transition:width .4s}
.alc-bar-fill.over{background:var(--r)}
.tv.alc{color:var(--alc)}.tag.ta{background:rgba(255,138,101,.1);color:var(--alc)}
.sb.al.on{border-color:var(--alc);color:var(--alc);background:rgba(255,138,101,.07)}

/* ═══════════════════════════════════════════
   NUTRITION SECTION — macro giornalieri + barre
   ═══════════════════════════════════════════ */
.nut-sec{padding:12px 14px 0}
.nut-tog{width:100%;background:var(--card);border:1px solid var(--bdr);border-radius:11px;color:var(--txt);font-family:var(--sans);font-weight:600;font-size:.92rem;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background .12s}
.nut-tog:active{background:var(--card2)}
.nut-tog .arr{font-size:.7rem;transition:transform .2s}
.nut-tog.open .arr{transform:rotate(180deg)}
.nut-body{display:none;padding:8px 0 0}.nut-body.show{display:block}
.nut-kcal{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:11px 12px;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.nut-kcal-l{font-size:.78rem;color:var(--txt2);font-weight:500}
.nut-kcal-v{font-family:var(--mono);font-size:1.2rem;font-weight:500}
.nut-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.nb{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:11px 12px}
.nb-top{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px}
.nb-name{font-size:.7rem;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px}
.nb-val{font-family:var(--mono);font-size:.84rem}
.nb-track{height:5px;background:rgba(255,255,255,.07);border-radius:3px;overflow:hidden}
.nb-fill{height:100%;border-radius:3px;transition:width .4s}
.nb-fill.ok{background:var(--g)}.nb-fill.warn{background:var(--o)}.nb-fill.over{background:var(--r)}
.nut-tip{background:rgba(128,203,196,.07);border:1px solid rgba(128,203,196,.2);border-radius:9px;padding:9px 11px;font-size:.79rem;color:var(--txt3);line-height:1.55}
.nut-tip strong{color:var(--nut)}
.nchips{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.nchip{font-size:.62rem;padding:1px 6px;border-radius:4px;background:rgba(128,203,196,.1);color:var(--nut);font-family:var(--mono)}
.chip.alc b{color:var(--alc)}

/* MACRO BOX — riquadro macronutrienti nei pannelli inserimento */
.mbox{background:var(--card);border:1px dashed rgba(128,203,196,.3);border-radius:10px;padding:10px 12px;margin-bottom:11px}
.mbox-t{font-size:.62rem;font-weight:600;color:var(--nut);text-transform:uppercase;letter-spacing:.6px;margin-bottom:9px;display:flex;align-items:center;justify-content:space-between}
.mbox-load{font-size:.62rem;color:var(--txt2);cursor:pointer;text-decoration:underline;font-style:italic;font-weight:400;text-transform:none;letter-spacing:0}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}

/* PROFILO — separatori di sezione nel pannello profilo */
.pdiv{font-size:.65rem;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.8px;margin:14px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--bdr)}
.fi-hint{font-size:.62rem;color:var(--txt2);margin-top:4px;line-height:1.4}
.alc-info-box{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:10px 12px;margin-bottom:11px;display:none}
.alc-info-row{display:flex;justify-content:space-between;margin-bottom:3px}
.alc-info-row:last-child{margin-bottom:0}

/* ═══════════════════════════════════════════
   NUTRITION SEARCH — ricerca alimenti via API
   ═══════════════════════════════════════════ */
.nut-search-row{display:flex;gap:6px;align-items:flex-start}
.nut-search-row .fi{flex:1}
.nut-search-btn{background:var(--card);border:1px solid var(--bdr);border-radius:10px;color:var(--nut);font-size:.85rem;padding:10px 11px;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:background .12s,border-color .12s}
.nut-search-btn:active{background:var(--card2)}
.nut-search-btn.loading{color:var(--txt2);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.nut-results{background:var(--card);border:1px solid var(--bdr);border-radius:10px;margin-top:5px;overflow:hidden;display:none}
.nut-results.on{display:block}
.nut-res-hdr{font-size:.6rem;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.6px;padding:7px 12px 5px;border-bottom:1px solid var(--bdr)}
.nut-res-item{padding:9px 12px;border-bottom:1px solid var(--bdr);cursor:pointer;transition:background .1s}
.nut-res-item:last-child{border-bottom:none}
.nut-res-item:active{background:var(--card2)}
.nut-res-name{font-size:.8rem;color:var(--txt3);margin-bottom:3px;line-height:1.3}
.nut-res-macros{display:flex;gap:6px;flex-wrap:wrap}
.nut-res-m{font-family:var(--mono);font-size:.62rem;padding:1px 6px;border-radius:4px}
.nut-res-m.c{background:rgba(255,171,64,.1);color:var(--o)}
.nut-res-m.p{background:rgba(0,230,118,.1);color:var(--g)}
.nut-res-m.g{background:rgba(206,147,216,.1);color:var(--p)}
.nut-res-m.f{background:rgba(128,203,196,.1);color:var(--nut)}
.nut-res-m.k{background:rgba(255,255,255,.05);color:var(--txt2)}
.nut-res-src{font-size:.58rem;color:var(--txt2);margin-left:auto;align-self:center;flex-shrink:0}
.nut-portion-box{background:rgba(128,203,196,.07);border:1px solid rgba(128,203,196,.2);border-radius:9px;padding:9px 12px;margin-top:5px;display:none}
.nut-portion-box.on{display:block}
.nut-portion-title{font-size:.65rem;font-weight:600;color:var(--nut);margin-bottom:7px}
.nut-portion-row{display:flex;gap:8px;align-items:center}
.nut-portion-row .fi{flex:1}
.nut-portion-unit{font-size:.75rem;color:var(--txt2)}
.nut-portion-btn{background:var(--nut);color:#000;border:none;border-radius:8px;font-family:var(--sans);font-weight:600;font-size:.78rem;padding:8px 12px;cursor:pointer;white-space:nowrap}
.nut-err{font-size:.72rem;color:var(--r);padding:8px 12px}



/* TIME ROW — riga orario con input + bottone Adesso */
.time-row{display:flex;align-items:stretch;gap:8px;margin-bottom:11px}
.time-row .fl{margin-bottom:0;white-space:nowrap;flex-shrink:0}
.time-input{background:var(--card);border:1px solid var(--bdr);border-radius:10px;color:var(--txt);font-family:var(--mono);font-size:.95rem;padding:8px 12px;outline:none;border:1px solid var(--bdr);-webkit-appearance:none;width:110px}
.time-input:focus{border-color:var(--bdr2)}
.time-now-btn{background:var(--card);border:1px solid var(--bdr);border-radius:8px;color:var(--txt2);font-size:.75rem;padding:10px 12px 10px 32px;cursor:pointer;white-space:nowrap;font-family:var(--sans);align-self:stretch;display:flex;align-items:center;width:185px !important}
.time-now-btn:active{background:var(--card2)}
.chart-tooltip{position:absolute;background:var(--card2);border:1px solid var(--bdr2);border-radius:8px;padding:5px 10px;font-family:var(--mono);font-size:.78rem;color:var(--txt);pointer-events:none;display:none;z-index:100;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.chart-tooltip.on{display:block}


/* FOOD ROWS — righe multiple alimento nel pannello pasto/spuntino */
.food-rows{display:flex;flex-direction:column;gap:7px}
/* .food-row defined below */
.food-row-del{background:none;border:1px solid rgba(255,82,82,.25);border-radius:8px;color:var(--r);font-size:.85rem;width:30px;height:30px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:0;line-height:1}
.food-row-del:active{background:rgba(255,82,82,.07)}
.add-food-btn{flex:1;background:none;border:1px dashed rgba(0,230,118,.3);border-radius:8px;color:var(--g);font-family:var(--sans);font-size:.82rem;font-weight:600;padding:11px 8px;cursor:pointer;transition:background .12s}
.add-food-row{display:flex;gap:6px;margin-top:6px}
.scan-btn{background:none;border:1px solid rgba(41,182,246,.35);border-radius:8px;color:#29b6f6;font-family:var(--sans);font-size:.82rem;font-weight:600;padding:11px 14px;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:background .12s;width:117px !important}
.scan-btn:active{background:rgba(41,182,246,.07)}
.add-food-btn:active{background:rgba(0,230,118,.06)}


/* ═══════════════════════════════════════════
   SPORT — tracker attività fisica + calorie
   ═══════════════════════════════════════════ */
.ba-sp::after{background:#29b6f6}.ba-sp:active{background:#091520}
.ba-alc{--_c:#ff9800}.ba-alc::after{background:var(--alc,#ff9800)}.ba-alc:active{background:#160c00}
.ba-alc-sub{font-size:.6rem;color:var(--alc,#ff9800);font-family:var(--mono);}
/* box ipoglicemia */
.ipofix-box{padding:12px;background:rgba(255,82,82,.06);border:1px solid rgba(255,82,82,.25);border-radius:12px}
.ipofix-title{font-size:.78rem;font-weight:700;color:#ff5252;margin-bottom:8px}
.ipofix-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.ipofix-item{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:10px 6px;text-align:center;cursor:pointer;transition:background .12s}
.ipofix-item:active{background:var(--card2)}
.ipofix-ico{font-size:1.3rem;margin-bottom:2px}
.ipofix-name{font-size:.62rem;font-weight:600;color:var(--txt);line-height:1.2}
.ipofix-carbs{font-size:.68rem;font-weight:700;color:#ff5252;margin-top:2px}
.ipofix-qty{font-size:.58rem;color:var(--txt2)}
.tv.sport{color:#29b6f6}.tag.tsp{background:rgba(41,182,246,.1);color:#29b6f6}
.sport-kcal-box{background:rgba(41,182,246,.07);border:1px solid rgba(41,182,246,.2);border-radius:9px;padding:10px 12px;margin-bottom:11px;display:none}
.sport-kcal-box.on{display:block}
.sport-kcal-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.sport-kcal-val{font-family:var(--mono);font-size:1.1rem;font-weight:500;color:#29b6f6}
.sport-kcal-lbl{font-size:.7rem;color:var(--txt2)}


/* SEARCH LOADING — spinner durante ricerca API */
.search-loading{display:none;align-items:center;gap:8px;padding:10px 12px;font-size:.75rem;color:var(--nut);background:rgba(128,203,196,.07);border:1px solid rgba(128,203,196,.2);border-radius:9px;margin-top:5px}
.search-loading.on{display:flex}
.search-loading-spin{width:16px;height:16px;border:2px solid rgba(128,203,196,.3);border-top-color:var(--nut);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
.nut-search-btn{transition:opacity .15s;flex-shrink:0;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:.85rem;padding:0}
.nut-search-btn.loading{opacity:.5;pointer-events:none}


/* ═══════════════════════════════════════════
   BARCODE SCANNER — overlay camera a schermo intero
   ═══════════════════════════════════════════ */
.scan-ov{display:none;position:fixed;inset:0;z-index:500;background:#000;flex-direction:column}
.scan-ov.on{display:flex}
.scan-hdr{display:flex;align-items:center;gap:12px;padding:calc(16px + env(safe-area-inset-top)) 18px 14px;background:rgba(0,0,0,.7)}
.scan-close{background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;padding:4px}
.scan-title{color:#fff;font-family:var(--sans);font-weight:600;font-size:1rem;flex:1}
.scan-wrap{position:relative;flex:1;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
.scan-video{width:100%;height:100%;object-fit:cover}
.scan-frame{position:absolute;width:72%;max-width:280px;aspect-ratio:1.5;border:2px solid rgba(0,230,118,.8);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.55)}
.scan-frame::before,.scan-frame::after{content:'';position:absolute;width:24px;height:24px;border-color:var(--g);border-style:solid}
.scan-frame::before{top:-2px;left:-2px;border-width:3px 0 0 3px;border-radius:10px 0 0 0}
.scan-frame::after{bottom:-2px;right:-2px;border-width:0 3px 3px 0;border-radius:0 0 10px 0}
.scan-line{position:absolute;width:80%;height:2px;background:linear-gradient(to right,transparent,var(--g),transparent);animation:scanline 2s ease-in-out infinite}
@keyframes scanline{0%{top:20%}50%{top:80%}100%{top:20%}}
.scan-hint{position:absolute;bottom:0;left:0;right:0;padding:18px;text-align:center;font-size:.78rem;color:rgba(255,255,255,.7);background:linear-gradient(to top,rgba(0,0,0,.8),transparent)}
.scan-btn-manual{background:var(--g);color:#000;border:none;border-radius:8px;padding:8px 18px;font-family:var(--sans);font-weight:600;font-size:.8rem;cursor:pointer;margin-top:8px}
.scan-result-box{display:none;position:absolute;bottom:0;left:0;right:0;background:var(--card2);border-top:1px solid var(--bdr2);padding:14px 18px}
.scan-result-box.on{display:block}
.panel-day-banner{display:none;background:rgba(255,171,64,.12);border:1.5px solid rgba(255,171,64,.4);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:.85rem;color:var(--o);line-height:1.4}
.panel-day-banner.on{display:flex;align-items:center;gap:8px}
.ptr{position:fixed;top:0;left:0;right:0;z-index:999;display:flex;align-items:center;justify-content:center;height:0;overflow:hidden;background:var(--bg);transition:height .2s;border-bottom:1px solid var(--bdr)}
.ptr.ready{background:rgba(0,230,118,.06);border-color:rgba(0,230,118,.3)}
.ptr-ico{font-size:1.2rem;transition:transform .3s}
.ptr.ready .ptr-ico{transform:rotate(180deg)}

/* ═══════════════════════════════════════════
   OVERLAY + BOTTOM SHEET PANELS
   .ov    = overlay scuro sfondo (blur 3px), z-index:200
   .panel = drawer bottom, sale da y=105% → 0 con cubic-bezier
   .ph    = maniglia pill grigia in cima
   .pt    = titolo panel (Bebas Neue display font)
   .eh    = sottotitolo edit mode (visibile solo in modifica)
   max-height:88vh + overflow-y:auto → scrollabile se lungo
   safe-area-inset-bottom → supporto notch iPhone
   ═══════════════════════════════════════════ */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;backdrop-filter:blur(3px)}
.ov.on{display:block}
.panel{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:var(--bg2);border:1px solid var(--bdr2);border-bottom:none;
  border-radius:22px 22px 0 0;
  padding:0 18px;
  padding-bottom:calc(28px + env(safe-area-inset-bottom));
  transform:translateY(105%);
  transition:transform .3s cubic-bezier(.32,.72,0,1);
  max-height:88vh;overflow-y:auto
}
.panel.on{transform:translateY(0)}
.ph{width:32px;height:3px;background:var(--bdr2);border-radius:2px;margin:13px auto 15px}
.pt{font-family:var(--disp);font-size:1.35rem;letter-spacing:.5px;margin-bottom:14px}
.eh{font-size:.65rem;color:var(--txt2);margin-bottom:11px;font-style:italic}


/* ═══════════════════════════════════════════════════════════════
   FORM ELEMENTS — label, input, segmenti, bottoni salvataggio
   .fr  = form row (margin-bottom:11px)
   .fl  = form label (uppercase, letterspacing, piccolo)
   .fi  = form input (fondo var(--card), bordo sottile, focus glow)
   .fi.big = input numerico grande (3xl monofonted per glicemia)
   .g2  = grid 2 colonne per input affiancati (es. bolo PRE/POST)
   .seg = contenitore segmenti button-group
   .sb  = singolo segmento, .sb.on = selezionato
   .sb varianti colore: .g=verde, .b=azzurro, .o=arancio, .p=viola
   .ac/.aci = dropdown autocomplete a scomparsa
   .bsave = bottone verde principale "Salva"
   .bdel  = bottone rosso secondario "Elimina" (solo in edit mode)
   ═══════════════════════════════════════════════════════════════ */
.fr{margin-bottom:11px}
.fl{display:block;font-size:.7rem;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.7px;margin-bottom:5px}
.fi{
  width:100%;background:var(--card);border:1px solid var(--bdr);border-radius:10px;
  color:var(--txt);font-family:var(--sans);font-size:.93rem;padding:10px 12px;
  outline:none;transition:border-color .15s;-webkit-appearance:none
}
.fi:focus{border-color:var(--bdr2)}
.fi.big{font-family:var(--mono);font-size:2rem;font-weight:500;text-align:center;letter-spacing:3px;padding:13px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.seg{display:flex;gap:5px}
.sb{
  flex:1;background:var(--card);border:1px solid var(--bdr);border-radius:9px;
  color:var(--txt2);font-family:var(--sans);font-weight:500;font-size:.8rem;
  padding:8px 4px;cursor:pointer;text-align:center;transition:all .12s
}
.sb.on{background:var(--card2);border-color:var(--bdr2);color:var(--txt)}
.sb.g.on{border-color:var(--g);color:var(--g);background:rgba(0,230,118,.07)}
.sb.b.on{border-color:var(--b);color:var(--b);background:rgba(64,196,255,.07)}
.sb.o.on{border-color:var(--o);color:var(--o);background:rgba(255,171,64,.07)}
.sb.p.on{border-color:var(--p);color:var(--p);background:rgba(206,147,216,.07)}
.ac{background:var(--card);border:1px solid var(--bdr);border-radius:9px;margin-top:4px;overflow:hidden;display:none}
.ac.on{display:block}
.aci{padding:9px 12px;font-size:.82rem;cursor:pointer;border-bottom:1px solid var(--bdr);transition:background .1s;color:var(--txt3)}
.aci:last-child{border-bottom:none}
.aci:active{background:var(--card2)}
.aci-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.aci-nota{display:block;font-size:.61rem;color:var(--txt3);margin-top:2px;padding-left:1px}
.aci-name{font-size:.84rem;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-transform:capitalize}
.aci-mac{font-size:.67rem;flex-shrink:0;display:flex;gap:5px;align-items:center}
.aci-c{color:#29b6f6;font-weight:700;font-size:.73rem;white-space:nowrap}
.aci-unit{color:var(--txt3);font-size:.6rem;white-space:nowrap;margin-right:2px}
.aci-p{color:var(--g);font-size:.67rem;white-space:nowrap}
.aci-k{color:var(--txt2);font-size:.64rem;white-space:nowrap}
.aci-src{font-size:.57rem;color:var(--nut);border:1px solid rgba(128,203,196,.4);border-radius:3px;padding:1px 4px}
.aci-footer{padding:8px 12px;font-size:.73rem;color:var(--nut);cursor:pointer;border-top:1px solid var(--bdr);text-align:center;background:rgba(128,203,196,.05)}
.aci-footer:active{background:rgba(128,203,196,.14)}
.aci-spin{padding:8px 12px;font-size:.73rem;color:var(--txt2);text-align:center}
.bsave{
  width:100%;background:var(--g);color:#000;border:none;border-radius:10px;
  font-family:var(--sans);font-weight:600;font-size:.93rem;padding:13px;cursor:pointer;
  margin-top:4px;transition:opacity .12s,transform .1s
}
.bsave:active{transform:scale(.97);opacity:.85}
.bdel{
  width:100%;background:none;border:1px solid rgba(255,82,82,.3);border-radius:10px;
  color:var(--r);font-family:var(--sans);font-weight:500;font-size:.82rem;
  padding:10px;cursor:pointer;margin-top:6px;transition:background .12s
}
.bdel:active{background:rgba(255,82,82,.07)}


/* ═══════════════════════════════════════
   FOOD CONFIRM MODAL — popup conferma alimento
   ═══════════════════════════════════════ */
.fcm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:9995;display:none;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom)}
.fcm-overlay.on{display:flex}
.fcm-card{background:var(--card);border:1px solid var(--bdr2);border-radius:18px 18px 0 0;padding:20px 18px 18px;width:100%;max-width:480px;animation:slideUp .22s ease}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.fcm-name{font-family:var(--disp);font-size:1.3rem;letter-spacing:.04em;margin-bottom:4px;text-transform:capitalize}
.fcm-portion{font-size:.72rem;color:var(--txt2);margin-bottom:14px}
.fcm-macros{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.fcm-m{background:var(--bg2);border-radius:10px;padding:9px 6px;text-align:center}
.fcm-m-val{font-family:var(--mono);font-size:1.1rem;font-weight:500}
.fcm-m-lbl{font-size:.58rem;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.fcm-m.c .fcm-m-val{color:var(--b)}
.fcm-m.p .fcm-m-val{color:var(--g)}
.fcm-m.g .fcm-m-val{color:var(--o)}
.fcm-m.k .fcm-m-val{color:var(--txt3)}
.fcm-btns{display:flex;gap:9px}
.fcm-yes{flex:2;background:var(--g);color:#000;border:none;border-radius:10px;font-family:var(--sans);font-weight:700;font-size:.9rem;padding:13px;cursor:pointer}
.fcm-no{flex:1;background:none;border:1px solid var(--bdr2);border-radius:10px;color:var(--txt2);font-family:var(--sans);font-size:.85rem;padding:13px;cursor:pointer}

/* ═══════════════════════════════════════
   ONBOARDING — primo avvio, profilo obbligatorio
   ═══════════════════════════════════════ */
.onb-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:9999;display:none;flex-direction:column;overflow-y:auto}
.onb-overlay.on{display:flex}
.onb-inner{padding:24px 18px 32px;max-width:480px;margin:0 auto;width:100%}
.onb-logo{font-family:var(--disp);font-size:2.2rem;letter-spacing:2px;color:var(--txt);margin-bottom:4px}
.onb-logo em{color:var(--g);font-style:normal}
.onb-sub{font-size:.8rem;color:var(--txt2);margin-bottom:22px;line-height:1.5}
.onb-step{font-size:.68rem;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.onb-title{font-size:1.1rem;font-weight:600;margin-bottom:14px}
.onb-required{font-size:.65rem;color:var(--r);font-weight:600;margin-bottom:2px;display:block}
.onb-optional{font-size:.65rem;color:var(--txt2);margin-bottom:2px;display:block}
.onb-save{width:100%;background:var(--g);color:#000;border:none;border-radius:10px;font-family:var(--sans);font-weight:700;font-size:.97rem;padding:15px;cursor:pointer;margin-top:18px;opacity:.4;pointer-events:none;transition:opacity .2s}
.onb-save.ready{opacity:1;pointer-events:auto}

/* Autocomplete posizione assoluta per full-width */
.ac{position:absolute;z-index:200;left:0;right:0;background:var(--card);border:1px solid var(--bdr);border-radius:9px;margin-top:4px;overflow:hidden;display:none;min-width:100%}
.fr-name-wrap{position:relative;flex:1;min-width:0;overflow:visible}

/* TOAST — notifica temporanea in basso */
.toast{
  position:fixed;bottom:calc(18px + env(safe-area-inset-bottom));left:50%;
  transform:translateX(-50%) translateY(50px) scale(.92);
  background:var(--card2);border:1px solid var(--bdr2);color:var(--txt);
  font-size:.8rem;font-weight:500;padding:8px 17px;border-radius:18px;z-index:999;
  transition:transform .25s cubic-bezier(.32,.72,0,1),opacity .25s;
  white-space:nowrap;opacity:0;box-shadow:0 8px 24px rgba(0,0,0,.5)
}
.toast.on{transform:translateX(-50%) translateY(0) scale(1);opacity:1}

/* ═══════════════════════════════════════════
   SUMMARY BOXES — card riepilogo glicemia/sport/misurazioni
   Stile coerente con le action card in cima
   ═══════════════════════════════════════════ */
.sum-sec{padding:12px 14px 4px}
.sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.sum-box{
  background:var(--card);border:1px solid var(--bdr);border-radius:14px;
  padding:13px 13px 11px;cursor:default;
  display:flex;flex-direction:column;gap:3px;
  position:relative;overflow:hidden;
}
.sum-box::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:1px}
.sum-box.glic::after{background:var(--b)}
.sum-box.week::after{background:var(--g)}
.sum-box.sport::after{background:#29b6f6}
.sum-ico{font-size:1.4rem;line-height:1;margin-bottom:3px}
.sum-val{font-family:var(--mono);font-size:1.7rem;font-weight:500;line-height:1}
.sum-unit{font-size:.78rem;color:var(--txt2);margin-left:3px;font-family:var(--mono)}
.sum-lbl{font-size:.68rem;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;line-height:1.3;margin-top:2px}
.sum-sub{font-size:.7rem;color:var(--txt2);margin-top:4px;line-height:1.4}
.sum-wide{grid-column:1/-1}
.sum-sport-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;margin-top:6px}
.sum-sport-item{text-align:center;padding:0 4px}
.sum-sport-item+.sum-sport-item{border-left:1px solid var(--bdr)}
.sum-sport-v{font-family:var(--mono);font-size:1.25rem;font-weight:500;color:#29b6f6;display:block;line-height:1}
.sum-sport-l{font-size:.58rem;color:var(--txt2);text-transform:uppercase;letter-spacing:.4px;margin-top:4px;display:block}

/* Passi — 4° box nel riepilogo */
.sum-box.steps::after{background:var(--g)}
/* Riga zucchero aggiunto alla bevanda */
.sugar-row{display:flex;align-items:center;gap:8px;margin-top:7px;background:rgba(255,171,64,.07);border:1px solid rgba(255,171,64,.2);border-radius:9px;padding:8px 10px}
.sugar-row .fl{margin-bottom:0;white-space:nowrap;font-size:.65rem;color:var(--o)}
.sugar-row input{width:60px;text-align:center}
.sugar-lbl{font-size:.7rem;color:var(--txt2);flex-shrink:0}
/* Modal inserimento passi manuale */
.steps-edit{display:none;position:fixed;inset:0;z-index:450;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);align-items:flex-end;justify-content:center}
.steps-edit.on{display:flex}
.steps-card{background:var(--bg2);border:1px solid var(--bdr2);border-radius:20px 20px 0 0;padding:20px 20px calc(24px + env(safe-area-inset-bottom));width:100%;max-width:480px}
.steps-card .ph{margin:0 auto 16px}
/* Bevanda: bottoni unità */
.bev-units{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px}
.bev-btn{background:var(--card);border:1px solid var(--bdr);border-radius:8px;color:var(--txt2);font-size:.72rem;padding:6px 10px;cursor:pointer;transition:all .12s}
.bev-btn.on{background:rgba(128,203,196,.1);border-color:var(--nut);color:var(--nut)}

/* ═══ DELETE: SWIPE + CESTINO ════════════════════════════════ */
.tlc-wrap{position:relative;width:100%;touch-action:pan-y}
.tlc-del-bg{position:absolute;right:0;top:0;bottom:0;width:72px;
  background:rgba(255,82,82,.18);border-radius:13px;
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .15s;
  color:var(--r);font-size:1.5rem}
.tlc-wrap.swiped .tlc{border-color:rgba(255,82,82,.4)}
.tlc-wrap.swiped .tlc-del-bg{opacity:1;pointer-events:auto}
.teb-del{background:none;border:none;color:rgba(255,82,82,.5);
  font-size:.78rem;cursor:pointer;padding:2px 4px;line-height:1;transition:color .12s}
.teb-del:active{color:var(--r)}
.del-confirm{display:none;position:fixed;inset:0;z-index:700;
  background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
  align-items:center;justify-content:center;padding:24px}
.del-confirm.on{display:flex}
.del-confirm-card{background:var(--bg2);border:1px solid rgba(255,82,82,.3);
  border-radius:18px;padding:24px 20px;max-width:320px;width:100%;text-align:center}
.del-confirm-ico{font-size:2.2rem;margin-bottom:10px}
.del-confirm-msg{font-size:.88rem;color:var(--txt);margin-bottom:18px;line-height:1.5}
.del-confirm-btns{display:flex;gap:8px}
.del-btn-yes{flex:1;background:rgba(255,82,82,.15);border:1px solid rgba(255,82,82,.4);
  border-radius:10px;color:var(--r);font-family:var(--sans);font-weight:700;
  font-size:.88rem;padding:12px;cursor:pointer}
.del-btn-no{flex:1;background:var(--card);border:1px solid var(--bdr);
  border-radius:10px;color:var(--txt2);font-family:var(--sans);font-size:.88rem;
  padding:12px;cursor:pointer}

/* ═══ FOOD ROW — layout inline ══════════════════════════════ */
/* ── Nuovo food-row design ── */
.food-row{margin-bottom:7px;background:none;border:none;border-radius:0;padding:0}
.fr-top{display:flex;align-items:center;gap:6px}
.fr-name-wrap{position:relative;flex:1;min-width:0;overflow:visible}
.fr-name-inp{width:100%;font-size:.88rem!important;padding:9px 10px!important}
.fr-right{display:flex;align-items:center;gap:4px;flex-shrink:0}
.fr-qty-wrap{position:relative;display:flex;align-items:center}
.fr-qty-inp{width:85px!important;padding:9px 26px 9px 8px!important;text-align:left;font-size:.88rem!important}
.fr-unit{position:absolute;right:7px;font-size:.66rem;color:var(--txt2);pointer-events:none;font-weight:600;letter-spacing:.2px}
.fr-del-btn{background:none;border:1px solid rgba(255,82,82,.3);border-radius:7px;color:var(--r);font-size:1rem;width:28px;height:36px;cursor:pointer;line-height:1;flex-shrink:0}
.fr-del-btn:active{background:rgba(255,82,82,.08)}
.fr-macros{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px;margin-left:2px;min-height:0;}
.food-row-mac-chip{font-size:.67rem;background:rgba(128,203,196,.1);border:1px solid rgba(128,203,196,.2);border-radius:5px;padding:3px 6px;color:var(--txt2)}
.food-row-mac-chip span{color:var(--nut);font-weight:700}
food-row-mac-chip.fc{background:rgba(41,182,246,.13);border-color:rgba(41,182,246,.35)}
.food-row-mac-chip.fc span{color:#29b6f6;font-size:.75rem}
/* compat aliases */
.food-row-main-row{display:flex;align-items:center;gap:7px}
.food-row-name-inp{flex:1;min-width:0}
.food-row-grams-inline{display:flex;align-items:center;gap:4px;flex-shrink:0}
.food-row-grams{width:60px!important;flex:none!important;font-size:.88rem!important;text-align:center}
.food-row-unit{font-size:.72rem;color:var(--txt2)}
.food-row-macros{display:flex;gap:5px;flex-wrap:wrap}
/* totale macro riepilogo in fondo alle rows */
.food-rows-total{margin-top:8px;padding:6px 10px;background:rgba(128,203,196,.07);border-radius:9px;border:1px solid rgba(128,203,196,.2);display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.food-rows-total-lbl{font-size:.65rem;color:var(--txt2);text-transform:uppercase;letter-spacing:.04em;margin-right:4px}

/* ─── IPOGLICEMIA: allarme rosso pulsante ─── */
@keyframes pulse-red{0%,100%{box-shadow:0 0 0 2px rgba(255,50,50,.18),0 4px 18px rgba(255,50,50,.18)}50%{box-shadow:0 0 0 5px rgba(255,50,50,.28),0 4px 24px rgba(255,50,50,.32)}}
.low-alert .alert-icon{font-size:1.6rem}

/* ─── ACQUA: pulsante e modal ─── */
.ba-w{--_c:#29b6f6}
.ba-w::after{background:linear-gradient(90deg,var(--_c),rgba(41,182,246,.5))}
#waterQuickModal{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:flex-end;justify-content:center;padding:0 0 env(safe-area-inset-bottom,0)}
#waterQuickModal.on{display:flex}
.wq-card{background:var(--bg2);border-radius:20px 20px 0 0;padding:18px 16px 28px;width:100%;max-width:480px}
.wq-title{font-size:1rem;font-weight:700;color:var(--txt);margin-bottom:14px;text-align:center}
.wq-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.wq-btn{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:14px 6px;cursor:pointer;text-align:center;transition:background .1s,border-color .1s}
.wq-btn:active,.wq-btn.on{background:rgba(41,182,246,.15);border-color:rgba(41,182,246,.5)}
.wq-btn .wq-ico{font-size:1.5rem;display:block;margin-bottom:4px}
.wq-btn .wq-lbl{font-size:.72rem;color:var(--txt);font-weight:600;display:block}
.wq-btn .wq-ml{font-size:.65rem;color:#29b6f6;display:block}
.wq-custom{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.wq-custom input{flex:1}
.wq-bar{background:rgba(41,182,246,.1);border:1px solid rgba(41,182,246,.2);border-radius:10px;padding:8px 12px;display:flex;align-items:center;gap:10px;margin-bottom:12px}
.wq-bar-lbl{font-size:.72rem;color:var(--txt2)}
.wq-bar-val{font-family:var(--mono);font-size:1.1rem;color:#29b6f6;font-weight:700}
.wq-bar-track{flex:1;height:6px;background:var(--bdr);border-radius:3px;overflow:hidden}
.wq-bar-fill{height:100%;background:#29b6f6;border-radius:3px;transition:width .3s}
.wq-entries{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;max-height:180px;overflow-y:auto}
.wq-entry-card{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:8px 12px}
.wq-entry-time{font-size:.72rem;color:var(--txt2);min-width:38px}
.wq-entry-ml{font-size:.88rem;font-weight:700;color:#29b6f6;flex:1}
.wq-entry-del{background:none;border:1px solid rgba(255,82,82,.3);border-radius:7px;color:var(--r);font-size:.85rem;width:28px;height:28px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.wq-count-inp{width:38px;text-align:center;background:var(--bg2);border:1px solid var(--bdr);border-radius:7px;color:var(--txt);font-size:.82rem;padding:4px 4px;-moz-appearance:textfield}
.wq-count-inp::-webkit-inner-spin-button,.wq-count-inp::-webkit-outer-spin-button{-webkit-appearance:none}
.wq-empty{font-size:.72rem;color:var(--txt2);margin-bottom:10px;text-align:center;padding:12px}
.wq-close{width:100%;background:none;border:1px solid var(--bdr);border-radius:10px;padding:10px;color:var(--txt2);font-family:var(--sans);font-size:.85rem;cursor:pointer}

/* ─── GRAFICO SOVRAPPOSTO 7/14/30gg ─── */
#overlayChartModal{display:none;position:fixed;inset:0;z-index:650;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:16px}
#overlayChartModal.on{display:flex}
.oc-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:20px;padding:16px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
.oc-title{font-size:.95rem;font-weight:700;color:var(--txt);margin-bottom:12px;text-align:center}
.oc-tabs{display:flex;gap:6px;margin-bottom:12px;justify-content:center}
.oc-tab{background:var(--card);border:1px solid var(--bdr);border-radius:8px;padding:6px 14px;font-size:.75rem;color:var(--txt2);cursor:pointer;font-family:var(--sans)}
.oc-tab.on{background:rgba(128,203,196,.15);border-color:var(--p);color:var(--p)}
.oc-canvas-wrap{position:relative;width:100%;height:200px}
.oc-legend{font-size:.6rem;color:var(--txt2);margin-top:8px;text-align:center}
.oc-stats{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.oc-stat{flex:1;min-width:80px;background:var(--card);border-radius:10px;padding:8px 10px;text-align:center}
.oc-stat-v{font-size:1.1rem;font-weight:700;font-family:var(--mono);color:var(--g)}
.oc-stat-l{font-size:.62rem;color:var(--txt2);margin-top:2px}
.oc-close{margin-top:12px;width:100%;background:none;border:1px solid var(--bdr);border-radius:10px;padding:10px;color:var(--txt2);font-family:var(--sans);font-size:.85rem;cursor:pointer}

/* ─── TREND INVERSIONE ─── */
/* t-u2 = salita rapida (rosso) → già ok come semantica, ma invertiamo le frecce visive */

/* ─── GRAFICA GENERALE — more size ─── */
.ba .ico{font-size:1.5rem!important}
.ba .lbl{font-size:.68rem!important;font-weight:600}
.ba .plus{font-size:.8rem!important}
.ba{padding:15px 4px 12px!important;border-radius:16px!important}
.acts{gap:6px!important}
.tl-t{font-size:.75rem!important}
.tag{font-size:.74rem!important;padding:3px 9px!important}
.tv{font-size:.88rem!important;padding:3px 10px!important}
.tv.big{font-size:1.55rem!important}
.sum-val{font-size:1.75rem!important}
.chip{font-size:.82rem!important;padding:10px 16px!important}

</style>
</head>
<body>
<!-- ═══════════════════════════════════════════════════════════════
     STRUTTURA HTML DELL'APP
     ┌─ HEADER (sticky, logo + clock + settings)
     ├─ INSTALL BANNER PWA
     ├─ ACTION BUTTONS (griglia 3×2: Pasto/Spuntino/Glicemia/Insulina/Acqua/Sport)
     ├─ ALERT BANNERS (glicemia alta/bassa)
     ├─ SUGGESTION CARD (suggerimento insulina/carbo)
     ├─ ALCOHOL TRACKER (barra settimanale)
     ├─ STRIP (chip riepilogo giornaliero)
     ├─ BOX RIEPILOGO (glicemia oggi/settimana + sport + passi)
     ├─ SEZIONE NUTRIZIONE (macro collassabile)
     ├─ SEZIONE STATISTICHE (toggle + grafico + PDF + storico)
     ├─ RIEPILOGO MENSILE (calendario + grafico mensile, collassabile)
     ├─ DAY NAVIGATION (← data →)
     ├─ TIMELINE (lista voci del giorno)
     ├─ OVERLAY SCURO (sfondo panel)
     ├─ PANNELLI (7 bottom sheet: Pasto/Spuntino/Glicemia/Insulina/Alcool/Sport/Profilo)
     ├─ MODALI (PDF, acqua, passi, scanner, storico, correzione glicemia, elimina)
     └─ TOAST (notifica temporanea)
     ═══════════════════════════════════════════════════════════════ -->

<div class="ptr" id="ptrBar"><span class="ptr-ico">&#x21A7;</span></div>

<!-- ═══════════════════════════════════
     HEADER — logo + orologio + settings
     ═══════════════════════════════════ -->
<div class="hdr">
  <div class="logo">Glico<em>Log</em></div>
  <div class="clk">
    <div class="clk-t" id="hTime">--:--</div>
    <div class="clk-d" id="hDate">---</div>
  </div>
  <button style="background:var(--card);border:1px solid var(--bdr);border-radius:8px;color:var(--txt2);width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:.9rem;cursor:pointer;flex-shrink:0" onclick="openPanel('profilo')">&#9881;&#65039;</button>
</div>

<!-- ═══════════════════════════════════
     ALERT BANNERS — glicemia alta/bassa
     ═══════════════════════════════════ -->
<div class="alert-banner" id="alertHigh">
  <div class="alert-icon">🔴</div>
  <div class="alert-txt"><strong>Glicemia alta!</strong>Valore sopra la soglia di 200 mg/dL</div>
  <div class="alert-val" id="alertHighVal"></div>
</div>
<div class="alert-banner low-alert" id="alertLow">
  <div class="alert-icon">🚨</div>
  <div class="alert-txt"><strong style="color:#ff5252;font-size:.9rem">⚠️ Glicemia bassa!</strong>Valore sotto la soglia di 70 mg/dL</div>
  <div class="alert-val" id="alertLowVal"></div>
</div>

<!-- ═══════════════════════════════════
     SUGGESTION BANNER — consiglio insulina/carbo
     ═══════════════════════════════════ -->
<div class="sug-wrap" id="sugWrap">
  <div class="sug-card" id="sugCard">
    <button class="sug-close" onclick="document.getElementById('sugWrap').classList.remove('on')">&#x2715;</button>
    <div class="sug-row">
      <div class="sug-ico" id="sugIco"></div>
      <div class="sug-body">
        <div class="sug-title" id="sugTitle"></div>
        <div class="sug-main" id="sugMain"></div>
        <div class="sug-detail" id="sugDetail"></div>
      </div>
    </div>
    <div class="sug-disc">&#9877;&#65039; Suggerimento basato sui tuoi parametri personali &#8212; non &#232; una prescrizione medica. Verifica sempre con il tuo diabetologo.</div>
  </div>
</div>


<!-- ═══════════════════════════════════
     ACTION BUTTONS — riga1:Pasto+Spuntino | riga2:Glic+Ins+Sport | riga3:Alcool+Acqua
     ═══════════════════════════════════ -->
<!-- Riga 1: Pasto + Spuntino + Glicemia + Insulina -->
<div class="acts" style="grid-template-columns:1fr 1fr 1fr 1fr">
  <button class="ba ba-p" onclick="openPanel('pasto')">
    <span class="ico">🍽️</span><span class="plus">+</span><span class="lbl">Pasto</span>
  </button>
  <button class="ba ba-s" onclick="openPanel('spuntino')">
    <span class="ico">🍎</span><span class="plus">+</span><span class="lbl">Spuntino</span>
  </button>
  <button class="ba ba-g" onclick="openPanel('glicemia')">
    <span class="ico">💊</span><span class="plus">+</span><span class="lbl">Glicemia</span>
  </button>
  <button class="ba ba-i" onclick="openPanel('insulina')">
    <span class="ico">💉</span><span class="plus">+</span><span class="lbl">Insulina</span>
  </button>
</div>
<!-- Riga 2: Alcool + Acqua + Sport -->
<div class="acts" style="grid-template-columns:1fr 1fr 1fr">
  <button class="ba ba-alc gap-0!" onclick="openPanel('alcool')">
    <span class="ico">🍷</span><span class="plus">+</span><span class="lbl">Alcool &nbsp;<span class="ba-alc-sub" id="alcSub" /></span>
  </button>
  <button class="ba ba-w gap-0!" onclick="openWaterModal()">
    <span class="ico">💧</span><span class="plus">+</span><span class="lbl">Acqua</span>
  </button>
  <button class="ba ba-sp gap-0!" onclick="openPanel('sport')">
    <span class="ico">🏃</span><span class="plus">+</span><span class="lbl">Sport</span>
  </button>
</div>
<!-- hidden elements for compatibility -->
<span id="alcNums" style="display:none"></span>
<span id="alcFill" style="display:none"></span>


<!-- STRIP — chip riepilogo giornaliero -->
<div class="strip" id="strip" style="padding-top:12px"></div>





<!-- ═══════════════════════════════════
     STATISTICHE + GRAFICO
     ═══════════════════════════════════ -->
<div class="sw">
  <button class="st-tog open" id="stT" onclick="toggleStats()">
    <span>📊 Statistiche</span><span class="arr">▼</span>
  </button>
  <div class="st-body show" id="stB">
    <div class="sgrid" id="sgrid"></div>
    <div class="cbox">
      <div class="chart-tabs">
        <button class="ctab on" onclick="switchChart('day',this)">Oggi</button>
        <button class="ctab" onclick="switchChart('week',this)">7 giorni</button>
        <button class="ctab" onclick="switchChart('month',this)">30 giorni</button>
      </div>
      <canvas id="cv" height="110"></canvas>
      <div class="chart-tooltip" id="cvTip"></div>
      <div id="chartLegend" style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;font-size:.58rem"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="exp-b" style="flex:1;background:rgba(206,147,216,.1);border-color:rgba(206,147,216,.3);color:var(--p)" onclick="openPdfModal()">📄 Esporta PDF</button>
      <button class="exp-b" style="flex:1;background:rgba(128,203,196,.1);border-color:rgba(128,203,196,.3);color:var(--nut)" onclick="openOverlayChart()">📈 Storico</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     RIEPILOGO MENSILE (collassabile):
     - Header: ‹ Gennaio 2026 › (navigazione mesi via chMonth)
     - #monthlyStats: 4 stat box (media/giorni/episodi bassi/alti)
     - #monthlyDayLabels: intestazioni L M M G V S D
     - #monthlyGrid: griglia 7 colonne con celle giorno cliccabili
     - #monthlyChart: canvas grafico curva media giornaliera
     ═══════════════════════════════════════════════════════════ -->
<!-- RIEPILOGO MENSILE -->
<div class="sw" id="monthlySumWrap">
  <button class="st-tog" id="monthlyT" onclick="toggleMonthly()">
    <span>📅 Riepilogo mensile</span><span class="arr">▼</span>
  </button>
  <div class="st-body" id="monthlyB" style="padding:0">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px 6px">
      <button onclick="chMonth(-1)" style="background:none;border:none;color:var(--txt2);font-size:1.2rem;cursor:pointer;padding:4px 10px">‹</button>
      <span id="monthlyTitle" style="font-family:var(--sans);font-size:1rem;color:var(--txt);font-weight:700"></span>
      <button onclick="chMonth(1)" style="background:none;border:none;color:var(--txt2);font-size:1.2rem;cursor:pointer;padding:4px 10px">›</button>
    </div>
    <!-- stat boxes -->
    <div id="monthlyStats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:0 12px 10px"></div>
    <!-- calendario griglia -->
    <div style="padding:0 12px 4px">
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px" id="monthlyDayLabels"></div>
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px" id="monthlyGrid"></div>
    </div>
    <!-- grafico mensile -->
    <div style="padding:8px 12px 12px">
      <canvas id="monthlyChart" height="160" style="width:100%;border-radius:8px;background:var(--card)"></canvas>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════
     SEZIONE NUTRIZIONE
     ═══════════════════════════════════ -->
<div class="nut-sec">
  <button class="nut-tog" id="nutT" onclick="toggleNut()"><span id="nutTLabel">&#x1F957; Nutrizione di oggi</span><span class="arr">&#x25BC;</span></button>
  <div class="nut-body" id="nutB"></div>
</div>


<!-- ═══════════════════════════════════════════════════════════
     NAVIGAZIONE GIORNI: frecce ‹ e › che chiamano chDay(-1/+1)
     Il label centrale mostra la data in formato "Gio 26 Feb 2026"
     con il badge verde "OGGI" se cd===0.
     La freccia › viene nascosta quando cd===0 (non si va al futuro).
     ═══════════════════════════════════════════════════════════ -->
<!-- NAVIGAZIONE GIORNI — frecce ‹ › + label data -->
<div class="daynav">
  <button class="dn-btn" onclick="chDay(-1)">‹</button>
  <div class="dn-lbl" id="dlbl">---</div>
  <button class="dn-btn" onclick="chDay(1)">›</button>
</div>


<!-- ═══════════════════════════════════
     SUMMARY — riepilogo glicemia, sport, misurazioni
     ═══════════════════════════════════ -->
<div class="sum-sec" id="sumSec"></div>

<!-- ═══════════════════════════════════
     TIMELINE — lista voci del giorno selezionato
     ═══════════════════════════════════ -->
<div class="tl" id="tl"></div>

<!-- OVERLAY scuro dietro ai panel -->
<div class="ov" id="ov" onclick="closePanel()"></div>

<!-- ═══════════════════════════════════
     PANEL PASTO — form inserimento pasto
     ═══════════════════════════════════ -->
<div class="panel" id="pnlPasto">
  <div class="ph"></div>
  <div class="panel-day-banner" id="dayBannerPasto"><span class="dbspan"></span></div>
  <div class="pt" id="ttPasto">🍽️ Nuovo Pasto</div>
  <div class="eh" id="ehPasto" style="display:none">Modifica voce</div>
  <div class="fr"><span class="fl">Tipo pasto</span>
    <div class="seg">
      <button class="sb g" data-v="Colazione" onclick="pSeg(this,'tP')">Colazione</button>
      <button class="sb g" data-v="Pranzo"    onclick="pSeg(this,'tP')">Pranzo</button>
      <button class="sb g" data-v="Cena"      onclick="pSeg(this,'tP')">Cena</button>
    </div>
  </div>
  <div class="fr"><span class="fl">Cosa hai mangiato?</span>
    <div class="food-rows" id="foodRowsP"></div>
    <div class="add-food-row"><button class="add-food-btn" onclick="addFoodRow('P')">+ Aggiungi alimento</button><button class="scan-btn" onclick="openScanner('P')">&#x1F4F7; &nbsp; Scan.</button></div>
    <div class="search-loading" id="loadingP"><div class="search-loading-spin"></div>Ricerca in corso…</div>
    <div class="nut-results" id="nutResP"></div>
    <div class="nut-portion-box" id="nutPortP">
      <div class="nut-portion-title" id="nutPortTitleP">⚖️ Quanti grammi? <span id="nutPortNameP" style="color:var(--nut)"></span></div>
      <!-- Bevande: scelta unità rapida -->
      <div class="bev-units" id="bevUnitsP" style="display:none">
        <button class="bev-btn" onclick="setBevUnit('P',30,'Tazzina espresso (30ml)')">Tazzina</button>
        <button class="bev-btn" onclick="setBevUnit('P',150,'Tazza/cappuccino (150ml)')">Tazza</button>
        <button class="bev-btn" onclick="setBevUnit('P',200,'Bicchiere (200ml)')">Bicchiere</button>
        <button class="bev-btn" onclick="setBevUnit('P',300,'Bicchiere grande (300ml)')">Bic. grande</button>
        <button class="bev-btn" onclick="setBevUnit('P',330,'Lattina (330ml)')">Lattina</button>
        <button class="bev-btn" onclick="setBevUnit('P',500,'Bottiglia (500ml)')">Bottiglia</button>
      </div>
      <div class="nut-portion-row">
        <input class="fi" id="nutGramsP" type="number" inputmode="decimal" placeholder="es. 80">
        <span class="nut-portion-unit" id="nutUnitP">g</span>
        <button class="nut-portion-btn" onclick="applyPortion('P')">Applica</button>
      </div>
      <!-- Zucchero aggiunto per bevande -->
      <div class="sugar-row" id="sugarRowP" style="display:none">
        <span class="fl">🍬 Zucchero aggiunto</span>
        <input class="fi" id="sugarTeaspP" type="number" inputmode="decimal" placeholder="0" style="width:60px;text-align:center" oninput="calcSugarCarbs('P')">
        <span class="sugar-lbl">cucchiaini = <b id="sugarCarbsP">0</b>g carbo</span>
      </div>
    </div>
  </div>
  <div class="fr"><span class="fl">&#x1F48A; Glicemia (mg/dL)</span>
    <input class="fi" id="iPP" type="number" inputmode="numeric" placeholder="mg/dL" oninput="onMealGlicInput(this.value,'P')">
    <div id="mealGlicWarnP" style="display:none;margin-top:5px;font-size:.72rem;padding:7px 10px;border-radius:8px"></div>
  </div>
  <div class="fr"><span class="fl">Direzionalità ↗↘</span>
    <div class="trend-sel">
      <button class="tsb t-d2" data-v="&#x2193;&#x2193;" onclick="pSeg(this,'tTrPRE')">⬇</button>
      <button class="tsb t-d1" data-v="&#x2193;"  onclick="pSeg(this,'tTrPRE')">↘</button>
      <button class="tsb t-fl" data-v="&#x2192;"  onclick="pSeg(this,'tTrPRE')">→</button>
      <button class="tsb t-u1" data-v="&#x2191;"  onclick="pSeg(this,'tTrPRE')">↗</button>
      <button class="tsb t-u2" data-v="&#x2191;&#x2191;" onclick="pSeg(this,'tTrPRE')">⬆</button>
    </div>
  </div>
  <div class="fr"><span class="fl">💉 Bolo (U)</span><input class="fi" id="iBP" type="number" inputmode="numeric" placeholder="auto da carbo" title="Calcolato automaticamente dai carboidrati" oninput="this.dataset.manualOverride=(this.value!=='')?'1':''"></div>
  <input type="hidden" id="iBS">
  <div class="mbox">
    <div class="mbox-t"><span>&#x1F957; Macronutrienti</span><span class="mbox-load" onclick="prefillMacros('iF','P')" title="Compila automaticamente i macro dal database locale in base al nome del primo alimento inserito">&#x2728; Suggerisci macro</span></div>
    <div class="g4">
      <div class="fr"><span class="fl">Carbo g</span><input class="fi" id="mPC" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="fr"><span class="fl">Prot g</span><input class="fi" id="mPP" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="fr"><span class="fl">Grassi g</span><input class="fi" id="mPG" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="fr"><span class="fl">Fibre g</span><input class="fi" id="mPF" type="number" inputmode="decimal" placeholder="0"></div>
    </div>
  </div>
  <div class="time-row"><span class="fl">&#x1F551; Orario</span><input type="time" class="fi time-input" id="tP_t"><button class="time-now-btn" onclick="setNow('tP_t')">Adesso</button></div>
  <input type="hidden" id="eiP">
  <button class="bsave" onclick="savePasto()">Salva</button>
  <button class="bdel" id="dP" style="display:none" onclick="delE('eiP')">Elimina</button>
</div>

<!-- ═══════════════════════════════════
     PANEL SPUNTINO — form inserimento spuntino
     ═══════════════════════════════════ -->
<div class="panel" id="pnlSpuntino">
  <div class="ph"></div>
  <div class="panel-day-banner" id="dayBannerSpuntino"><span class="dbspan"></span></div>
  <div class="pt" id="ttSpuntino">🍎 Spuntino</div>
  <div class="eh" id="ehSpuntino" style="display:none">Modifica voce</div>
  <div class="fr"><span class="fl">Cosa hai mangiato?</span>
    <div class="food-rows" id="foodRowsS"></div>
    <div class="add-food-row"><button class="add-food-btn" onclick="addFoodRow('S')">+ Aggiungi alimento</button><button class="scan-btn" onclick="openScanner('S')">&#x1F4F7; &nbsp; Scan.</button></div>
    <div class="search-loading" id="loadingS"><div class="search-loading-spin"></div>Ricerca in corso…</div>
    <div class="nut-results" id="nutResS"></div>
    <div class="nut-portion-box" id="nutPortS">
      <div class="nut-portion-title" id="nutPortTitleS">⚖️ Quanti grammi? <span id="nutPortNameS" style="color:var(--nut)"></span></div>
      <div class="bev-units" id="bevUnitsS" style="display:none">
        <button class="bev-btn" onclick="setBevUnit('S',30,'Tazzina espresso (30ml)')">Tazzina</button>
        <button class="bev-btn" onclick="setBevUnit('S',150,'Tazza/cappuccino (150ml)')">Tazza</button>
        <button class="bev-btn" onclick="setBevUnit('S',200,'Bicchiere (200ml)')">Bicchiere</button>
        <button class="bev-btn" onclick="setBevUnit('S',300,'Bicchiere grande (300ml)')">Bic. grande</button>
        <button class="bev-btn" onclick="setBevUnit('S',330,'Lattina (330ml)')">Lattina</button>
        <button class="bev-btn" onclick="setBevUnit('S',500,'Bottiglia (500ml)')">Bottiglia</button>
      </div>
      <div class="nut-portion-row">
        <input class="fi" id="nutGramsS" type="number" inputmode="decimal" placeholder="es. 150">
        <span class="nut-portion-unit" id="nutUnitS">g</span>
        <button class="nut-portion-btn" onclick="applyPortion('S')">Applica</button>
      </div>
      <div class="sugar-row" id="sugarRowS" style="display:none">
        <span class="fl">🍬 Zucchero aggiunto</span>
        <input class="fi" id="sugarTeaspS" type="number" inputmode="decimal" placeholder="0" style="width:60px;text-align:center" oninput="calcSugarCarbs('S')">
        <span class="sugar-lbl">cucchiaini = <b id="sugarCarbsS">0</b>g carbo</span>
      </div>
    </div>
  </div>
  <!-- Box ipoglicemia (visibile solo quando la glicemia è bassa) -->
  <div id="ipoFixBox" style="display:none;margin:0 0 10px">
    <div class="ipofix-box">
      <div class="ipofix-title">🚨 Ipoglicemia — scegli cosa prendere:</div>
      <div class="ipofix-grid" id="ipoFixGrid"></div>
      <div style="font-size:.6rem;color:var(--txt2);margin-top:7px;line-height:1.4" id="ipoFixNote"></div>
    </div>
  </div>
  <div class="fr" id="spuntinoGlicRow"><span class="fl">&#x1F48A; Glicemia (mg/dL)</span>
    <input class="fi" id="iSP" type="number" inputmode="numeric" placeholder="mg/dL" oninput="onMealGlicInput(this.value,'S')">
    <div id="mealGlicWarnS" style="display:none;margin-top:5px;font-size:.72rem;padding:7px 10px;border-radius:8px"></div>
  </div>
  <div class="fr" id="spuntinoTrendRow"><span class="fl">Direzionalità ↗↘</span>
    <div class="trend-sel">
      <button class="tsb t-d2" data-v="&#x2193;&#x2193;" onclick="pSeg(this,'tTrSPRE')">⬇</button>
      <button class="tsb t-d1" data-v="&#x2193;"  onclick="pSeg(this,'tTrSPRE')">↘</button>
      <button class="tsb t-fl" data-v="&#x2192;"  onclick="pSeg(this,'tTrSPRE')">→</button>
      <button class="tsb t-u1" data-v="&#x2191;"  onclick="pSeg(this,'tTrSPRE')">↗</button>
      <button class="tsb t-u2" data-v="&#x2191;&#x2191;" onclick="pSeg(this,'tTrSPRE')">⬆</button>
    </div>
  </div>
  <div class="fr" id="spuntinoBoloRow"><span class="fl">💉 Bolo (U)</span><input class="fi" id="iSBP" type="number" inputmode="numeric" placeholder="auto da carbo" title="Calcolato automaticamente dai carboidrati" oninput="this.dataset.manualOverride=(this.value!=='')?'1':''"></div>
  <input type="hidden" id="iSBS">
  <div class="mbox">
    <div class="mbox-t"><span>&#x1F957; Macronutrienti</span><span class="mbox-load" onclick="prefillMacros('iFS','S')" title="Compila automaticamente i macro dal database locale in base al nome del primo alimento inserito">&#x2728; Suggerisci macro</span></div>
    <div class="g4">
      <div class="fr"><span class="fl">Carbo g</span><input class="fi" id="mSC" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="fr"><span class="fl">Prot g</span><input class="fi" id="mSP" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="fr"><span class="fl">Grassi g</span><input class="fi" id="mSG" type="number" inputmode="decimal" placeholder="0"></div>
      <div class="fr"><span class="fl">Fibre g</span><input class="fi" id="mSF" type="number" inputmode="decimal" placeholder="0"></div>
    </div>
  </div>
  <div class="time-row"><span class="fl">&#x1F551; Orario</span><input type="time" class="fi time-input" id="tS_t"><button class="time-now-btn" onclick="setNow('tS_t')">Adesso</button></div>
  <input type="hidden" id="eiS">
  <button class="bsave" onclick="saveSpunt()">Salva</button>
  <button class="bdel" id="dS" style="display:none" onclick="delE('eiS')">Elimina</button>
</div>

<!-- ═══════════════════════════════════
     PANEL GLICEMIA — inserimento valore mg/dL
     ═══════════════════════════════════ -->
<div class="panel" id="pnlGlicemia">
  <div class="ph"></div>
  <div class="panel-day-banner" id="dayBannerGlicemia"><span class="dbspan"></span></div>
  <div class="pt" id="ttGlicemia">💉 Glicemia</div>
  <div class="eh" id="ehGlicemia" style="display:none">Modifica voce</div>
  <div class="fr"><input class="fi big" id="iG" type="number" inputmode="numeric" placeholder="000"></div>

  <div class="fr"><span class="fl">Direzionalità ↗↘</span>
    <div class="trend-sel">
      <button class="tsb t-d2" data-v="↓↓" onclick="pSeg(this,'tTrend')" title="Discesa rapida">⬇</button>
      <button class="tsb t-d1" data-v="↓"  onclick="pSeg(this,'tTrend')" title="In discesa">↘</button>
      <button class="tsb t-fl" data-v="→"  onclick="pSeg(this,'tTrend')" title="Stabile">→</button>
      <button class="tsb t-u1" data-v="↑"  onclick="pSeg(this,'tTrend')" title="In salita">↗</button>
      <button class="tsb t-u2" data-v="↑↑" onclick="pSeg(this,'tTrend')" title="Salita rapida">⬆</button>
    </div>
  </div>
  <div class="time-row"><span class="fl">&#x1F551; Orario</span><input type="time" class="fi time-input" id="tG"><button class="time-now-btn" onclick="setNow('tG')">Adesso</button></div>
  <input type="hidden" id="eiG">
  <button class="bsave" onclick="saveGlic()">Salva</button>
  <button class="bdel" id="dG" style="display:none" onclick="delE('eiG')">Elimina</button>
</div>

<!-- ═══════════════════════════════════
     PANEL INSULINA — unità + tipo farmaco
     ═══════════════════════════════════ -->
<div class="panel" id="pnlInsulina">
  <div class="ph"></div>
  <div class="panel-day-banner" id="dayBannerInsulina"><span class="dbspan"></span></div>
  <div class="pt" id="ttInsulina">💊 Insulina</div>
  <div class="eh" id="ehInsulina" style="display:none">Modifica voce</div>
  <div class="fr"><span class="fl">Tipo somministrazione</span>
    <div class="seg">
      <button class="sb p" data-v="Bolo"   onclick="pSeg(this,'tI');prefillInsType('Bolo')">Bolo</button>
      <button class="sb p" data-v="Basale" onclick="pSeg(this,'tI');prefillInsType('Basale')">Basale</button>
    </div>
  </div>
  <div class="fr"><span class="fl">Unità</span><input class="fi big" id="iU" type="number" inputmode="numeric" placeholder="0"></div>
  <div class="fr"><span class="fl">Farmaco</span>
    <select class="fi" id="iIT" style="cursor:pointer;-webkit-appearance:auto">
      <option value="">— seleziona —</option>
      <optgroup label="⚡ Rapida / Ultrarapida">
        <option value="Humalog">Humalog (lispro)</option>
        <option value="NovoRapid">NovoRapid (aspart)</option>
        <option value="Apidra">Apidra (glulisina)</option>
        <option value="Fiasp">Fiasp (aspart ultra)</option>
        <option value="Lyumjev">Lyumjev (lispro ultra)</option>
      </optgroup>
      <optgroup label="🌙 Lenta / Basale">
        <option value="Toujeo">Toujeo (glargine 300)</option>
        <option value="Lantus">Lantus (glargine 100)</option>
        <option value="Tresiba">Tresiba (degludec)</option>
        <option value="Levemir">Levemir (detemir)</option>
        <option value="Basaglar">Basaglar (glargine)</option>
      </optgroup>
      <optgroup label="🔄 Premiscelata">
        <option value="Mixtard">Mixtard 30</option>
        <option value="NovoMix">NovoMix 30</option>
        <option value="Humalog Mix">Humalog Mix 25/50</option>
      </optgroup>
    </select>
  </div>
  <div class="time-row"><span class="fl">&#x1F551; Orario</span><input type="time" class="fi time-input" id="tI_t"><button class="time-now-btn" onclick="setNow('tI_t')">Adesso</button></div>
  <input type="hidden" id="eiI">
  <button class="bsave" onclick="saveIns()">Salva</button>
  <button class="bdel" id="dI" style="display:none" onclick="delE('eiI')">Elimina</button>
</div>

<!-- ═══════════════════════════════════
     PANEL ALCOOL — traccia bevanda e unità alcoliche
     ═══════════════════════════════════ -->
<div class="panel" id="pnlAlcool">
  <div class="ph"></div>
  <div class="panel-day-banner" id="dayBannerAlcool"><span class="dbspan"></span></div>
  <div class="pt">&#127863; Traccia Alcool</div>
  <div class="fr"><span class="fl">Tipo bevanda</span>
    <div class="seg" style="flex-wrap:wrap;gap:5px">
      <button class="sb al" data-v="spritz" onclick="pSeg(this,'tAlc');updAlcInfo()">Spritz</button>
      <button class="sb al" data-v="vino_b" onclick="pSeg(this,'tAlc');updAlcInfo()">Vino B.</button>
      <button class="sb al" data-v="vino_r" onclick="pSeg(this,'tAlc');updAlcInfo()">Vino R.</button>
      <button class="sb al" data-v="birra33" onclick="pSeg(this,'tAlc');updAlcInfo()">Birra 33</button>
      <button class="sb al" data-v="birra50" onclick="pSeg(this,'tAlc');updAlcInfo()">Birra 50</button>
      <button class="sb al" data-v="altro" onclick="pSeg(this,'tAlc');updAlcInfo()">Altro</button>
    </div>
  </div>
  <div class="fr"><span class="fl">Quantit&#224;</span><input class="fi" id="iAQ" type="number" inputmode="numeric" placeholder="1" value="1" oninput="updAlcInfo()"></div>
  <div class="alc-info-box" id="alcInfoBox">
    <div class="alc-info-row"><span style="font-size:.72rem;color:var(--txt2)">Unit&#224; alcoliche</span><span style="font-family:var(--mono);font-size:.9rem;color:var(--alc)" id="alcU">&#8211;</span></div>
    <div class="alc-info-row"><span style="font-size:.72rem;color:var(--txt2)">Calorie</span><span style="font-family:var(--mono);font-size:.9rem;color:var(--o)" id="alcK">&#8211;</span></div>
  </div>
  <div style="background:rgba(255,138,101,.07);border:1px solid rgba(255,138,101,.2);border-radius:9px;padding:9px 11px;margin-bottom:12px;font-size:.7rem;color:var(--txt3);line-height:1.5">
    &#128161; <strong style="color:var(--alc)">Limite settimanale: <span id="alcMaxLbl">5</span> unit&#224;.</strong> L'alcool stimola l'insulina, abbassa la glicemia nelle ore successive e rallenta la perdita di grasso addominale.
  </div>
  <div class="time-row"><span class="fl">&#x1F551; Orario</span><input type="time" class="fi time-input" id="tA_t"><button class="time-now-btn" onclick="setNow('tA_t')">Adesso</button></div>
  <input type="hidden" id="eiA">
  <button class="bsave" onclick="saveAlc()" style="background:var(--alc);color:#000">Salva</button>
  <button class="bdel" id="dA" style="display:none" onclick="delE('eiA')">Elimina</button>
</div>


<!-- ═══════════════════════════════════
     PANEL SPORT — attività, durata, calorie
     ═══════════════════════════════════ -->
<div class="panel" id="pnlSport">
  <div class="ph"></div>
  <div class="panel-day-banner" id="dayBannerSport"><span class="dbspan"></span></div>
  <div class="pt" id="ttSport">🏃 Attività sportiva</div>
  <div class="eh" id="ehSport" style="display:none">Modifica voce</div>
  <div class="fr"><span class="fl">Tipo di attività</span>
    <select class="fi" id="iSportType" style="cursor:pointer;-webkit-appearance:auto" onchange="updSportKcal()">
      <option value="">— seleziona —</option>
      <optgroup label="🏋️ Palestra e fitness">
        <option value="palestra|5.5">Palestra (pesi)</option>
        <option value="crossfit|8">CrossFit</option>
        <option value="yoga|2.5">Yoga</option>
        <option value="pilates|3">Pilates</option>
        <option value="stretching|2">Stretching</option>
      </optgroup>
      <optgroup label="🏃 Corsa e camminata">
        <option value="corsa|9">Corsa (7 min/km)</option>
        <option value="corsa_veloce|11">Corsa veloce (&lt;6 min/km)</option>
        <option value="camminata|3.5">Camminata</option>
        <option value="camminata_veloce|4.5">Camminata veloce</option>
        <option value="montagna|6">Trekking in montagna</option>
        <option value="escursionismo|7">Escursionismo (dislivello)</option>
      </optgroup>
      <optgroup label="🚴 Ciclismo e altro">
        <option value="bicicletta|7">Bicicletta (moderata)</option>
        <option value="bici_veloce|10">Bicicletta (veloce)</option>
        <option value="spinning|9.5">Spinning</option>
        <option value="nuoto|8">Nuoto</option>
      </optgroup>
      <optgroup label="⚽ Sport di squadra">
        <option value="calcio|7">Calcio</option>
        <option value="pallavolo|4">Pallavolo</option>
        <option value="basket|7.5">Basket</option>
        <option value="tennis|6.5">Tennis</option>
        <option value="padel|6">Padel</option>
        <option value="rugby|8">Rugby</option>
        <option value="pallamano|7">Pallamano</option>
      </optgroup>
      <optgroup label="🥊 Arti marziali e combattimento">
        <option value="boxe|8">Boxe</option>
        <option value="karate|6.5">Karate / Arti marziali</option>
      </optgroup>
    </select>
  </div>
  <div class="fr"><span class="fl">Durata</span>
    <select class="fi" id="iSportDur" style="cursor:pointer;-webkit-appearance:auto" onchange="updSportKcal()">
      <option value="15">15 minuti</option>
      <option value="30">30 minuti</option>
      <option value="45">45 minuti</option>
      <option value="60" selected>1 ora</option>
      <option value="75">1h 15min</option>
      <option value="90">1h 30min</option>
      <option value="105">1h 45min</option>
      <option value="120">2 ore</option>
      <option value="150">2h 30min</option>
      <option value="180">3 ore</option>
    </select>
  </div>
  <div class="sport-kcal-box" id="sportKcalBox">
    <div class="sport-kcal-row">
      <span class="sport-kcal-lbl">Calorie stimate bruciate</span>
      <span class="sport-kcal-val" id="sportKcalVal">—</span>
    </div>
    <div class="sport-kcal-row">
      <span class="sport-kcal-lbl">Quota calorica giornaliera aumentata a</span>
      <span style="font-family:var(--mono);font-size:.85rem;color:var(--g)" id="sportNewKcal">—</span>
    </div>
    <div style="font-size:.65rem;color:var(--txt2);margin-top:3px;line-height:1.4">
      ⚡ La quota extra viene sommata al tuo TDEE oggi. L'attività abbassa la glicemia nelle ore successive.
    </div>
  </div>
  <div class="fr" style="margin-top:4px"><span class="fl">Note (opzionale)</span>
    <input class="fi" id="iSportNote" type="text" placeholder="es. palestra con personal trainer...">
  </div>
  <div class="time-row"><span class="fl">🕑 Orario</span><input type="time" class="fi time-input" id="tSP_t"><button class="time-now-btn" onclick="setNow('tSP_t')">Adesso</button></div>
  <input type="hidden" id="eiSP">
  <button class="bsave" onclick="saveSport()" style="background:#29b6f6;color:#000">Salva</button>
  <button class="bdel" id="dSP" style="display:none" onclick="delE('eiSP')">Elimina</button>
</div>
<!-- ═══════════════════════════════════
     PANEL PROFILO — dati corporei, target glicemici,
     limiti alcolici, calcolo macro automatico
     ═══════════════════════════════════ -->
<div class="panel" id="pnlProfilo">
  <div class="ph"></div>
  <div class="pt">&#9881;&#65039; Profilo personale</div>
  <div style="font-size:.72rem;color:var(--txt2);margin-bottom:14px;line-height:1.5">I tuoi parametri per suggerimenti e target nutrizionali. Aggiornali se cambia il peso o le dosi.</div>
  <div class="pdiv">&#128207; Dati corporei</div>
  <div class="g2">
    <div class="fr"><span class="fl">Et&#224;</span><input class="fi" id="cfgAge" type="number" inputmode="numeric" placeholder="32"></div>
    <div class="fr"><span class="fl">Peso (kg)</span><input class="fi" id="cfgWeight" type="number" inputmode="decimal" placeholder="100"></div>
  </div>
  <div class="g2">
    <div class="fr"><span class="fl">Altezza (cm)</span><input class="fi" id="cfgHeight" type="number" inputmode="numeric" placeholder="174"></div>
    <div class="fr"><span class="fl">Sesso</span>
      <div class="seg"><button class="sb" data-v="M" onclick="pSeg(this,'cfgSex')">&#9794; M</button><button class="sb" data-v="F" onclick="pSeg(this,'cfgSex')">&#9792; F</button></div>
    </div>
  </div>
  <div class="fr"><span class="fl">Attivit&#224; fisica</span>
    <div class="seg">
      <button class="sb" data-v="1.2" onclick="pSeg(this,'cfgAct')">Sed.</button>
      <button class="sb" data-v="1.375" onclick="pSeg(this,'cfgAct')">Leggera</button>
      <button class="sb" data-v="1.55" onclick="pSeg(this,'cfgAct')">Moderata</button>
      <button class="sb" data-v="1.725" onclick="pSeg(this,'cfgAct')">Attiva</button>
    </div>
  </div>
  <div class="fr"><span class="fl">Obiettivo</span>
    <div class="seg">
      <button class="sb" data-v="loss" onclick="pSeg(this,'cfgGoal')">Dimagrire</button>
      <button class="sb" data-v="maintain" onclick="pSeg(this,'cfgGoal')">Mantenimento</button>
      <button class="sb" data-v="gain" onclick="pSeg(this,'cfgGoal')">Massa</button>
    </div>
  </div>
  <div class="pdiv">&#128137; Parametri glicemici</div>
  <div class="g2">
    <div class="fr"><span class="fl">Target MIN</span><input class="fi" id="cfgMin" type="number" inputmode="numeric" placeholder="100"></div>
    <div class="fr"><span class="fl">Target MAX</span><input class="fi" id="cfgMax" type="number" inputmode="numeric" placeholder="160"></div>
  </div>
  <div class="g2">
    <div class="fr"><span class="fl">FSI (mg/dL per 1U)</span><input class="fi" id="cfgFsi" type="number" inputmode="numeric" placeholder="30"><div class="fi-hint">Di quanti mg/dL scendi con 1U</div></div>
    <div class="fr"><span class="fl">I:C (g carbo per 1U)</span><input class="fi" id="cfgIc" type="number" inputmode="decimal" step="0.5" placeholder="7"><div class="fi-hint">Grammi coperti da 1U</div></div>
  </div>
  <div class="fr"><span class="fl">Insulina rapida</span>
    <select class="fi" id="cfgInsR">
      <option value="Humalog">Humalog (lispro)</option>
      <option value="Novorapid">Novorapid (aspart)</option>
      <option value="Fiasp">Fiasp (aspart ultrafast)</option>
      <option value="Apidra">Apidra (glulisina)</option>
      <option value="Lyumjev">Lyumjev (lispro-aabc)</option>
      <option value="Admelog">Admelog (lispro)</option>
      <option value="Regular">Regular (umana)</option>
    </select>
  </div>
  <div class="fr"><span class="fl">Insulina basale</span>
    <select class="fi" id="cfgInsB">
      <option value="">— nessuna —</option>
      <option value="Lantus">Lantus (glargine)</option>
      <option value="Toujeo">Toujeo (glargine U300)</option>
      <option value="Tresiba">Tresiba (degludec)</option>
      <option value="Levemir">Levemir (detemir)</option>
      <option value="Basaglar">Basaglar (glargine)</option>
      <option value="Semglee">Semglee (glargine)</option>
      <option value="Ryzodeg">Ryzodeg (mix)</option>
    </select>
  </div>
  <div class="pdiv">&#127863; Limite alcolico</div>
  <div class="fr"><span class="fl">Unit&#224; max a settimana</span><input class="fi" id="cfgAlcMax" type="number" inputmode="numeric" placeholder="5"><div class="fi-hint">1U &#8776; 1 spritz &#183; 1 calice vino &#183; 1 birra 33cl</div></div>
  <div style="margin-top:12px;background:rgba(64,196,255,.06);border:1px solid rgba(64,196,255,.2);border-radius:10px;padding:12px 13px;font-size:.74rem;color:var(--txt3);line-height:1.6">
    <strong style="color:var(--b)">&#x1F4C1; Archiviazione su dispositivo</strong><br>
    GlicoLog salva i dati in:<br>
    &nbsp;• <code style="color:var(--b)">GlicoLog/Data-Non_Eliminare/glicolog_data.json</code><br>
    &nbsp;• <code style="color:var(--b)">GlicoLog/Report/</code> per i PDF esportati<br>
    <span id="fsProfileLbl" style="color:var(--txt2)">Non ancora configurata.</span>
    <button id="fsProfileBtn" onclick="initFSAccess()" style="display:block;margin-top:9px;background:var(--card);border:1px solid var(--bdr2);border-radius:8px;color:var(--b);font-family:var(--sans);font-size:.78rem;font-weight:600;padding:8px 12px;cursor:pointer;width:100%">&#x1F4C2; Scegli / Riconfigura cartella</button>
  </div>
  <button class="bsave" onclick="saveProfile()">Salva e ricalcola target</button>
</div>





<!-- ═══════════════════════════════════
     GLICEMIA CORRECTION POPUP
     ═══════════════════════════════════ -->
<div id="glicCorrModal" onclick="if(event.target===this)closeGlicCorr()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:9990;align-items:center;justify-content:center;padding:20px">
  <div id="glicCorrCard" style="background:#111620;border-radius:16px;padding:22px 20px 18px;width:min(310px,92vw);box-shadow:0 20px 60px #000;border:1px solid rgba(255,255,255,.1)">
    <div id="glicCorrIcon" style="font-size:2rem;margin-bottom:8px;text-align:center"></div>
    <div id="glicCorrTitle" style="font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:.04em;text-align:center;margin-bottom:6px"></div>
    <div id="glicCorrMsg" style="font-size:.78rem;color:#8a99aa;text-align:center;line-height:1.5;margin-bottom:20px"></div>
    <div style="display:flex;flex-direction:column;gap:9px">
      <button id="glicCorrYes" onclick="glicCorrAction()" style="padding:12px;border-radius:10px;border:none;font-family:var(--sans);font-size:.88rem;font-weight:600;cursor:pointer"></button>
      <button onclick="closeGlicCorr()" style="padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,.1);color:#6a7a8a;font-family:var(--sans);font-size:.82rem;cursor:pointer">No, grazie</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════
     FOOD CONFIRM MODAL — popup conferma alimento
     ═══════════════════════════════════ -->
<div class="fcm-overlay" id="fcmOverlay" onclick="if(event.target===this)fcmCancel()">
  <div class="fcm-card">
    <div class="fcm-name" id="fcmName"></div>
    <div class="fcm-portion" id="fcmPortion"></div>
    <div class="fcm-macros">
      <div class="fcm-m c"><div class="fcm-m-val" id="fcmC">–</div><div class="fcm-m-lbl">Carbo</div></div>
      <div class="fcm-m p"><div class="fcm-m-val" id="fcmP">–</div><div class="fcm-m-lbl">Proteine</div></div>
      <div class="fcm-m g"><div class="fcm-m-val" id="fcmG">–</div><div class="fcm-m-lbl">Grassi</div></div>
      <div class="fcm-m k"><div class="fcm-m-val" id="fcmK">–</div><div class="fcm-m-lbl">Kcal</div></div>
    </div>
    <div class="fcm-btns">
      <button class="fcm-yes" onclick="fcmConfirm()">&#x2705; Sì, aggiungi</button>
      <button class="fcm-no" onclick="fcmCancel()">&#x2190; Indietro</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════
     ONBOARDING — primo avvio obbligatorio
     ═══════════════════════════════════ -->
<div class="onb-overlay" id="onbOverlay">
  <div class="onb-inner">
    <div class="onb-logo">Glic<em>o</em>Log</div>
    <div class="onb-sub">Benvenuto! Inserisci i tuoi dati e scegli dove salvare il tuo diario. I campi con <span style="color:var(--r)">*</span> sono obbligatori. La cartella di salvataggio è <strong style="color:var(--r)">obbligatoria</strong>: GlicoLog creerà automaticamente la struttura <code style="color:var(--b)">GlicoLog/Data-Non_Eliminare/</code> e <code style="color:var(--b)">GlicoLog/Report/</code>.</div>
    <div class="onb-step">Configurazione iniziale obbligatoria</div>
    <div class="onb-title">&#x2699;&#xFE0F; Il tuo profilo</div>
    <div style="font-size:.7rem;color:var(--txt2);margin-bottom:10px">Campi con <span style="color:var(--r)">*</span> obbligatori. Le insuline sono opzionali.</div>
    <div class="pdiv">&#x1F4D0; Dati corporei</div>
    <div class="g2">
      <div class="fr"><span class="fl">Et&#224; <span style="color:var(--r)">*</span></span><input class="fi" id="onbAge" type="number" inputmode="numeric" placeholder="32" oninput="checkOnbReady()"></div>
      <div class="fr"><span class="fl">Peso (kg) <span style="color:var(--r)">*</span></span><input class="fi" id="onbWeight" type="number" inputmode="decimal" placeholder="70" oninput="checkOnbReady()"></div>
    </div>
    <div class="g2">
      <div class="fr"><span class="fl">Altezza (cm) <span style="color:var(--r)">*</span></span><input class="fi" id="onbHeight" type="number" inputmode="numeric" placeholder="174" oninput="checkOnbReady()"></div>
      <div class="fr"><span class="fl">Sesso <span style="color:var(--r)">*</span></span>
        <div class="seg"><button class="sb" data-v="M" onclick="pSegOnb(this,'onbSex')">&#x2642; M</button><button class="sb" data-v="F" onclick="pSegOnb(this,'onbSex')">&#x2640; F</button></div>
        <input type="hidden" id="onbSex">
      </div>
    </div>
    <div class="fr"><span class="fl">Attivit&#224; fisica <span style="color:var(--r)">*</span></span>
      <div class="seg">
        <button class="sb" data-v="1.2"   onclick="pSegOnb(this,'onbAct')">Sed.</button>
        <button class="sb" data-v="1.375" onclick="pSegOnb(this,'onbAct')">Leggera</button>
        <button class="sb" data-v="1.55"  onclick="pSegOnb(this,'onbAct')">Moderata</button>
        <button class="sb" data-v="1.725" onclick="pSegOnb(this,'onbAct')">Attiva</button>
      </div>
      <input type="hidden" id="onbAct">
    </div>
    <div class="fr"><span class="fl">Obiettivo <span style="color:var(--r)">*</span></span>
      <div class="seg">
        <button class="sb" data-v="loss"     onclick="pSegOnb(this,'onbGoal')">Dimagrire</button>
        <button class="sb" data-v="maintain" onclick="pSegOnb(this,'onbGoal')">Mantenimento</button>
        <button class="sb" data-v="gain"     onclick="pSegOnb(this,'onbGoal')">Massa</button>
      </div>
      <input type="hidden" id="onbGoal">
    </div>
    <div class="pdiv" style="margin-top:14px">&#x1F489; Parametri glicemici</div>
    <div class="g2">
      <div class="fr"><span class="fl">Target MIN <span style="color:var(--r)">*</span></span><input class="fi" id="onbMin" type="number" inputmode="numeric" placeholder="80" oninput="checkOnbReady()"></div>
      <div class="fr"><span class="fl">Target MAX <span style="color:var(--r)">*</span></span><input class="fi" id="onbMax" type="number" inputmode="numeric" placeholder="160" oninput="checkOnbReady()"></div>
    </div>
    <div class="g2">
      <div class="fr"><span class="fl">FSI (mg/dL per 1U) <span style="color:var(--r)">*</span></span><input class="fi" id="onbFsi" type="number" inputmode="numeric" placeholder="30" oninput="checkOnbReady()"><div class="fi-hint">Quanto scendi con 1U</div></div>
      <div class="fr"><span class="fl">I:C (g carbo per 1U) <span style="color:var(--r)">*</span></span><input class="fi" id="onbIc" type="number" inputmode="decimal" step="0.5" placeholder="7" oninput="checkOnbReady()"><div class="fi-hint">Grammi coperti da 1U</div></div>
    </div>
    <div class="pdiv" style="margin-top:14px">&#x1F48A; Insuline (opzionale)</div>
    <div class="fr"><span class="fl">Insulina rapida (bolo)</span>
      <select class="fi" id="onbInsR">
        <option value="">— Nessuna / Non so —</option>
        <option value="Humalog">Humalog (lispro)</option>
        <option value="Novorapid">Novorapid (aspart)</option>
        <option value="Fiasp">Fiasp (aspart ultrafast)</option>
        <option value="Apidra">Apidra (glulisina)</option>
        <option value="Lyumjev">Lyumjev (lispro-aabc)</option>
        <option value="Regular">Regular (umana)</option>
      </select>
    </div>
    <div class="fr"><span class="fl">Insulina basale</span>
      <select class="fi" id="onbInsB">
        <option value="">— Nessuna —</option>
        <option value="Lantus">Lantus (glargine)</option>
        <option value="Toujeo">Toujeo (glargine U300)</option>
        <option value="Tresiba">Tresiba (degludec)</option>
        <option value="Levemir">Levemir (detemir)</option>
        <option value="Basaglar">Basaglar (glargine)</option>
        <option value="Ryzodeg">Ryzodeg (mix)</option>
      </select>
    </div>
    <div id="onbFsBox" style="margin-top:16px;background:rgba(255,82,82,.05);border:2px solid rgba(255,82,82,.25);border-radius:12px;padding:13px 14px;font-size:.75rem;line-height:1.6">
      <strong style="color:var(--r);font-size:.82rem">&#x1F4C1; Cartella di salvataggio <span style="color:var(--r)">*</span> — obbligatoria</strong><br>
      <span style="color:var(--txt3)">GlicoLog salverà automaticamente tutti i tuoi dati in questa cartella:<br>
      &nbsp;• <code style="color:var(--b)">GlicoLog/Data-Non_Eliminare/glicolog_data.json</code> — backup completo<br>
      &nbsp;• <code style="color:var(--b)">GlicoLog/Report/</code> — tutti i PDF esportati<br>
      Se lo storage del telefono viene cancellato, i tuoi dati sono al sicuro qui.</span>
      <div id="onbFsRequired" style="margin-top:8px;background:rgba(255,82,82,.1);border-radius:7px;padding:6px 10px;font-size:.69rem;color:var(--r);font-weight:600">⚠️ Obbligatorio: seleziona la cartella per continuare</div>
      <button id="onbFsBtn" onclick="initFSAccess(true)" style="display:block;margin-top:9px;background:var(--card);border:1px solid var(--bdr2);border-radius:9px;color:var(--b);font-family:var(--sans);font-size:.82rem;font-weight:600;padding:10px 14px;cursor:pointer;width:100%;transition:all .15s">&#x1F4C2; Seleziona cartella →</button>
      <div id="fsStatusOnb" style="margin-top:6px;font-size:.69rem;color:var(--g);display:none;font-weight:600"></div>
    </div>
    <!-- Messaggio alternativo mostrato solo nell'APK (IS_NATIVE=true) -->
    <div id="onbFsNativeBox" style="display:none;margin-top:16px;background:rgba(0,230,118,.06);border:2px solid rgba(0,230,118,.3);border-radius:12px;padding:13px 14px;font-size:.75rem;line-height:1.7;color:var(--txt3)">
      <strong style="color:var(--g);font-size:.82rem">&#x1F4C1; Archiviazione automatica ✅</strong><br>
      Stai usando l'app nativa: GlicoLog salva automaticamente tutti i tuoi dati in:<br>
      &nbsp;• <code style="color:var(--g)">Documents/GlicoLog/Data-Non_Eliminare/</code><br>
      &nbsp;• <code style="color:var(--g)">Documents/GlicoLog/Report/</code> (PDF)<br>
      Non devi fare nulla — il backup avviene in background ad ogni modifica.
    </div>
    <button class="onb-save" id="onbSaveBtn" onclick="saveOnboarding()">Salva e inizia &#x2192;</button>
  </div>
</div>


<!-- ═══════════════════════════════════
     WATER QUICK MODAL
     ═══════════════════════════════════ -->
<div id="waterQuickModal" onclick="if(event.target===this)closeWaterModal()">
  <div class="wq-card">
    <div class="wq-title">💧 Acqua bevuta oggi</div>
    <!-- Barra progresso giornaliera (target 2000ml) -->
    <div class="wq-bar">
      <span class="wq-bar-lbl">Oggi</span>
      <span class="wq-bar-val" id="wqTotal">0 ml</span>
      <div class="wq-bar-track"><div class="wq-bar-fill" id="wqFill" style="width:0%"></div></div>
      <span class="wq-bar-lbl" id="wqTarget">/ 2000ml</span>
    </div>
    <!-- Quantità rapide -->
    <div class="wq-grid">
      <button class="wq-btn" onclick="addWater(200)">
        <span class="wq-ico">🥛</span>
        <span class="wq-lbl">Bicchiere</span>
        <span class="wq-ml">200ml</span>
      </button>
      <button class="wq-btn" onclick="addWater(300)">
        <span class="wq-ico">🥤</span>
        <span class="wq-lbl">Bicchiere M</span>
        <span class="wq-ml">300ml</span>
      </button>
      <button class="wq-btn" onclick="addWater(400)">
        <span class="wq-ico">🥤</span>
        <span class="wq-lbl">Bicchiere XL</span>
        <span class="wq-ml">400ml</span>
      </button>
      <button class="wq-btn" onclick="addWater(500)">
        <span class="wq-ico">🍶</span>
        <span class="wq-lbl">Bottiglietta</span>
        <span class="wq-ml">500ml</span>
      </button>
      <button class="wq-btn" onclick="addWater(750)">
        <span class="wq-ico">🍾</span>
        <span class="wq-lbl">Bottiglia</span>
        <span class="wq-ml">750ml</span>
      </button>
      <button class="wq-btn" onclick="addWater(1000)">
        <span class="wq-ico">🫙</span>
        <span class="wq-lbl">Bottiglia 1L</span>
        <span class="wq-ml">1000ml</span>
      </button>
    </div>
    <!-- Personalizzato -->
    <div class="wq-custom">
      <input class="fi" id="wqCustom" type="number" inputmode="numeric" placeholder="Quantità personalizzata (ml)…">
    </div>
    <button class="bsave" style="width:100%;margin-bottom:10px" onclick="addWaterCustom()">+ Aggiungi</button>
    <!-- Log voci odierne -->
    <div id="wqEntries"></div>
    <button class="wq-close" onclick="closeWaterModal()">Chiudi</button>
  </div>
</div>

<!-- ═══════════════════════════════════
     PDF PERIOD MODAL
     ═══════════════════════════════════ -->
<div id="pdfPeriodModal" onclick="if(event.target===this)closePdfModal()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:9999;align-items:center;justify-content:center">
  <div style="background:#111620;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:22px 20px 18px;width:min(320px,90vw);box-shadow:0 20px 60px #000">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:#00e676;letter-spacing:.04em;margin-bottom:4px">📄 Esporta PDF</div>
    <div style="font-size:.75rem;color:#7a8899;margin-bottom:18px">Scegli il periodo da includere nel report</div>
    <div style="display:flex;flex-direction:column;gap:9px">
      <button class="pdf-opt-btn" onclick="closePdfModal();exportPDF('all')">
        <span class="pdf-opt-icon">📋</span>
        <div><div class="pdf-opt-title">Tutti i dati</div><div class="pdf-opt-sub">Report completo di ogni giorno registrato</div></div>
      </button>
      <button class="pdf-opt-btn" onclick="closePdfModal();exportPDF('30gg')">
        <span class="pdf-opt-icon">📅</span>
        <div><div class="pdf-opt-title">Ultimi 30 giorni</div><div class="pdf-opt-sub">Include solo le ultime 4 settimane</div></div>
      </button>
      <button class="pdf-opt-btn" onclick="closePdfModal();exportPDF('14gg')">
        <span class="pdf-opt-icon">📅</span>
        <div><div class="pdf-opt-title">Ultimi 14 giorni</div><div class="pdf-opt-sub">Include le ultime 2 settimane</div></div>
      </button>
      <button class="pdf-opt-btn" onclick="closePdfModal();exportPDF('7gg')">
        <span class="pdf-opt-icon">📅</span>
        <div><div class="pdf-opt-title">Ultimi 7 giorni</div><div class="pdf-opt-sub">Include solo l'ultima settimana</div></div>
      </button>
      <button class="pdf-opt-btn" id="pdfOptGiorno" onclick="closePdfModal();exportPDF('giorno')">
        <span class="pdf-opt-icon">📆</span>
        <div><div class="pdf-opt-title" id="pdfOptGiornoTitle">Giorno selezionato</div><div class="pdf-opt-sub" id="pdfOptGiornoSub">Solo il giorno attualmente visualizzato</div></div>
      </button>
    </div>
    <button onclick="closePdfModal()" style="width:100%;margin-top:14px;padding:10px;background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#7a8899;font-family:var(--sans);font-size:.8rem;cursor:pointer">Annulla</button>
  </div>
</div>

<!-- ═══════════════════════════════════
     OVERLAY CHART MODAL (7/14/30gg sovrapposti)
     ═══════════════════════════════════ -->
<div id="overlayChartModal" onclick="if(event.target===this)closeOverlayChart()">
  <div class="oc-card">
    <div class="oc-title">📈 Andamento glicemia</div>
    <div class="oc-tabs">
      <button class="oc-tab on" onclick="drawOverlayChart(7,this)">7 giorni</button>
      <button class="oc-tab" onclick="drawOverlayChart(14,this)">14 giorni</button>
      <button class="oc-tab" onclick="drawOverlayChart(30,this)">30 giorni</button>
    </div>
    <div class="oc-canvas-wrap">
      <canvas id="ocCanvas" style="width:100%;height:200px"></canvas>
    </div>
    <div class="oc-legend" id="ocLegend">Media per fascia oraria — tutti i giorni sovrapposti</div>
    <div class="oc-stats" id="ocStats"></div>
    <button class="oc-close" onclick="closeOverlayChart()">Chiudi</button>
  </div>
</div>
<!-- ═══ DELETE CONFIRM DIALOG ═══════════════════════════════ -->
<div class="del-confirm" id="delConfirm">
  <div class="del-confirm-card">
    <div class="del-confirm-ico">🗑️</div>
    <div class="del-confirm-msg" id="delConfirmMsg">Vuoi eliminare questa voce?</div>
    <div class="del-confirm-btns">
      <button class="del-btn-yes" id="delBtnYes">Elimina</button>
      <button class="del-btn-no" onclick="closeDelConfirm()">Annulla</button>
    </div>
  </div>
</div>
<!-- ═══════════════════════════════════
     STEPS MODAL — inserimento manuale + sync Health Connect
     ═══════════════════════════════════ -->
<div class="steps-edit" id="stepsModal" onclick="if(event.target===this)closeStepsModal()">
  <div class="steps-card">
    <div class="ph"></div>
    <div class="pt">&#x1F463; Passi</div>
    <!-- Pulsante sync Health Connect: visibile solo su APK nativo -->
    <button id="btnSyncHealth" onclick="syncStepsFromHealth().then(closeStepsModal)"
      style="width:100%;background:rgba(41,182,246,.12);border:1px solid rgba(41,182,246,.3);
             border-radius:11px;color:#29b6f6;font-family:var(--sans);font-size:.82rem;
             font-weight:600;padding:12px;margin-bottom:14px;cursor:pointer;display:none">
      &#x1F504; Sincronizza da Health Connect
    </button>
    <div style="font-size:.72rem;color:var(--txt2);margin-bottom:14px;line-height:1.5" id="stepsModalHint">
      Inserisci manualmente i passi del giorno.
    </div>
    <div class="fr"><span class="fl">Passi del giorno</span>
      <input class="fi big" id="stepsInput" type="number" inputmode="numeric" placeholder="0" style="font-size:1.6rem" oninput="updateStepsKmPreview()">
    </div>
    <div class="fr"><span class="fl">Passo medio (cm) — per calcolo km</span>
      <input class="fi" id="strideInput" type="number" inputmode="numeric" placeholder="75" value="75" oninput="updateStepsKmPreview()">
    </div>
    <div class="fr" id="stepsKmPreview" style="font-size:.8rem;color:var(--g);min-height:1.2em"></div>
    <button class="bsave" onclick="saveSteps()" style="margin-top:4px">&#x1F4BE; Salva manualmente</button>
    <button class="bdel" onclick="closeStepsModal()" style="margin-top:6px">Annulla</button>
  </div>
</div>
<!-- ═══════════════════════════════════
     BARCODE SCANNER — overlay fullscreen camera
     richiede CAMERA permission nel manifest Android
     ═══════════════════════════════════ -->
<div class="scan-ov" id="scanOv">
  <div class="scan-hdr">
    <button class="scan-close" onclick="closeScanner()">&#x2715;</button>
    <div class="scan-title">&#x1F4F7; Scansiona barcode</div>
  </div>
  <div class="scan-wrap">
    <video class="scan-video" id="scanVideo" playsinline muted autoplay></video>
    <div class="scan-frame">
      <div class="scan-line"></div>
    </div>
    <div class="scan-hint">
      Inquadra il barcode del prodotto<br>
      <button class="scan-btn-manual" onclick="manualBarcode()">Inserisci barcode manuale</button>
    </div>
  </div>
</div>

<!-- TOAST — notifica temporanea -->
<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: COSTANTI E STATO GLOBALE
// KEY        → chiave localStorage per le voci (pasti, glicemie, ecc.)
// CFGKEY     → chiave localStorage per la configurazione utente
// DBKEY      → chiave localStorage per il database alimenti personalizzato
// cp         → nome del pannello attualmente aperto (null se chiuso)
// cd         → offset giorno: 0=oggi, -1=ieri, -2=altroieri, ecc.
// curChart   → tipo grafico attivo: 'day' | 'week' | 'month'
// sg         → oggetto "stato segmenti": raccoglie i valori dei button-group
//              (es. sg.tP='Pranzo', sg.tTrend='↑', sg.tI='Bolo')
// dp         → deferred BeforeInstallPrompt event per installazione PWA
// ═══════════════════════════════════════════════════════════════
const KEY='glicolog_v2', CFGKEY='glicolog_cfg6', DBKEY='glicolog_fooddb7';
// Migrazione DB: versioni precedenti (fooddb1-6) avevano valori per-porzione non standardizzati
// Rimuoviamo le chiavi obsolete per evitare conflitti con il nuovo DB per-100g
['glicolog_fooddb1','glicolog_fooddb2','glicolog_fooddb3','glicolog_fooddb4','glicolog_fooddb5','glicolog_fooddb6'].forEach(k => {
  try { localStorage.removeItem(k); } catch(e) {}
});
let cp=null, cd=0, curChart='day';
const sg={};
let dp=null;

// DEF: configurazione di default.
// Contiene: parametri corporei, range glicemico target, FSI (fattore sensibilità insulina),
// IC (insulin-to-carb ratio), tipo insulina rapida, limite alcool settimanale,
// e macro giornalieri target (kcal, proteine, carboidrati, grassi, fibre).
// Viene sovrascritta dai valori salvati nel profilo utente. 32a, M, 174cm, 100kg) — Andrea's calculated values (32y, M, 174cm, 100kg, leggero, dimagrire)
// DEF: valori di default SOLO per campi non-personali (app settings).
// I campi del profilo utente (age, weight, height, sex, fsi, ic, target*)
// NON hanno default: se assenti -> l'app mostra l'onboarding obbligatorio.
const DEF={
  carbFactor:15,
  insRapida:'Humalog',
  insBasale:'',
  alcMax:5,
  activity:1.375,
  goal:'loss'
};

// ALCDB: database bevande alcoliche.
// u = unità alcoliche per porzione standard
// k = calorie per porzione standard
// l = etichetta leggibile mostrata all'utente
const ALCDB={
  spritz:{u:1.5,k:160,l:'Spritz'},
  vino_b:{u:1.0,k:85,l:'Vino bianco'},
  vino_r:{u:1.0,k:90,l:'Vino rosso'},
  birra33:{u:1.1,k:145,l:'Birra 33cl'},
  birra50:{u:1.7,k:220,l:'Birra 50cl'},
  altro:{u:1.0,k:100,l:'Altro'}
};

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: STORAGE HELPERS
// ld()   → legge array voci da localStorage (KEY), ritorna [] se vuoto/corrotto
// sv(d)  → scrive array voci in localStorage
// ldC()  → legge config utente (CFGKEY) mergiata con DEF (fallback sicuro)
// svC(c) → scrive config utente
// ldDB() → legge DB alimenti personalizzato (DBKEY) mergiato con FOODDB0
// svDB() → scrive DB alimenti personalizzato
// uid()  → genera ID univoco: timestamp base36 + 3 char random
// p2(n)  → pad a 2 cifre (es. 9 → '09') per formattare date/ore
// ═══════════════════════════════════════════════════════════════
const ld=()=>{try{return JSON.parse(localStorage.getItem(KEY))||[];}catch{return[];}};
let _fsBackupTimer = null;
const sv=d=>{localStorage.setItem(KEY,JSON.stringify(d));clearTimeout(_fsBackupTimer);_fsBackupTimer=setTimeout(()=>{if(typeof fsSaveData==='function')fsSaveData();},2000);};
const ldC=()=>{
  // Legge la cfg salvata e la mergia con i default non-personali (DEF)
  let c;
  try { c = Object.assign({}, DEF, JSON.parse(localStorage.getItem(CFGKEY))); }
  catch { c = {...DEF}; }
  // Fallback di rendering: usati SOLO per display/grafici quando il profilo
  // non è ancora configurato. NON vengono salvati in localStorage.
  if (!c.targetMin)  c.targetMin  = 80;
  if (!c.targetMax)  c.targetMax  = 180;
  if (!c.fsi)        c.fsi        = 40;
  if (!c.ic)         c.ic         = 10;
  if (!c.carbFactor) c.carbFactor = 15;
  return c;
};
const svC=c=>localStorage.setItem(CFGKEY,JSON.stringify(c));
const svDB=d=>localStorage.setItem(DBKEY,JSON.stringify(d));
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,5);
const p2=n=>String(n).padStart(2,'0');

function ldDB() { 
  // Unisce il DB esterno gigante (CLAUDE_DB e CREA_DB), il DB di base (FOODDB0) e i tuoi cibi salvati
  const miniorDB = typeof CREA_DB !== 'undefined' ? CREA_DB : {};
  const baseFoodDB = typeof FOODDB0 !== 'undefined' ? FOODDB0 : {};
  const massiveDB = typeof CLAUDE_DB !== 'undefined' ? CLAUDE_DB : {};
  
  return Object.assign({}, massiveDB, miniorDB, baseFoodDB, JSON.parse(localStorage.getItem(DBKEY)) || {}); 
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: PWA / SERVICE WORKER
// Registra sw.js per il funzionamento offline (cache-first strategy).
// ATTENZIONE: il SW viene registrato SOLO in browser, mai in Capacitor
// nativo (iOS/Android), perché causerebbe un bug di cache stuck.
// beforeinstallprompt: intercetta il prompt di installazione del browser
//   e lo mostra come banner in-app (ibar).
// appinstalled: nasconde il banner dopo l'installazione.
// doInstall(): esegue il prompt nativo quando l'utente tocca "Installa".
// ═══════════════════════════════════════════════════════════════
// Service Worker: solo in browser, MAI in Capacitor native (causa cache stuck)
if('serviceWorker' in navigator && !(window.Capacitor && window.Capacitor.isNativePlatform())) {
  navigator.serviceWorker.register('sw.js');
}
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dp=e;document.getElementById('ibar').classList.add('on');});
window.addEventListener('appinstalled',()=>{document.getElementById('ibar').classList.remove('on');dp=null;toast('\u2705 App installata!');});
async function doInstall(){if(!dp)return;dp.prompt();dp=null;document.getElementById('ibar').classList.remove('on');}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: OROLOGIO HEADER
// DI = array nomi giorni abbreviati in italiano (Dom, Lun, Mar…)
// MI = array nomi mesi abbreviati in italiano (Gen, Feb, Mar…)
// tick(): aggiorna #hTime (HH:MM) e #hDate (Gio 26 Feb) ogni 15 secondi.
//   L'orologio è centrato in assoluto sull'header via CSS absolute+translateX.
// ═══════════════════════════════════════════════════════════════
const DI=['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
const MI=['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
function tick(){const n=new Date();document.getElementById('hTime').textContent=p2(n.getHours())+':'+p2(n.getMinutes());document.getElementById('hDate').textContent=DI[n.getDay()]+' '+p2(n.getDate())+' '+MI[n.getMonth()];}
setInterval(tick,15000);tick();

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: NAVIGAZIONE GIORNI
// Sistema basato su offset intero (cd):
//   0 = oggi, -1 = ieri, -2 = due giorni fa, +1 = domani (bloccato)
// getDK(off): ritorna chiave stringa 'YYYY-MM-DD' per cercare nel localStorage
// getDF(off): ritorna stringa leggibile 'Lun 26 Feb 2026' per il display
// setDL():    aggiorna il label con badge verde "OGGI" se cd===0
// chDay(d):   sposta di +1/-1 giorno, blocca il futuro (cd>0),
//             ri-renderizza timeline, strip, grafico, nutrizione
// ═══════════════════════════════════════════════════════════════
function getDK(off){const d=new Date();d.setDate(d.getDate()+off);return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate());}
function getDF(off){const d=new Date();d.setDate(d.getDate()+off);return DI[d.getDay()]+' '+p2(d.getDate())+' '+MI[d.getMonth()]+' '+d.getFullYear();}
function setDL(){document.getElementById('dlbl').innerHTML=getDF(cd)+(cd===0?'<span class="oggi-b">OGGI</span>':'');}
function chDay(d){
  if(cd===0&&d===1)return;
  cd+=d;setDL();renderTL();renderStrip();
  if(document.getElementById('stB').classList.contains('show'))drawChart();
  if(document.getElementById('nutB').classList.contains('show'))renderNut();
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: GESTIONE PANNELLI (BOTTOM SHEET)
// I pannelli sono drawer CSS che salgono da fondo schermo (.panel.on).
// L'overlay scuro (.ov.on) chiude il pannello al tap fuori.
//
// openPanel(n, data):
//   - chiude eventuali pannelli già aperti
//   - mostra overlay + pannello corrispondente
//   - resetta il form (resetP)
//   - imposta l'orario attuale nei campi time
//   - per 'profilo': carica valori salvati (loadProfileForm)
//   - se data≠null: popola il form in modalità MODIFICA (fillE)
//   - per insulina: pre-seleziona tab Bolo + farmaco da profilo
//   - mostra il banner "stai aggiungendo per [data]" se cd≠0
//
// closePanel(s):
//   - rimuove .on da tutti i pannelli e dall'overlay
//   - resetta food rows e nutrition result boxes
//
// resetP(n):
//   - svuota tutti i campi del form del pannello n
//   - rimuove .on da tutti i segmenti/trend selector
//   - ripristina il titolo del pannello (es. "🍽️ Nuovo Pasto")
//   - resetta bevanda UI (unità, zucchero, grammi)
//
// fillE(n, e):
//   - precompila tutti i campi con i valori della voce e (oggetto entry)
//   - gestisce retrocompatibilità: food string → array righe separate
//   - richiama fillTime() per l'orario, pSeg() per i segmenti
//
// pSeg(b, k):
//   - button-group: deseleziona tutto, seleziona b, salva b.dataset.v in sg[k]
// ═══════════════════════════════════════════════════════════════
// closePanel() chiude e pulisce
// resetP() azzera i campi del form
// fillE() precompila il form in modalità modifica
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);
const PANELS=['pasto','spuntino','glicemia','insulina','alcool','sport','profilo'];

function openPanel(n,data){
  closePanel(true);cp=n;
  document.getElementById('ov').classList.add('on');
  const el=document.getElementById('pnl'+cap(n));if(el)el.classList.add('on');
  if(n==='profilo'){loadProfileForm();return;}
  resetP(n);
  showDayBanners();
  // Imposta sempre l'orario attuale all'apertura (non solo se vuoto)
  if(!data){setNow('tP_t');setNow('tS_t');setNow('tG');setNow('tI_t');setNow('tA_t');setNow('tSP_t');}
  else{initTime('tP_t');initTime('tS_t');initTime('tG');initTime('tI_t');initTime('tA_t');}
  if(n==='pasto')initFoodRows('P');
  if(n==='spuntino'){initFoodRows('S');
    // Ripristina visibilità campi (potrebbero essere stati nascosti dal popup correzione)
    const gr=document.getElementById('spuntinoGlicRow');const tr=document.getElementById('spuntinoTrendRow');
    const br=document.getElementById('spuntinoBoloRow');const ib=document.getElementById('ipoFixBox');
    if(gr)gr.style.display='';if(tr)tr.style.display='';
    if(br)br.style.display='';if(ib)ib.style.display='none';
  }
  if(data)fillE(n,data);
  else{
  if(n==='pasto'){const h=new Date().getHours(),g=h<11?'Colazione':h<15?'Pranzo':'Cena';document.querySelectorAll('#pnlPasto .sb').forEach(b=>{if(b.dataset.v===g){b.classList.add('on');sg.tP=g;}});}
    if(n==='glicemia'){setTimeout(()=>{const el=document.getElementById('iG');if(el)el.focus();},200);}
    if(n==='insulina'){setTimeout(()=>{const el=document.getElementById('iU');if(el)el.focus();},200);
      document.querySelector('#pnlInsulina .sb[data-v="Bolo"]').classList.add('on');
      sg.tI='Bolo';
      const iitEl=document.getElementById('iIT');
      if(iitEl){const cfg=ldC();iitEl.value=cfg.insRapida||'Humalog';}
    }
    if(n==='alcool'){document.getElementById('alcInfoBox').style.display='none';const cfg=ldC();document.getElementById('alcMaxLbl').textContent=cfg.alcMax;}
    if(n==='sport'){document.getElementById('sportKcalBox').classList.remove('on');}
  }
}
function closePanel(s){
  // Reset food rows + nutPort of the panel being closed
  if(cp){
    ['P','S'].forEach(pre=>{
      const np=document.getElementById('nutPort'+pre);if(np)np.classList.remove('on');
      const nr=document.getElementById('nutRes'+pre);if(nr)nr.classList.remove('on');
    });
    if(cp==='pasto'){initFoodRows('P');}
    if(cp==='spuntino'){initFoodRows('S');}
  }
  PANELS.forEach(n=>{const el=document.getElementById('pnl'+cap(n));if(el)el.classList.remove('on');});
  document.getElementById('ov').classList.remove('on');cp=null;
  document.querySelectorAll('.ac').forEach(a=>a.classList.remove('on'));
}
function resetP(n){
  const ids={
    pasto:['iPP','iBP','iBS','mPC','mPP','mPG','mPF','eiP'],
    spuntino:['iSP','iSBP','iSBS','mSC','mSP','mSG','mSF','eiS'],
    glicemia:['iG','eiG'],insulina:['iU','iIT','eiI'],alcool:['eiA'],
    sport:['iSportType','iSportNote','eiSP','iSportDur']
  };
  (ids[n]||[]).forEach(id=>{const el=document.getElementById(id);if(el){el.value='';if(el.dataset)delete el.dataset.manualOverride;}});
  const aq=document.getElementById('iAQ');if(aq)aq.value='1';
  document.querySelectorAll('#pnl'+cap(n)+' .sb,.tsb').forEach(b=>b.classList.remove('on'));
  delete sg.tP;delete sg.tG;delete sg.tI;delete sg.tTrend;delete sg.tAlc;delete sg.tTrPRE;delete sg.tTrSPRE;
  // Preseleziona andamento → (stabile) come default per tutti i panel
  const _trendDefaults = {
    tTrend:  { panel:'pnlGlicemia', key:'tTrend',  val:'→' },
    tTrPRE:  { panel:'pnlPasto',    key:'tTrPRE',  val:'→' },
    tTrSPRE: { panel:'pnlSpuntino', key:'tTrSPRE', val:'→' },
  };
  Object.values(_trendDefaults).forEach(({panel, key, val}) => {
    const btn = document.querySelector('#'+panel+' .tsb[data-v="'+val+'"]');
    if (btn) { btn.classList.add('on'); sg[key] = val; }
  });
  const eh=document.getElementById('eh'+cap(n));if(eh)eh.style.display='none';
  const dd=document.getElementById('d'+n.charAt(0).toUpperCase());if(dd)dd.style.display='none';
  const tt=document.getElementById('tt'+cap(n));
  if(tt){const t={pasto:'\uD83C\uDF7D\uFE0F Nuovo Pasto',spuntino:'\uD83C\uDF4E Spuntino',glicemia:'\uD83D\uDC89 Glicemia',insulina:'\uD83D\uDC8A Insulina',sport:'\uD83C\uDFC3 Attivit\u00E0 sportiva'};tt.textContent=t[n]||'';}
  // Reset bevanda UI e zucchero
  const pre=(n==='pasto'?'P':n==='spuntino'?'S':null);
  if(pre){
    const st=document.getElementById('sugarTeasp'+pre);if(st)st.value='';
    const sc=document.getElementById('sugarCarbs'+pre);if(sc)sc.textContent='0';
    const sr=document.getElementById('sugarRow'+pre);if(sr)sr.style.display='none';
    const bu=document.getElementById('bevUnits'+pre);if(bu)bu.style.display='none';
    const ut=document.getElementById('nutUnit'+pre);if(ut)ut.textContent='g';
    document.querySelectorAll('#bevUnits'+pre+' .bev-btn').forEach(b=>b.classList.remove('on'));
    const gp=document.getElementById('nutGrams'+pre);if(gp)gp.placeholder='es. 80';
    const np=document.getElementById('nutPortTitle'+pre);
    if(np)np.innerHTML='\u2696\uFE0F Quanti grammi? <span id="nutPortName'+pre+'" style="color:var(--nut)"></span>';
  }
}
function fillE(n,e){
  const eh=document.getElementById('eh'+cap(n));if(eh)eh.style.display='block';
  const dd=document.getElementById('d'+n.charAt(0).toUpperCase());if(dd)dd.style.display='block';
  const tt=document.getElementById('tt'+cap(n));if(tt)tt.textContent='\u270F\uFE0F Modifica';
  if(n==='pasto'){
    document.getElementById('eiP').value=e.id;fillTime('tP_t',e.ts);
    initFoodRows('P');
    setTimeout(()=>{
      if(e.foodItems && e.foodItems.length){
        // Nuova modalità: una riga per alimento con grammi e macro
        document.getElementById('foodRowsP').innerHTML='';
        foodRowCount['P']=0;
        e.foodItems.forEach(fi=>addFoodRow('P',fi));
      } else if(e.food){
        // Retrocompat: split per virgola → righe separate
        const names=(e.food||'').split(',').map(s=>s.trim()).filter(Boolean);
        document.getElementById('foodRowsP').innerHTML='';
        foodRowCount['P']=0;
        if(names.length===0){addFoodRow('P');}
        else{names.forEach(name=>addFoodRow('P',{name}));}
      }
    },50);
    document.getElementById('iPP').value=e.pre||'';
    document.getElementById('iBP').value=e.boloPre||'';document.getElementById('iBS').value=e.boloPost||'';
    if(e.trPRE){document.querySelectorAll('#pnlPasto .trend-sel .tsb').forEach(b=>b.classList.remove('on'));document.querySelectorAll('#pnlPasto .trend-sel .tsb').forEach(b=>{if(b.dataset.v===e.trPRE){b.classList.add('on');sg.tTrPRE=e.trPRE;}});}
    document.getElementById('mPC').value=e.carbs||'';document.getElementById('mPP').value=e.protein||'';
    document.getElementById('mPG').value=e.fat||'';document.getElementById('mPF').value=e.fiber||'';
    document.querySelectorAll('#pnlPasto .sb').forEach(b=>{if(b.dataset.v===e.tipo){b.classList.add('on');sg.tP=e.tipo;}});
  }else if(n==='spuntino'){
    document.getElementById('eiS').value=e.id;fillTime('tS_t',e.ts);
    initFoodRows('S');
    setTimeout(()=>{
      if(e.foodItems && e.foodItems.length){
        document.getElementById('foodRowsS').innerHTML='';
        foodRowCount['S']=0;
        e.foodItems.forEach(fi=>addFoodRow('S',fi));
      } else if(e.food){
        const names=(e.food||'').split(',').map(s=>s.trim()).filter(Boolean);
        document.getElementById('foodRowsS').innerHTML='';
        foodRowCount['S']=0;
        if(names.length===0){addFoodRow('S');}
        else{names.forEach(name=>addFoodRow('S',{name}));}
      }
    },50);
    document.getElementById('iSP').value=e.pre||'';
    document.getElementById('iSBP').value=e.boloPre||'';document.getElementById('iSBS').value=e.boloPost||'';
    if(e.trSPRE){document.querySelectorAll('#pnlSpuntino .trend-sel .tsb').forEach(b=>b.classList.remove('on'));document.querySelectorAll('#pnlSpuntino .trend-sel .tsb').forEach(b=>{if(b.dataset.v===e.trSPRE){b.classList.add('on');sg.tTrSPRE=e.trSPRE;}});}
    document.getElementById('mSC').value=e.carbs||'';document.getElementById('mSP').value=e.protein||'';
    document.getElementById('mSG').value=e.fat||'';document.getElementById('mSF').value=e.fiber||'';
  }else if(n==='glicemia'){
    document.getElementById('eiG').value=e.id;document.getElementById('iG').value=e.value||'';fillTime('tG',e.ts);
    document.querySelectorAll('#pnlGlicemia .sb').forEach(b=>{if(b.dataset.v===e.momento){b.classList.add('on');sg.tG=e.momento;}});
    if(e.trend){document.querySelectorAll('#pnlGlicemia .tsb').forEach(b=>b.classList.remove('on'));document.querySelectorAll('#pnlGlicemia .tsb').forEach(b=>{if(b.dataset.v===e.trend){b.classList.add('on');sg.tTrend=e.trend;}});}
  }else if(n==='insulina'){
    document.getElementById('eiI').value=e.id;document.getElementById('iU').value=e.units||'';fillTime('tI_t',e.ts);
    document.getElementById('iIT').value=e.insulinType||'';
    document.querySelectorAll('#pnlInsulina .sb').forEach(b=>{if(b.dataset.v===e.tipoIns){b.classList.add('on');sg.tI=e.tipoIns;}});
  }else if(n==='sport'){
    document.getElementById('eiSP').value=e.id;fillTime('tSP_t',e.ts);
    document.getElementById('iSportType').value=e.sportType||'';
    document.getElementById('iSportDur').value=e.duration||60;
    document.getElementById('iSportNote').value=e.note||'';
    updSportKcal();
  }else if(n==='alcool'){
    document.getElementById('eiA').value=e.id;fillTime('tA_t',e.ts);document.getElementById('iAQ').value=e.qty||1;
    document.querySelectorAll('#pnlAlcool .sb').forEach(b=>{if(b.dataset.v===e.alcType){b.classList.add('on');sg.tAlc=e.alcType;}});
    updAlcInfo();
  }
}
function pSeg(b,k){const p=b.closest('.seg,.trend-sel');if(p)p.querySelectorAll('.sb,.tsb').forEach(x=>x.classList.remove('on'));b.classList.add('on');sg[k]=b.dataset.v;}


// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: DAY BANNER NEI PANNELLI
// Se cd≠0 (non si sta inserendo per oggi), mostra un banner arancione
// in cima a ogni pannello con la data corrente: "⚠️ Stai aggiungendo per: …"
// Questo previene inserimenti accidentali su giorni sbagliati.
// ═══════════════════════════════════════════════════════════════
// per un giorno diverso da oggi (cd ≠ 0)
function showDayBanners(){
  ['Pasto','Spuntino','Glicemia','Insulina','Alcool','Sport'].forEach(n=>{
    const el=document.getElementById('dayBanner'+n);if(!el)return;
    if(cd!==0){
      el.classList.add('on');
      el.querySelector('.dbspan').innerHTML='⚠️ Stai aggiungendo per: <strong>'+getDF(cd)+'</strong>';
    }else{
      el.classList.remove('on');
    }
  });
}

// ── AUTOCOMPLETE ALIMENTI ──────────────────────────────────────────────────────
const _acTimers = {};

function showAC(v, lid, pre) {
  document.querySelectorAll('.ac.on').forEach(ac => { if (ac.id !== lid) ac.classList.remove('on'); });
  const l = document.getElementById(lid);
  if (!l) return;

  // Autocomplete insulina
  if (lid === 'acI') {
    if (!v || v.length < 1) { l.classList.remove('on'); return; }
    const res = getInst().filter(x => x.toLowerCase().includes(v.toLowerCase())).slice(0,5);
    if (!res.length) { l.classList.remove('on'); return; }
    l.innerHTML = res.map(x =>
      '<div class="aci" onclick="pickAC(' + JSON.stringify(x) + ',' + JSON.stringify(lid) + ')">' + x + '</div>'
    ).join('');
    l.classList.add('on');
    return;
  }

  // Autocomplete alimenti
  if (!v || v.length < 1) { l.classList.remove('on'); clearTimeout(_acTimers[lid]); return; }

  const db = ldDB();
  const q = v.toLowerCase().trim();
  const tokens = q.split(/\s+/).filter(t => t.length > 0);
  // Token significativi: lunghezza >= 3 (esclude "al", "in", "di", "e"...)
  const sig = tokens.filter(t => t.length >= 3);
  const match = sig.length > 0 ? sig : tokens;

  const scored = Object.keys(db).map(k => {
    const kl = k.toLowerCase();
    let score = 0;
    if (kl === q) score = 10;
    else if (kl.startsWith(q)) score = 7;
    else if (kl.includes(q)) score = 5;
    else {
      const n = match.filter(t => kl.includes(t)).length;
      if (n === match.length && match.length > 0) score = 3;
    }
    return { name: k, mac: db[k], score };
  }).filter(x => x.score > 0)
    .sort((a, b) => b.score - a.score)
    .slice(0, 7);

  const dbSet = new Set(Object.keys(db));
  const hist = getFoods()
    .filter(p => match.every(t => p.toLowerCase().includes(t)) && !dbSet.has(p))
    .slice(0, 2).map(p => ({ name: p, mac: null, score: 1 }));

  const res = [...scored, ...hist].slice(0, 7);

  const renderItem = (r, isOnline) => {
    const safe = r.name.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    let macHtml = '';
    if (r.mac) {
      const c = r.mac.c||0, p = r.mac.p||0, k = r.mac.k||0;
      const nota = r.mac.n ? ' <span class="aci-nota">(' + r.mac.n + ')</span>' : '';
      const src = isOnline ? ' <span class="aci-src">OFF</span>' : '';
      macHtml = '<span class="aci-mac"><span class="aci-c">C ' + c + 'g</span>' +
        '<span class="aci-unit">/100g</span>' +/*
        '<span class="aci-p"> P ' + p + 'g</span>' +
        '<span class="aci-k"> ' + k + 'kcal</span>' + src + */'</span>' /*+ nota;*/
    } else if (isOnline) {
      macHtml = '<span class="aci-mac"><span class="aci-src">OFF</span></span>';
    }
    const fn = isOnline ? 'pickAConline' : 'pickAC';
    const args = isOnline
      ? JSON.stringify(safe) + ',' + JSON.stringify(lid) + ',' + JSON.stringify(r.mac||null)
      : JSON.stringify(safe) + ',' + JSON.stringify(lid);
    return '<div class="aci" onclick="' + fn + '(' + args.replace(/"/g,'&quot;') + ')"><div class="aci-row"><span class="aci-name">' + r.name + '</span>' + macHtml + '</div></div>';
  };

  // Footer "ricerca approfondita" — usa &apos; perché lid/pre sono alfanumerici
  const footerHtml = '<div class="aci-footer" onclick="acDeepSearch(&apos;' + lid + '&apos;,&apos;' + (pre||'') + '&apos;)">&#x1F50D; Ricerca approfondita…</div>';

  l.innerHTML = res.map(r => renderItem(r, false)).join('') + footerHtml;
  l.classList.add('on');

  // Ricerca online automatica se pochi risultati locali (debounced)
  if (q.length >= 2 && res.length < 4) {
    clearTimeout(_acTimers[lid]);
    _acTimers[lid] = setTimeout(() => fetchAConline(v, lid, pre), res.length === 0 ? 600 : 1000);
  }
}

// function triggerAConline(v, lid, pre) {
//   const l = document.getElementById(lid);
//   if (l) {
//     const footer = l.querySelector('.aci-footer');
//     if (footer) footer.innerHTML = '&#x1F50D; Ricerca in corso…';
//     l.classList.add('on');
//   }
//   fetchAConline(v, lid, pre);
// }

function acDeepSearch(lid, pre) {
  document.querySelectorAll('.ac.on').forEach(a => a.classList.remove('on'));
  const m = lid.match(/^acFR([PS])(\d+)$/);
  if (!m) return;
  const rowPre = m[1], idx = parseInt(m[2]);
  const inputId = 'iF' + rowPre + idx;
  searchNutritionRow(inputId, rowPre, idx, null);
}

async function fetchAConline(v, lid, pre) {
  const l = document.getElementById(lid);
  if (!l) return;
  try {
    const url = 'https://world.openfoodfacts.org/cgi/search.pl?' +
      'search_terms=' + encodeURIComponent(v) +
      '&json=1&page_size=10&search_simple=1&action=process&lc=it' +
      '&fields=product_name,nutriments';
    const r = await fetch(url, { headers: { 'User-Agent': 'GlicoLog/1.0' } });
    if (!r.ok) throw new Error('net');
    const data = await r.json();

    const online = (data.products || []).filter(p => {
      const n = p.product_name || '';
      const nm = p.nutriments || {};
      return n.length > 1 && nm['carbohydrates_100g'] != null;
    }).slice(0, 5).map(p => {
      const nm = p.nutriments || {};
      const rnd = x => Math.round((x||0)*10)/10;
      return {
        name: (p.product_name||'').trim().substring(0,50),
        mac: {
          c: rnd(nm['carbohydrates_100g']),
          p: rnd(nm['proteins_100g']),
          g: rnd(nm['fat_100g']),
          f: rnd(nm['fiber_100g']),
          k: Math.round(nm['energy-kcal_100g'] || (nm['energy_100g']||0)/4.184)
        }
      };
    });

    const db = ldDB(), ql = v.toLowerCase();
    const sig2 = ql.split(/\s+/).filter(t => t.length >= 3);
    const mt = sig2.length > 0 ? sig2 : ql.split(/\s+/);
    const local = Object.keys(db)
      .filter(k => mt.every(t => k.toLowerCase().includes(t)))
      .slice(0, 3).map(k => ({ name: k, mac: db[k], isLocal: true }));

    const all = [...local, ...online].slice(0, 8);

    const renderOnline = (r, isLocal) => {
      const safe = r.name.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      let mh = '';
      if (r.mac) {
        const c = r.mac.c||0, p = r.mac.p||0, k = r.mac.k||0;
        const src = !isLocal ? ' <span class="aci-src">OFF</span>' : '';
        mh = '<span class="aci-mac"><span class="aci-c">C ' + c + 'g</span><span class="aci-unit">/100g</span><span class="aci-p"> P ' + p + 'g</span><span class="aci-k"> ' + k + 'kcal</span>' + src + '</span>';
      }
      const fn = isLocal ? 'pickAC' : 'pickAConline';
      const args = isLocal
        ? JSON.stringify(safe) + ',' + JSON.stringify(lid)
        : JSON.stringify(safe) + ',' + JSON.stringify(lid) + ',' + JSON.stringify(r.mac);
      return '<div class="aci" onclick="' + fn + '(' + args.replace(/"/g,'&quot;') + ')"><div class="aci-row"><span class="aci-name">' + r.name + '</span>' + mh + '</div></div>';
    };

    const footerHtml2 = '<div class="aci-footer" onclick="acDeepSearch(&apos;' + lid + '&apos;,&apos;' + (pre||'') + '&apos;)">&#x1F50D; Ricerca approfondita…</div>';

    if (!all.length) {
      l.innerHTML = '<div class="aci-spin">Nessun risultato — prova ricerca approfondita</div>' + footerHtml2;
    } else {
      l.innerHTML = all.map(r => renderOnline(r, !!r.isLocal)).join('') + footerHtml2;
    }
    l.classList.add('on');
  } catch (err) {
    // silenzioso — l'utente può usare ricerca approfondita
    const l2 = document.getElementById(lid);
    if (l2 && l2.classList.contains('on')) {
      const footer = l2.querySelector('.aci-footer');
      if (footer) footer.innerHTML = '&#x1F50D; Ricerca approfondita…';
    }
  }
}

// ═══ FOOD CONFIRM MODAL ═══
// Stato globale del modal di conferma
let _fcm = { name:'', lid:'', mac:null, isOnline:false };

function showFcm(name, lid, mac, isOnline) {
  _fcm = { name, lid, mac, isOnline };
  const db = ldDB();
  const food = mac || db[name] || db[name.toLowerCase()] || null;
  const isDrk = food ? !!food.isDrink : isDrinkName(name);
  const n = food && food.n ? food.n : (isDrk ? '200ml' : '100g');
  document.getElementById('fcmName').textContent = name;
  document.getElementById('fcmPortion').textContent = 'Porzione tipica: ' + n + ' · valori per 100' + (isDrk ? 'ml' : 'g');
  document.getElementById('fcmC').textContent = food ? (food.c||0)+'g' : '–';
  document.getElementById('fcmP').textContent = food ? (food.p||0)+'g' : '–';
  document.getElementById('fcmG').textContent = food ? (food.g||0)+'g' : '–';
  document.getElementById('fcmK').textContent = food ? (food.k||0)+'kcal' : '–';
  document.getElementById('fcmOverlay').classList.add('on');
}

function fcmCancel() {
  document.getElementById('fcmOverlay').classList.remove('on');
  // Riapri il dropdown
  const l = document.getElementById(_fcm.lid);
  if (l) l.classList.add('on');
}

function fcmConfirm() {
  document.getElementById('fcmOverlay').classList.remove('on');
  const { name, lid, mac, isOnline } = _fcm;
  // Chiudi dropdown definitivamente
  const l = document.getElementById(lid);
  if (l) l.classList.remove('on');
  // Applica la selezione
  if (isOnline) {
    _doPickAConline(name, lid, mac);
  } else {
    _doPickAC(name, lid);
  }
}

function pickAC(name, lid) {
  // Mostra modal di conferma invece di selezionare direttamente
  const l = document.getElementById(lid);
  if (l) l.classList.remove('on'); // nascondi dropdown temporaneamente
  showFcm(name, lid, null, false);
}

function _doPickAC(name, lid) {
  const m = lid.match(/^acFR([PS])(\d+)$/);
  if (m) {
    const inp = document.getElementById('iF' + m[1] + m[2]);
    if (inp) { inp.value = name; inp.dispatchEvent(new Event('change')); }
    const db = ldDB();
    const food = db[name] || db[name.toLowerCase()];
    if (food) {
      const rowId = 'fr' + m[1] + m[2];
      const row = document.getElementById(rowId);
      if (row) {
        row.dataset.c100 = food.c || 0;
        row.dataset.p100 = food.p || 0;
        row.dataset.g100 = food.g || 0;
        row.dataset.f100 = food.f || 0;
        row.dataset.isDrink = food.isDrink ? '1' : '';
        const unitEl = document.getElementById('fru' + m[1] + m[2]);
        if (unitEl) unitEl.textContent = food.isDrink ? 'ml' : 'g';
        // Imposta default grammi/ml dalla porzione tipica "n"
        const gramsEl = document.getElementById('frg' + m[1] + m[2]);
        if (gramsEl && !gramsEl.value) {
          if (food.n) {
            const parsed = parseFloat(food.n);
            if (!isNaN(parsed)) gramsEl.value = parsed;
          } else {
            gramsEl.value = food.isDrink ? '200' : '100';
          }
        }
      }
    }
    recalcAllRows(m[1]);
  }
}

function pickAConline(name, lid, mac) {
  const l = document.getElementById(lid);
  if (l) l.classList.remove('on');
  showFcm(name, lid, mac, true);
}

function _doPickAConline(name, lid, mac) {
  const m = lid.match(/^acFR([PS])(\d+)$/);
  if (!m) return;
  const inp = document.getElementById('iF' + m[1] + m[2]);
  if (inp) inp.value = name;
  const rowId = 'fr' + m[1] + m[2];
  const row = document.getElementById(rowId);
  if (row && mac) {
    row.dataset.c100 = mac.c || 0;
    row.dataset.p100 = mac.p || 0;
    row.dataset.g100 = mac.g || 0;
    row.dataset.f100 = mac.f || 0;
    row.dataset.isDrink = isDrinkName(name) ? '1' : '';
    const unitEl = document.getElementById('fru' + m[1] + m[2]);
    if (unitEl) unitEl.textContent = isDrinkName(name) ? 'ml' : 'g';
    const gramsEl = document.getElementById('frg' + m[1] + m[2]);
    if (gramsEl && !gramsEl.value) {
      if (mac.n) {
        const parsed = parseFloat(mac.n);
        if (!isNaN(parsed)) gramsEl.value = parsed;
      } else {
        gramsEl.value = isDrinkName(name) ? '200' : '100';
      }
    }
    learnFood(name, mac);
    recalcAllRows(m[1]);
  }
}



function searchNutritionRow(inputId, pre, idx, btn) {
  // Chiudi tutti i dropdown aperti
  document.querySelectorAll('.ac.on').forEach(a => a.classList.remove('on'));
  // Imposta contesto riga attiva
  nutState['activeInput'] = inputId;
  nutState['activeIdx'] = idx;
  nutState['callerBtn'+pre] = btn || null;
  // Feedback visivo sul pulsante
  if (btn) btn.classList.add('loading');
  // Avvia ricerca
  searchNutrition(inputId, pre).finally(() => {
    if (btn) btn.classList.remove('loading');
    // Scrolla ai risultati
    const resDiv = document.getElementById('nutRes' + pre);
    if (resDiv && resDiv.classList.contains('on')) {
      setTimeout(() => resDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
    }
  });
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: AUTOCOMPLETE ALIMENTI / INSULINA
// getFoods(): estrae tutti i nomi alimenti già usati dallo storico
// getInst():  estrae tutti i tipi insulina già usati dallo storico
//
// showAC(v, lid, pre):
//   - cerca v nel DB alimenti (prefisso) + nella lista storico personale
//   - mostra max 6 suggerimenti nella dropdown .ac con id=lid
//   - usa &apos; (non backslash) per quote sicure nell'onclick HTML
//   - per insulina: cerca solo in getInst()
//
// pickAC(v, lid):
//   - seleziona il suggerimento v dalla dropdown lid
//   - per food row (lid=acFRP1, acFRS2, ecc.): popola input + grammi di default
//     e salva dati per-100g nel dataset della riga per il ricalcolo macro
//   - per campo legacy (acF/acFS): popola anche i campi macro C/P/G/F
//
// prefillMacros(fid, pre):
//   - legge il nome dal primo input della food-rows-container
//   - cerca nel DB e popola i campi macro mPC/mPP/mPG/mPF (o S)
//   - fallback al campo legacy fid se food rows è vuota
//
// learnFood(name, c, p, g, f):
//   - aggiunge/aggiorna l'alimento nel DB personalizzato (localStorage)
//   - chiamata automaticamente ad ogni salvataggio pasto/spuntino
// ═══════════════════════════════════════════════════════════════
function getFoods(){const f=[];ld().forEach(e=>{if(e.food)e.food.toLowerCase().split(',').forEach(x=>{const t=x.trim();if(t&&!f.includes(t))f.push(t);});});return f;}

function getInst(){const t=[];ld().forEach(e=>{if(e.insulinType&&!t.includes(e.insulinType))t.push(e.insulinType);});return t;}

function prefillMacros(fid,pre){
  // fid is legacy ('iF' or 'iFS') — now food rows use 'iF'+pre+idx
  // Read from the first food row input that has a value
  const container=document.getElementById('foodRows'+pre);
  let food='';
  if(container){
    const inp=container.querySelector('input[type="text"]');
    if(inp) food=inp.value.trim().toLowerCase();
  }
  // fallback to legacy fid
  if(!food){
    const el=document.getElementById(fid);
    if(el) food=el.value.trim().toLowerCase();
  }
  if(!food){toast('Prima inserisci il nome del cibo');return;}
  const db=ldDB(),e=db[food];
  if(!e){toast('Cibo non trovato nel database');return;}
  document.getElementById('m'+pre+'C').value=e.c||'';document.getElementById('m'+pre+'P').value=e.p||'';
  document.getElementById('m'+pre+'G').value=e.g||'';document.getElementById('m'+pre+'F').value=e.f||'';
  toast('Caricate per "'+food+'"'+(e.n?' ('+e.n+')':''));
}
function learnFood(name,c,p,g,f){
  if(!name||(c==null&&p==null))return;
  const db=ldDB();db[name.toLowerCase()]={c:c||0,p:p||0,g:g||0,f:f||0,k:Math.round((c||0)*4+(p||0)*4+(g||0)*9)};svDB(db);
}


// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: HELPERS ORARIO
// setNow(id):    scrive HH:MM corrente nel campo <input type="time" id=id>
// initTime(id):  chiama setNow solo se il campo è ancora vuoto (non sovrascrive)
// getTs(timeId): legge HH:MM dal campo time e costruisce un timestamp ms
//                tenendo conto di cd (il giorno selezionato, non necessariamente oggi)
// fillTime(id, ts): popola il campo time da un timestamp esistente (usato in fillE)
// ═══════════════════════════════════════════════════════════════
// getTs()  = converte time field → timestamp ms (considera cd)
// fillTime() = popola campo time da timestamp esistente
function setNow(id){const n=new Date();document.getElementById(id).value=p2(n.getHours())+':'+p2(n.getMinutes());}
function initTime(id){const el=document.getElementById(id);if(el&&!el.value)setNow(id);}
function getTs(timeId){
  const el=document.getElementById(timeId);
  const d=new Date();d.setDate(d.getDate()+cd);
  if(!el||!el.value)return d.getTime();
  const[h,m]=el.value.split(':').map(Number);
  d.setHours(h,m,0,0);return d.getTime();
}
function fillTime(id,ts){const d=new Date(ts);const el=document.getElementById(id);if(el)el.value=p2(d.getHours())+':'+p2(d.getMinutes());}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: FUNZIONI DI SALVATAGGIO
// Pattern comune: leggi campi → valida → costruisci oggetto entry →
//   se eiP/eiS/eiG/eiI/eiA ha un ID → UPDATE (findIndex + assign)
//   altrimenti → INSERT (push con uid() generato)
//   → sv(data) → closePanel() → renderTL() + renderStrip()
//
// savePasto():   tipo pasto (Colazione/Pranzo/Cena) + food list (multi-row) +
//               glicemia PRE + trend + bolo PRE/POST + macro.
//               foodItems = array completo per ripopolare il panel in modifica.
//               learnFood() → aggiunge al DB personalizzato.
//
// saveSpunt():   come savePasto ma senza tipo obbligatorio.
//
// saveGlic():    valore numerico + momento + trend.
//               Dopo il salvataggio:
//               - checkAlerts(n): mostra banner se <70 o ≥200
//               - calcSuggestion(n, trend): calcola suggerimento
//               - se valore FUORI range E nuovo inserimento:
//                 showGlicCorrLow/High → popup correzione
//
// saveIns():    unità + tipo insulina + Bolo/Basale.
// saveAlc():    tipo bevanda + quantità → calcola unità alcoliche + kcal.
// updAlcInfo(): aggiorna preview kcal/unità nel pannello alcool.
// delE(hid):    elimina entry per ID (con confirm obsoleto, ora usa askDel).
// ═══════════════════════════════════════════════════════════════
function getV(id){return parseFloat(document.getElementById(id).value)||null;}
function savePasto(){
  const tipo=sg.tP;
  const foodList=getFoodList('P'); // array di {name,isDrink,grams,c100,p100,g100,f100}
  const foods=foodList; // backward compat
  const food=foodList.map(f=>f.name).join(', ');
  if(!tipo){toast('Seleziona il tipo di pasto');return;}
  if(!food.trim()){toast('Inserisci cosa hai mangiato');return;}
  const pre=getV('iPP'),boloPre=getV('iBP'),boloPost=getV('iBS');
  const carbs=getV('mPC'),protein=getV('mPP'),fat=getV('mPG'),fiber=getV('mPF');
  const trPRE=sg.tTrPRE||null;
  learnFood(food,carbs,protein,fat,fiber);
  const data=ld(),eid=document.getElementById('eiP').value;
  // foodItems: dati completi per riga (per ripopolare il panel in modifica)
  const foodItems=foodList.map(f=>({
    name:f.name, isDrink:f.isDrink,
    grams:f.grams, c100:f.c100, p100:f.p100, g100:f.g100, f100:f.f100,
    sugarCarbs:f.sugarCarbs||0
  }));
  const entry={tipo,food,foods,foodItems,pre,trPRE,boloPre,boloPost,carbs,protein,fat,fiber,ts:getTs('tP_t')};
  if(eid){const i=data.findIndex(e=>e.id===eid);if(i>-1)data[i]=Object.assign({},data[i],entry);}
  else data.push(Object.assign({id:uid(),type:'pasto',ts:getTs('tP_t')},entry));
  sv(data);closePanel();renderTL();renderStrip();renderNut();if(document.getElementById('stB').classList.contains('show'))drawChart();
  toast('\u2705 Pasto salvato');
}
function saveSpunt(){
  const foodList=getFoodList('S');
  const foods=foodList;
  const food=foodList.map(f=>f.name).join(', ');
  if(!food.trim()){toast('Inserisci cosa hai mangiato');return;}
  const boloPre=getV('iSBP'),boloPost=getV('iSBS');
  const carbs=getV('mSC'),protein=getV('mSP'),fat=getV('mSG'),fiber=getV('mSF');
  const trSPRE=sg.tTrSPRE||null;
  learnFood(food,carbs,protein,fat,fiber);
  const data=ld(),eid=document.getElementById('eiS').value;
  const foodItems=foodList.map(f=>({name:f.name,isDrink:f.isDrink,grams:f.grams,c100:f.c100,p100:f.p100,g100:f.g100,f100:f.f100,sugarCarbs:f.sugarCarbs||0}));
  const entry={food,foods,foodItems,pre:getV('iSP'),trSPRE,boloPre,boloPost,carbs,protein,fat,fiber,ts:getTs('tS_t')};
  if(eid){const i=data.findIndex(e=>e.id===eid);if(i>-1)data[i]=Object.assign({},data[i],entry);}
  else data.push(Object.assign({id:uid(),type:'spuntino',ts:getTs('tS_t')},entry));
  sv(data);closePanel();renderTL();renderStrip();renderNut();if(document.getElementById('stB').classList.contains('show'))drawChart();
  toast('\u2705 Spuntino salvato');
}
function saveGlic(){
  const v=document.getElementById('iG').value,mom=sg.tG||'Altro',trend=sg.tTrend||null;
  if(!v){toast('Inserisci il valore');return;}
  const n=parseInt(v),data=ld(),eid=document.getElementById('eiG').value;
  if(eid){const i=data.findIndex(e=>e.id===eid);if(i>-1)data[i]=Object.assign({},data[i],{value:n,momento:mom,trend,ts:getTs('tG')});}
  else data.push({id:uid(),type:'glicemia',value:n,momento:mom,trend,ts:getTs('tG')});
  sv(data);closePanel();renderTL();renderStrip();
  if(document.getElementById('stB').classList.contains('show'))drawChart();
  checkAlerts(n);calcSuggestion(n,trend);
  const lbl=n>200?'\uD83D\uDD34 ALTA!':n>160?'\uD83D\uDFE0 Elevata':n<70?'\uD83D\uDD35 BASSA!':n<100?'\u26A0\uFE0F Borderline':'\uD83D\uDFE2 Ok';
  toast(v+' mg/dL \u2014 '+lbl);
  // Popup correzione glicemia
  const cfg=ldC();
  if(!eid){ // solo per nuovi inserimenti, non per modifiche
    if(n < cfg.targetMin) showGlicCorrLow(n,cfg);
    else if(n > cfg.targetMax) showGlicCorrHigh(n,cfg);
  }
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: POPUP CORREZIONE GLICEMIA
// Dopo il salvataggio di una glicemia fuori range, appare un popup
// contestuale che suggerisce un'azione correttiva:
//   - Valore BASSO  (<targetMin) → _glicCorrMode='spuntino'
//                                  → "Aggiungi spuntino di correzione"
//   - Valore ALTO   (>targetMax) → _glicCorrMode='insulina'
//                                  → "Aggiungi bolo insulina correttivo"
//                                  → calcola dosi stimate: (val-targetMax)/FSI
//
// _glicCorrMode: variabile globale che ricorda l'azione scelta
//   IMPORTANTE: viene letta PRIMA di chiamare closeGlicCorr(),
//   perché closeGlicCorr() la azzera a null.
//
// showGlicCorrLow(n, cfg):  personalizza popup per ipoglicemia (blu)
// showGlicCorrHigh(n, cfg): personalizza popup per iperglicemia (rosso)
// closeGlicCorr():  nasconde il modal e azzera _glicCorrMode
// glicCorrAction(): esegue l'azione:
//   - salva mode in variabile locale prima di closeGlicCorr()
//   - apre pannello spuntino → nasconde campo glicemia PRE e trend
//     (già inserita, non serve reinserirla)
//   - apre pannello insulina
// prefillInsType(tipo): precompila il campo farmaco dal profilo utente
//   - Bolo   → cfg.insRapida (es. 'Humalog')
//   - Basale → cfg.insBasale
// ═══════════════════════════════════════════════════════════════
// Variabile per ricordare l'azione del popup
let _glicCorrMode = null; let _glicCorrCarbs = 15; let _glicCorrVal = 60;

function showGlicCorrLow(n, cfg) {
  _glicCorrMode = 'spuntino';
  const deficit = Math.max(0, cfg.targetMin - n);
  const carbsNeeded = Math.max(15, Math.round(deficit / 3));
  _glicCorrCarbs = carbsNeeded;
  _glicCorrVal = n;
  const card = document.getElementById('glicCorrCard');
  card.style.borderColor = 'rgba(255,82,82,.4)';
  document.getElementById('glicCorrIcon').textContent = '🚨';
  document.getElementById('glicCorrTitle').style.color = '#ff5252';
  document.getElementById('glicCorrTitle').textContent = 'Glicemia bassa — '+n+' mg/dL';
  document.getElementById('glicCorrMsg').innerHTML = 'Il valore è sotto il target (<strong>'+cfg.targetMin+' mg/dL</strong>). Si consiglia di assumere circa <strong>'+carbsNeeded+'g di carboidrati veloci</strong> (es. succo di frutta, glucosio, zucchero). Vuoi aggiungere uno spuntino di correzione?';
  const btn = document.getElementById('glicCorrYes');
  btn.textContent = '🍬 Aggiungi spuntino (+'+carbsNeeded+'g carbo)';
  btn.style.background = 'rgba(255,82,82,.15)';
  btn.style.border = '1px solid rgba(255,82,82,.4)';
  btn.style.color = '#ff5252';
  document.getElementById('glicCorrModal').style.display = 'flex';
}

function showGlicCorrHigh(n, cfg) {
  _glicCorrMode = 'insulina';
  const u = roundBoloForIns((n - cfg.targetMax) / cfg.fsi, cfg.insRapida);
  const card = document.getElementById('glicCorrCard');
  card.style.borderColor = 'rgba(255,82,82,.3)';
  document.getElementById('glicCorrIcon').textContent = '🔴';
  document.getElementById('glicCorrTitle').style.color = '#ff5252';
  document.getElementById('glicCorrTitle').textContent = 'Glicemia alta — '+n+' mg/dL';
  document.getElementById('glicCorrMsg').innerHTML = 'Il valore supera il target (<strong>'+cfg.targetMax+' mg/dL</strong>). Con FSI '+cfg.fsi+' potrebbe servire circa <strong>'+u+'U di insulina di correzione</strong>. Vuoi registrare un bolo correttivo?';
  const btn = document.getElementById('glicCorrYes');
  btn.textContent = '💉 Aggiungi bolo insulina';
  btn.style.background = 'rgba(255,82,82,.15)';
  btn.style.border = '1px solid rgba(255,82,82,.4)';
  btn.style.color = '#ff5252';
  document.getElementById('glicCorrModal').style.display = 'flex';
}

function closeGlicCorr() {
  document.getElementById('glicCorrModal').style.display = 'none';
  _glicCorrMode = null;
}

function glicCorrAction() {
  const mode = _glicCorrMode;
  const carbsN = _glicCorrCarbs || 15;
  const glicVal = _glicCorrVal || 60;
  closeGlicCorr();
  if (mode === 'spuntino') {
    openPanel('spuntino');
    const glicRow   = document.getElementById('spuntinoGlicRow');
    const trendRow  = document.getElementById('spuntinoTrendRow');
    const boloRow   = document.getElementById('spuntinoBoloRow');
    const ipoBox    = document.getElementById('ipoFixBox');
    if (glicRow)  glicRow.style.display  = 'none';
    if (trendRow) trendRow.style.display = 'none';
    if (boloRow)  boloRow.style.display  = 'none';
    if (ipoBox)   { ipoBox.style.display = 'block'; buildIpoFixBox(carbsN, glicVal); }
  }
  else if (mode === 'insulina') openPanel('insulina');
}

// IPO FIX BOX — alimenti standard per correzione ipoglicemia
// Ogni alimento ha: grammi/ml necessari per carbsNeeded g di carbo
function buildIpoFixBox(carbsNeeded, glicVal) {
  const cfg = ldC();
  // zuccheri semplici rapidi per correzione acuta
  const ipoItems = [
    { name:'Glucosio',   ico:'💊', c100:100, unit:'g',  note:'Più rapido in assoluto' },
    { name:'Zucchero',   ico:'🍬', c100:100, unit:'g',  note:'Saccarosio, effetto rapido' },
    { name:'Succo frutta', ico:'🧃', c100:10, unit:'ml', note:'Circa 200ml per 20g carbo' },
    { name:'Coca Cola',  ico:'🥤', c100:10.6,unit:'ml', note:'Lattina 330ml = 35g carbo' },
    { name:'Miele',      ico:'🍯', c100:80,  unit:'g',  note:'2-3 cucchiaini = ~15g' },
    { name:'Latte',      ico:'🥛', c100:4.8, unit:'ml', note:'Lattulosio + zuccheri semplici' },
    { name:'Fanta',      ico:'🍊', c100:10.8,unit:'ml', note:'Lattatina 330ml = 36g carbo' },
    { name:'Gatorade',   ico:'💧', c100:6,   unit:'ml', note:'Sali minerali + carbo' },
    { name:'Caramelle',  ico:'🍭', c100:95,  unit:'g',  note:'2-3 caramelle dure' },
  ];
  const grid = document.getElementById('ipoFixGrid');
  const note = document.getElementById('ipoFixNote');
  if (!grid) return;
  
  grid.innerHTML = ipoItems.map(item => {
    const qty = Math.round(carbsNeeded / item.c100 * 100);
    const qtyLabel = item.unit==='ml' ? qty+'ml' : qty+'g';
    return `<div class="ipofix-item" onclick="applyIpoFix('${item.name}',${qty},'${item.unit}')">
      <div class="ipofix-ico">${item.ico}</div>
      <div class="ipofix-name">${item.name}</div>
      <div class="ipofix-carbs">${qtyLabel}</div>
      <div class="ipofix-qty">≈${carbsNeeded}g carbo</div>
    </div>`;
  }).join('');
  
  const mid = Math.round((cfg.targetMin + cfg.targetMax) / 2);
  note.innerHTML = `Glicemia attuale: <strong style="color:#ff5252">${glicVal} mg/dL</strong> &nbsp;·&nbsp; `+
    `Carbo suggeriti: <strong style="color:#ff5252">${carbsNeeded}g</strong> &nbsp;·&nbsp; `+
    `Target: ${cfg.targetMin}–${cfg.targetMax} mg/dL<br>`+
    `<em>Ricontrolla la glicemia dopo 15 minuti. Scegli preferibilmente zuccheri semplici rapidi.</em>`;
}

function applyIpoFix(name, qty, unit) {
  // Precompila il campo alimento con la quantità suggerita
  const foodInput = document.querySelector('#foodRowsS input[type="text"]');
  const gramsInput = document.querySelector('#foodRowsS input[type="number"]');
  const unitEl = document.querySelector('#foodRowsS .fr-unit');
  const row = document.querySelector('#foodRowsS .food-row');
  if (foodInput) foodInput.value = name;
  if (gramsInput) gramsInput.value = qty;
  if (unitEl) unitEl.textContent = unit;
  if (row) {
    row.dataset.isDrink = unit==='ml' ? '1' : '';
    // Cerca nel DB i nutrienti
    const db = ldDB();
    const key = Object.keys(db).find(k => k.toLowerCase().includes(name.toLowerCase()));
    if (key) {
      const d = db[key];
      row.dataset.c100 = d.c||0;
      row.dataset.p100 = d.p||0;
      row.dataset.g100 = d.g||0;
      row.dataset.f100 = d.f||0;
    }
  }
  recalcAllRows('S');
  // Nascondi il box dopo la selezione
  const ipoBox = document.getElementById('ipoFixBox');
  if (ipoBox) ipoBox.style.display = 'none';
  // scroll giù per vedere il form
  const panel = document.getElementById('pnlSpuntino');
  if (panel) panel.scrollTo({top: panel.scrollHeight, behavior:'smooth'});
}
function prefillInsType(tipo) {
  const iitEl = document.getElementById('iIT');
  if (!iitEl) return;
  const cfg = ldC();
  if (tipo === 'Bolo') iitEl.value = cfg.insRapida || 'Humalog';
  else if (tipo === 'Basale') iitEl.value = cfg.insBasale || '';
}
function saveIns(){
  const u=document.getElementById('iU').value,it=document.getElementById('iIT').value.trim(),ti=sg.tI||'Bolo';
  if(!u){toast('Inserisci le unit\u00E0');return;}
  const data=ld(),eid=document.getElementById('eiI').value;
  if(eid){const i=data.findIndex(e=>e.id===eid);if(i>-1)data[i]=Object.assign({},data[i],{units:parseInt(u),insulinType:it||null,tipoIns:ti,ts:getTs('tI_t')});}
  else data.push({id:uid(),type:'insulina',units:parseInt(u),insulinType:it||null,tipoIns:ti,ts:getTs('tI_t')});
  sv(data);closePanel();renderTL();toast('\uD83D\uDC8A '+ti+' '+u+'U'+(it?' \u2014 '+it:''));
}
function updAlcInfo(){
  const t=sg.tAlc,a=ALCDB[t];if(!a)return;
  const qty=parseFloat(document.getElementById('iAQ').value)||1;
  document.getElementById('alcU').textContent=(a.u*qty).toFixed(1)+' U';
  document.getElementById('alcK').textContent=Math.round(a.k*qty)+' kcal';
  document.getElementById('alcInfoBox').style.display='block';
}
function saveAlc(){
  const t=sg.tAlc;if(!t){toast('Seleziona il tipo di bevanda');return;}
  const qty=parseFloat(document.getElementById('iAQ').value)||1,a=ALCDB[t]||{u:1,k:100,l:'Altro'};
  const units=Math.round(a.u*qty*10)/10,kcal=Math.round(a.k*qty);
  const data=ld(),eid=document.getElementById('eiA').value;
  if(eid){const i=data.findIndex(e=>e.id===eid);if(i>-1)data[i]=Object.assign({},data[i],{alcType:t,qty,units,kcal,label:a.l,ts:getTs('tA_t')});}
  else data.push({id:uid(),type:'alcool',alcType:t,qty,units,kcal,label:a.l,ts:getTs('tA_t')});
  sv(data);closePanel();renderTL();renderStrip();renderAlcWeek();
  const wu=getWeekAlc(),max=ldC().alcMax,rem=Math.max(0,max-wu);
  wu>max?toast('\u26A0\uFE0F Limite superato! '+wu.toFixed(1)+'/'+max+'U'):toast('\uD83C\uDF77 Salvato \u2014 '+rem.toFixed(1)+'U rimasti questa settimana');
}
function savePostM_disabled(){
  const v=document.getElementById('iPM').value,id=document.getElementById('pmid').value;
  if(!v){toast('Inserisci il valore');return;}
  const data=ld(),i=data.findIndex(e=>e.id===id);if(i>-1)data[i].post=parseInt(v);
  sv(data);closePanel();renderTL();renderStrip();toast('\u2705 POST salvata');
}
function delE(hid){
  const id=document.getElementById(hid).value;if(!id)return;
  if(!confirm('Eliminare questa voce?'))return;
  sv(ld().filter(e=>e.id!==id));closePanel();renderTL();renderStrip();renderNut();renderAlcWeek();toast('\uD83D\uDDD1\uFE0F Eliminato');
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: TRACKER ALCOOL SETTIMANALE
// getWeekAlc(): somma le unità alcoliche da lunedì della settimana corrente
//   fino ad oggi. Usa timestamp per confrontare con la mezzanotte di lunedì.
// renderAlcWeek(): aggiorna:
//   - #alcSub: testo "X.X unità questa settimana"
//   - #alcNums: "X.X/MAX U"
//   - #alcFill: barra progress (width = % del limite, .over se supera)
// ═══════════════════════════════════════════════════════════════
function getWeekAlc(){
  const now=new Date(),day=now.getDay(),s=new Date(now);
  s.setDate(now.getDate()-(day===0?6:day-1));s.setHours(0,0,0,0);
  return ld().filter(e=>e.type==='alcool'&&e.ts>=s.getTime()).reduce((a,e)=>a+(e.units||0),0);
}
function renderAlcWeek(){
  const cfg=ldC(),u=getWeekAlc(),pct=Math.min(100,(u/cfg.alcMax)*100);
  document.getElementById('alcSub').textContent=u.toFixed(1)+' U sett.';
  document.getElementById('alcNums').textContent=u.toFixed(1)+'/'+cfg.alcMax+'U';
  const f=document.getElementById('alcFill');f.style.width=pct+'%';f.classList.toggle('over',u>cfg.alcMax);
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: ALERT BANNER GLICEMIA
// checkAlerts(val): mostra un banner colorato quando si salva una glicemia:
//   - val ≥ 200 → banner rosso (#alertHigh) con il valore, si chiude dopo 12s
//   - val ≤ 70  → banner blu (#alertLow) pulsante (animation .low-alert),
//                  si chiude dopo 12s
// I due banner sono mutuamente esclusivi.
// ═══════════════════════════════════════════════════════════════
function checkAlerts(val){
  const hi=document.getElementById('alertHigh'),lo=document.getElementById('alertLow');
  hi.classList.remove('on');lo.classList.remove('on');
  if(val>=200){document.getElementById('alertHighVal').textContent=val+' mg/dL';hi.classList.add('on');setTimeout(()=>hi.classList.remove('on'),12000);}
  else if(val<=70){document.getElementById('alertLowVal').textContent=val+' mg/dL';lo.classList.add('on');setTimeout(()=>lo.classList.remove('on'),12000);}
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: MOTORE DI SUGGERIMENTO INSULINA/CARBO
// ⚠️  NON è prescrizione medica — solo supporto decisionale.
//     Mostrare sempre il disclaimer "consulta il medico".
//
// calcSuggestion(val, trend):
//   Analizza valore glicemia + freccia direzionale e produce un consiglio:
//
//   1. ALTA (val > targetMax):
//      - Calcola eccesso rispetto al mid-range: exc = val - mid
//      - Dosi correttive: u = (exc / FSI) × trend_modifier
//      - tmMap: ↑↑=0.65 (sale ancora→dose ridotta), ↑=0.8, →=1.0,
//               ↓=1.2 (scende→serve di più?), ↓↓=1.5
//      - Se ↓↓ e val<targetMax+40: "aspetta, stai già scendendo"
//
//   2. BASSA (val ≤ 70) — ipoglicemia:
//      - Calcola grammi carboidrati veloci: gc = ((def/50)*carbFactor) × tm
//      - Se val ≤ 55: alert emergenza
//      - Se ↓↓: aggiungere anche carbo lenti
//
//   3. TENDENZA BASSA (val in range ma ↓/↓↓):
//      - Suggerisce carbFactor g preventivi
//
//   4. TENDENZA ALTA (val in range ma ↑/↑↑):
//      - Suggerisce piccola correzione insulina
//
//   5. NEL RANGE: mostra percentuale del range e tendenza
//
// showSug(type, ico, title, main, detail):
//   Popola la card #sugCard e la rende visibile con scroll automatico.
// ═══════════════════════════════════════════════════════════════
//   - Dose insulina correttiva (eccesso ÷ FSI × trend modifier)
//   - Grammi carboidrati rapidi (per ipoglicemia)
// NON è prescrizione medica — solo supporto decisionale
function calcSuggestion(val,trend){
  const cfg=ldC(),{targetMin,targetMax,fsi,ic,carbFactor,insRapida}=cfg;
  const mid=Math.round((targetMin+targetMax)/2);
  const tmMap={'\u2191\u2191':0.65,'\u2191':0.8,'\u2192':1,'\u2193':1.2,'\u2193\u2193':1.5};
  const tm=tmMap[trend]||1;
  if(val>targetMax){
    if(trend==='\u2193\u2193'&&val<targetMax+40){showSug('sc-warn','\uD83D\uDCC9','Stai gi\u00E0 scendendo','Aspetta 15 min',val+' mg/dL in discesa rapida.\nNon correggere ora \u2014 monitora tra 15 minuti prima di fare insulina.');return;}
    const exc=val-mid;let u=Math.round((exc/fsi)*tm*2)/2;u=Math.max(0.5,u);
    let note='';
    if(trend==='\u2191\u2191')note='\n\u26A0\uFE0F Salita rapida: rivaluta tra 15 min se non si ferma.';
    else if(trend==='\u2193')note='\nStai gi\u00E0 scendendo \u2014 potrebbe servire meno.';
    showSug('sc-ins','\uD83D\uDC89',val>=200?'\u26A0\uFE0F Glicemia alta \u2014 correzione':'Glicemia elevata',
      u+'U di '+insRapida,
      val+' mg/dL \u2192 target '+mid+'\nEccesso: '+exc+' mg/dL \u00F7 FSI '+fsi+' = '+u+'U'+(trend?' ('+trend+')':'')+'\nSe mangi ora: 1U copre '+ic+'g di carbo.'+note);
  }else if(val<=70){
    const def=targetMin-val+20;let gc=Math.round(((def/50)*(carbFactor||15))*tm/5)*5;gc=Math.max(10,gc);
    let ex=val<=55?'\n\uD83D\uDEA8 Valore molto basso! Se hai sintomi chiedi aiuto.':'';
    if(trend==='\u2193\u2193')ex+='\nDiscesa rapida: aggiungi 15g carbo lenti (crackers) dopo quelli veloci.';
    showSug('sc-carb','\uD83C\uDF6C','\u26A0\uFE0F Ipoglicemia \u2014 agire subito',
      gc+'g di carboidrati veloci',
      val+' mg/dL \u2192 target '+targetMin+'\nDa recuperare: ~'+def+' mg/dL \u2192 '+gc+'g carbo rapidi\nEs: succo di frutta, zucchero, gel glucosio.'+ex+'\nRimisurati tra 15 minuti.');
  }else if(val<targetMin+15&&(trend==='\u2193'||trend==='\u2193\u2193')){
    const gc=carbFactor||15;
    showSug('sc-carb','\uD83C\uDF6C','Attenzione \u2014 tendenza al basso',gc+'g di carbo preventivi',val+' mg/dL nel range ma in discesa ('+trend+').\nConsidera '+gc+'g di carbo veloci per prevenire un\'ipoglicemia.');
  }else if(val>=targetMax-30&&(trend==='\u2191'||trend==='\u2191\u2191')){
    // Proponi aumento bolo solo se abbastanza vicino al limite superiore (entro 30 mg/dL)
    const margin=targetMax-val;
    const u=roundBoloForIns(Math.max(0.5,margin/fsi*0.6),insRapida);
    const urgNote=trend==='\u2191\u2191'?'\u26A0\uFE0F Salita rapida \u2014 monitora ogni 10-15 min.':'\u2139\uFE0F Ricontrolla tra 15-20 min prima di agire.';
    showSug('sc-ins','\uD83D\uDC89\u2197\uFE0F',trend==='\u2191\u2191'?'Salita rapida vicino al limite':'Attenzione \u2014 tendenza all\'alto',
      'Valuta aumento bolo: ~'+u+'U di '+insRapida,
      val+' mg/dL \u2192 tendenza '+trend+', ancora '+margin+' mg/dL al limite ('+targetMax+').\\nSe stai mangiando considera di aggiungere ~'+u+'U al bolo.\\n'+urgNote);
  }else if(val<targetMin){
    const def=targetMin-val,gc=Math.max(5,Math.round(def/5)*5);
    const tn=(trend==='\u2193'||trend==='\u2193\u2193')?' \u26A0\uFE0F Stai scendendo.':'';
    showSug('sc-carb','\uD83D\uDFE1','Sotto il tuo range target',val+' mg/dL (target min: '+targetMin+')','Sei '+def+' mg/dL sotto il tuo minimo personale ('+targetMin+' mg/dL).'+tn+'\nConsidra '+gc+'g di carboidrati per rientrare nel range.\n\u2139\uFE0F Rimisurati tra 15 min.');
  }else{
    const pct=Math.round(((val-targetMin)/(targetMax-targetMin))*100);
    showSug('sc-ok','\u2705','Nel range \u2014 ottimo!',val+' mg/dL','Target '+targetMin+'\u2013'+targetMax+' mg/dL \u00B7 '+(trend?'tendenza '+trend:'stabile')+'\nSei al '+pct+'% del range.');
  }
}
function showSug(type,ico,title,main,detail){
  const card=document.getElementById('sugCard');card.className='sug-card '+type;
  document.getElementById('sugIco').textContent=ico;document.getElementById('sugTitle').textContent=title;
  document.getElementById('sugMain').textContent=main;document.getElementById('sugDetail').textContent=detail;
  const w=document.getElementById('sugWrap');w.classList.add('on');
  setTimeout(()=>w.scrollIntoView({behavior:'smooth',block:'nearest'}),100);
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: NUTRIZIONE GIORNALIERA
// getTodayMacros(): somma carbo/proteine/grassi/fibre/kcal di tutti i pasti
//   e spuntini del giorno selezionato (getDK(cd)).
//   Include anche le kcal da alcool.
//   Calcola sportKcal = kcal bruciate durante sport (extra budget giornaliero).
//
// toggleNut(): apre/chiude la sezione con animazione freccia
//
// renderNut(): disegna le barre macro nel corpo della sezione:
//   - Kcal totali vs target (aumentato da sportKcal)
//   - 4 barre: Carboidrati / Proteine / Grassi / Fibre
//     - ok (verde):  85-110% del target
//     - warn (arancio): <85%
//     - over (rosso): >110%
//   - Suggerimenti contestuali (fibre basse, proteine basse, carbo al limite)
// ═══════════════════════════════════════════════════════════════
// e calcola % rispetto ai target personalizzati
function getTodayMacros(){
  const key=getDK(cd),t={carbs:0,protein:0,fat:0,fiber:0,kcal:0};
  ld().filter(e=>{const d=new Date(e.ts);return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key&&(e.type==='pasto'||e.type==='spuntino');}).forEach(e=>{t.carbs+=(e.carbs||0);t.protein+=(e.protein||0);t.fat+=(e.fat||0);t.fiber+=(e.fiber||0);t.kcal+=Math.round((e.carbs||0)*4+(e.protein||0)*4+(e.fat||0)*9);});
  ld().filter(e=>{const d=new Date(e.ts);return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key&&e.type==='alcool';}).forEach(e=>{t.kcal+=(e.kcal||0);});
  // Sport adds to daily kcal allowance (not consumed, but extra budget)
  const sportKcalExtra=ld().filter(e=>{const d=new Date(e.ts);return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key&&e.type==='sport';}).reduce((a,e)=>a+(e.kcal||0),0);
  t.sportKcal=sportKcalExtra;
  return t;
}
function toggleNut(){const t=document.getElementById('nutT'),b=document.getElementById('nutB');t.classList.toggle('open');b.classList.toggle('show');if(b.classList.contains('show'))renderNut();}
function renderNut(){
  const b=document.getElementById('nutB');if(!b.classList.contains('show'))return;
  const nl=document.getElementById('nutTLabel');
  if(nl)nl.textContent=(cd===0?'\uD83E\uDD57 Nutrizione di oggi':'\uD83E\uDD57 '+getDF(cd));
  const cfg=ldC(),tot=getTodayMacros();
  function bar(lbl,cur,tgt,unit){
    const pct=Math.min(100,Math.round((cur/tgt)*100)),cls=pct>110?'over':pct>85?'ok':'warn';
    const col=cls==='ok'?'var(--g)':cls==='over'?'var(--r)':'var(--o)';
    return '<div class="nb"><div class="nb-top"><span class="nb-name">'+lbl+'</span><span class="nb-val" style="color:'+col+'">'+Math.round(cur)+'<span style="font-size:.58rem;color:var(--txt2)">/'+tgt+unit+'</span></span></div><div class="nb-track"><div class="nb-fill '+cls+'" style="width:'+pct+'%"></div></div></div>';
  }
  const sportExtra=tot.sportKcal||0;const todayTarget=cfg.kcal+sportExtra;
  const kpct=Math.min(100,Math.round((tot.kcal/todayTarget)*100)),kcol=kpct>110?'var(--r)':kpct>85?'var(--g)':'var(--o)';
  const tips=[];
  if(tot.fiber<cfg.fiber*0.5&&tot.kcal>300)tips.push('\uD83E\uDD66 Fibre basse: aggiungi verdure o legumi');
  if(tot.protein<cfg.protein*0.4&&tot.kcal>400)tips.push('\uD83E\uDD69 Proteine basse: pollo, uova o yogurt greco');
  if(tot.carbs>cfg.carbs*0.9)tips.push('\u26A0\uFE0F Carbo quasi al limite: attenzione alle prossime porzioni');
  if(tot.carbs===0&&tot.protein===0)tips.push('\uD83D\uDCDD Inserisci i macronutrienti nei pasti per vedere le statistiche');
  const sportBadge=sportExtra?'<span style="font-size:.62rem;color:#29b6f6;margin-left:4px">+'+sportExtra+'kcal sport</span>':'';
  b.innerHTML='<div class="nut-kcal"><span class="nut-kcal-l">Calorie totali '+sportBadge+'</span><span class="nut-kcal-v" style="color:'+kcol+'">'+Math.round(tot.kcal)+'<span style="font-size:.7rem;color:var(--txt2)"> / '+todayTarget+' kcal</span></span></div><div class="nut-grid">'+bar('Carboidrati',tot.carbs,cfg.carbs,'g')+bar('Proteine',tot.protein,cfg.protein,'g')+bar('Grassi',tot.fat,cfg.fat,'g')+bar('Fibre',tot.fiber,cfg.fiber,'g')+'</div>'+(tips.length?'<div class="nut-tip"><strong>Suggerimenti di oggi</strong><br>'+tips.join('<br>')+'</div>':'');
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: PROFILO UTENTE
// loadProfileForm(): popola il pannello profilo con i valori correnti
//   da localStorage (ldC()), inclusi segmenti sesso/attività/obiettivo.
//
// calcMacros(age, sex, weight, height, activity, goal):
//   Formula BMR Mifflin-St Jeor:
//     M: 10×peso + 6.25×altezza - 5×età + 5
//     F: 10×peso + 6.25×altezza - 5×età - 161
//   TDEE = BMR × activity factor (1.2 sedentario … 1.9 molto attivo)
//   Calorie target: TDEE - deficit (loss:-550, gain:+300, maintain:0)
//   Macro: protein = 1.8-2.0g/kg; carbs calcolati al 42%; grassi dal resto.
//
// saveProfile(): legge i campi del form, chiama calcMacros, salva in ldC().
//   Aggiorna anche insRapida/insBasale (farmaci) e alcMax.
// ═══════════════════════════════════════════════════════════════
// Formula BMR: Mifflin-St Jeor; TDEE = BMR × activity factor
function loadProfileForm(){
  const c=ldC();
  ['cfgAge','cfgWeight','cfgHeight','cfgMin','cfgMax','cfgFsi','cfgIc','cfgAlcMax'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=c[id.replace('cfg','').toLowerCase()]||c[{cfgAge:'age',cfgWeight:'weight',cfgHeight:'height',cfgMin:'targetMin',cfgMax:'targetMax',cfgFsi:'fsi',cfgIc:'ic',cfgAlcMax:'alcMax'}[id]];});
  document.getElementById('cfgAge').value=c.age;document.getElementById('cfgWeight').value=c.weight;
  document.getElementById('cfgHeight').value=c.height;document.getElementById('cfgMin').value=c.targetMin;
  document.getElementById('cfgMax').value=c.targetMax;document.getElementById('cfgFsi').value=c.fsi;
  document.getElementById('cfgIc').value=c.ic;
  const insR=document.getElementById('cfgInsR');if(insR)insR.value=c.insRapida||'Humalog';
  const insB=document.getElementById('cfgInsB');if(insB)insB.value=c.insBasale||'';
  document.getElementById('cfgAlcMax').value=c.alcMax;
  document.querySelectorAll('#pnlProfilo .sb').forEach(b=>b.classList.remove('on'));
  document.querySelectorAll('#pnlProfilo .sb[data-v="'+c.sex+'"]').forEach(b=>{b.classList.add('on');});
  document.querySelectorAll('#pnlProfilo .sb[data-v="'+c.activity+'"]').forEach(b=>{b.classList.add('on');});
  document.querySelectorAll('#pnlProfilo .sb[data-v="'+c.goal+'"]').forEach(b=>{b.classList.add('on');});
  sg.cfgSex=c.sex;sg.cfgAct=String(c.activity);sg.cfgGoal=c.goal;
  // Aggiungi pulsante FS se non già presente
  setTimeout(_fsUpdateStatusUI, 100);
}
function calcMacros(age,sex,weight,height,activity,goal){
  const bmr=sex==='M'?(10*weight+6.25*height-5*age+5):(10*weight+6.25*height-5*age-161);
  const tdee=bmr*activity,deficit=goal==='loss'?550:goal==='gain'?-300:0;
  const kcal=Math.round(tdee-deficit),protein=Math.round((goal==='gain'?2.0:1.8)*weight);
  const carbs=goal==='loss'?130:Math.round((kcal*0.42)/4),fat=Math.round((kcal-protein*4-carbs*4)/9);
  return{kcal,protein,carbs:Math.max(100,carbs),fat:Math.max(40,fat),fiber:goal==='loss'?30:25};
}
function saveProfile(){
  const age=parseInt(document.getElementById('cfgAge').value)||32;
  const weight=parseFloat(document.getElementById('cfgWeight').value)||100;
  const height=parseInt(document.getElementById('cfgHeight').value)||174;
  const sex=sg.cfgSex||'M',activity=parseFloat(sg.cfgAct)||1.375,goal=sg.cfgGoal||'loss';
  const macros=calcMacros(age,sex,weight,height,activity,goal);
  const insREl=document.getElementById('cfgInsR');
  const insBEl=document.getElementById('cfgInsB');
  const cfg=Object.assign(ldC(),{
    age,weight,height,sex,activity,goal,
    targetMin:parseInt(document.getElementById('cfgMin').value)||100,
    targetMax:parseInt(document.getElementById('cfgMax').value)||160,
    fsi:parseInt(document.getElementById('cfgFsi').value)||30,
    ic:parseFloat(document.getElementById('cfgIc').value)||7,
    insRapida:insREl?insREl.value||'Humalog':'Humalog',
    insBasale:insBEl?insBEl.value||'':'',
    alcMax:parseInt(document.getElementById('cfgAlcMax').value)||5,
    ...macros
  });
  svC(cfg);closePanel();renderAlcWeek();
  toast('\u2705 Salvato \u2014 '+macros.kcal+'kcal \u00B7 '+macros.protein+'g prot \u00B7 '+macros.carbs+'g carbo');
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: STRIP CHIP RIEPILOGO GIORNALIERO
// Barra orizzontale scrollabile di chip con i dati del giorno selezionato:
//   Media glicemia | Picco | N. pasti | Insulina totale U |
//   Alcool settimanale | Sport kcal | Acqua ml
// gcls(v): restituisce classe CSS colore basata su range:
//   'bad' = <70 (ipoglicemia, blu), 'warn' = >200 (alta, arancio), 'ok' = in range
// fmtT(ts): formatta timestamp → 'HH:MM'
// ═══════════════════════════════════════════════════════════════
const fmtT=ts=>{const d=new Date(ts);return p2(d.getHours())+':'+p2(d.getMinutes());};
const gcls=(v)=>{if(!v)return'';const n=+v;return n<70?'bad':n>200?'warn':'ok';};
function renderStrip(){
  const key=getDK(cd);
  const today=ld().filter(e=>{const d=new Date(e.ts);return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key;});
  const vals=today.flatMap(e=>{const v=[];if(e.value)v.push(e.value);if(e.pre)v.push(+e.pre);return v;}).filter(Boolean);
  const avg=vals.length?Math.round(vals.reduce((a,b)=>a+b,0)/vals.length):null;
  const max=vals.length?Math.max(...vals):null;
  const meals=today.filter(e=>e.type==='pasto').length;
  const ins=today.filter(e=>e.type==='insulina').reduce((a,e)=>a+(e.units||0),0);
  const miss=today.filter(e=>(e.type==='pasto'||e.type==='spuntino')&&e.pre&&!e.post).length;
  const alcDay=today.filter(e=>e.type==='alcool').reduce((a,e)=>a+(e.units||0),0);
  const chips=[];
  if(avg!==null){const cl=avg>180?'bad':avg>140?'warn':'ok';chips.push('<div class="chip '+cl+'">Media <b>'+avg+'</b></div>');}
  if(max!==null){const cl=max>200?'bad':max>160?'warn':'ok';chips.push('<div class="chip '+cl+'">Picco <b>'+max+'</b></div>');}
  if(meals)chips.push('<div class="chip hi">Pasti <b>'+meals+'</b></div>');
  if(ins)chips.push('<div class="chip hi">Insulina <b>'+ins+'U</b></div>');
  if(alcDay)chips.push('<div class="chip warn">Alcool <b>'+alcDay.toFixed(1)+'U</b></div>');
  const sportDay=today.filter(e=>e.type==='sport').reduce((a,e)=>a+(e.kcal||0),0);
  if(sportDay)chips.push('<div class="chip" style="border-color:rgba(41,182,246,.3)">Sport <b style="color:#29b6f6">'+sportDay+'kcal</b></div>');

  // Chip acqua
  const wToday=getWaterToday?getWaterToday():0;
  if(wToday>0) chips.push('<div class="chip" onclick="openWaterModal()" style="cursor:pointer">💧 <b style="color:#29b6f6">'+wToday+'ml</b></div>');
  document.getElementById('strip').innerHTML=chips.join('')||'<div class="chip" style="font-size:.82rem;padding:9px 16px;color:var(--txt2);border-style:dashed;letter-spacing:.3px;width:100%;justify-content:center">📋 Nessun dato registrato per questo giorno</div>';
}



// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: ELIMINAZIONE + SWIPE-TO-DELETE
// askDel(id, label): mostra il dialog di conferma personalizzato
//   (#delConfirm) con il nome della voce da eliminare.
//   Collega il bottone "Sì, elimina" a deleteEntry(id).
//
// closeDelConfirm(): chiude il dialog e azzera _pendingDelId.
//
// deleteEntry(id): rimuove la voce dal localStorage e aggiorna
//   tutti i componenti visivi (TL, strip, summary, nut, alcWeek, stats).
//
// attachSwipeDelete(): applica il gesto swipe-left su ogni .tlc-wrap:
//   - touchstart: registra X/Y iniziali
//   - touchmove:  applica translateX alla card, mostra sfondo rosso cestino
//     dopo THRESHOLD=60px. Ignora swipe verticali (ddy>14px).
//   - touchend:   se dx≥THRESHOLD lascia la card aperta e collega click sul
//     fondo rosso → askDel. Altrimenti rimette a posto con animazione.
//   - tap fuori: chiude tutti gli swipe aperti.
//   _swipeAttached: flag per evitare listener duplicati alla ri-render.
// ═══════════════════════════════════════════════════════════════
// deleteEntry(id) - elimina dal localStorage
// attachSwipeDelete() - gestisce swipe sinistra su ogni card
let _pendingDelId = null;

function askDel(id, label) {
  _pendingDelId = id;
  const msg = document.getElementById('delConfirmMsg');
  if (msg) msg.innerHTML = 'Elimina <strong>' + esc(label) + '</strong>?';
  const btn = document.getElementById('delBtnYes');
  if (btn) btn.onclick = () => { deleteEntry(id); closeDelConfirm(); };
  document.getElementById('delConfirm').classList.add('on');
}

function closeDelConfirm() {
  document.getElementById('delConfirm').classList.remove('on');
  _pendingDelId = null;
}

function deleteEntry(id) {
  const data = ld().filter(e => e.id !== id);
  sv(data);
  renderTL(); renderStrip(); renderSummary(); renderNut(); renderAlcWeek();
  if (document.getElementById('stB')?.classList.contains('show')) renderStats();
  toast('🗑️ Voce eliminata');
}

function attachSwipeDelete() {
  document.querySelectorAll('.tlc-wrap').forEach(wrap => {
    if (wrap._swipeAttached) return;
    wrap._swipeAttached = true;
    let startX = 0, startY = 0, dx = 0, active = false;
    const card = wrap.querySelector('.tlc');
    const THRESHOLD = 60;

    wrap.addEventListener('touchstart', e => {
      if (e.touches.length > 1) return;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      dx = 0; active = true;
    }, { passive: true });

    wrap.addEventListener('touchmove', e => {
      if (!active) return;
      const ddx = startX - e.touches[0].clientX;
      const ddy = Math.abs(startY - e.touches[0].clientY);
      if (ddy > 14 && Math.abs(ddx) < ddy) { active = false; return; }
      if (ddx <= 0) { active = false; return; }
      dx = Math.min(ddx, 88);
      card.style.transform = 'translateX(-' + dx + 'px)';
      card.style.transition = 'none';
      wrap.classList.toggle('swiped', dx >= THRESHOLD);
    }, { passive: true });

    wrap.addEventListener('touchend', () => {
      if (!active) return; active = false;
      card.style.transition = 'transform .2s ease';
      if (dx >= THRESHOLD) {
        card.style.transform = 'translateX(-72px)';
        const bg = wrap.querySelector('.tlc-del-bg');
        if (bg && !bg._clickAttached) {
          bg._clickAttached = true;
          bg.addEventListener('click', () => {
            card.style.transform = '';
            wrap.classList.remove('swiped');
            askDel(wrap.dataset.eid, wrap.dataset.label || 'questa voce');
          });
        }
      } else {
        card.style.transform = '';
        wrap.classList.remove('swiped');
      }
      dx = 0;
    }, { passive: true });
  });

  // Tap fuori → chiudi tutti gli swipe aperti
  document.addEventListener('touchstart', e => {
    document.querySelectorAll('.tlc-wrap.swiped').forEach(wrap => {
      if (!wrap.contains(e.target)) {
        const card = wrap.querySelector('.tlc');
        if (card) { card.style.transition = 'transform .2s ease'; card.style.transform = ''; }
        wrap.classList.remove('swiped');
      }
    });
  }, { passive: true });
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: BOX RIEPILOGO STATISTICHE
// renderSummary(): costruisce 4 box informativi (sum-grid):
//
//   Box 1 — Glicemia oggi:
//     Media di glicemie + PRE pasti del giorno selezionato.
//     Color-coded: verde=in range, blu=sotto, rosso=sopra.
//
//   Box 2 — Media settimanale:
//     Media di tutte le glicemie dalla settimana corrente (lun→oggi).
//     Include conteggio misurazioni e media misurazioni/giorno.
//
//   Box 3 — Sport settimana (full width):
//     Numero sessioni, ore totali, kcal bruciate da lunedì.
//
//   Box 4 — Passi (full width):
//     Passi di oggi + km, passi settimana + km.
//     Pulsante "✏️ inserisci" → openStepsModal().
//     Usa getStepsForDay(key) e getWeekSteps() per i dati.
//
// gc(v): colore hex basato su targetMin/targetMax della config
// rangeLabel(v): etichetta testuale "✅ in range" | "⬆ sopra" | "⬇ sotto"
// ═══════════════════════════════════════════════════════════════
// numero misurazioni oggi + media settimanale,
// allenamenti settimana (count, ore totali, kcal totali)
function renderSummary() {
  const sec = document.getElementById('sumSec');
  if (!sec) return;
  const cfg = ldC();
  const allData = ld();

  // Giorno selezionato
  const keyToday = getDK(cd);
  const todayEntries = allData.filter(e => {
    const d = new Date(e.ts);
    return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate()) === keyToday;
  });

  // Glicemia del giorno: misurazioni dedicate + PRE dei pasti
  const glicToday = todayEntries.flatMap(e => {
    const v = [];
    if (e.type==='glicemia' && e.value) v.push(+e.value);
    if ((e.type==='pasto'||e.type==='spuntino') && e.pre) v.push(+e.pre);
    return v;
  }).filter(Boolean);
  const avgToday  = glicToday.length ? Math.round(glicToday.reduce((a,b)=>a+b,0)/glicToday.length) : null;
  const countToday = glicToday.length;

  // Settimana corrente (lunedì → oggi)
  const now = new Date();
  const dow = now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() - (dow===0 ? 6 : dow-1));
  monday.setHours(0,0,0,0);
  const weekEntries = allData.filter(e => e.ts >= monday.getTime());

  // Glicemia settimana
  const glicWeek = weekEntries.flatMap(e => {
    const v = [];
    if (e.type==='glicemia' && e.value) v.push(+e.value);
    if ((e.type==='pasto'||e.type==='spuntino') && e.pre) v.push(+e.pre);
    return v;
  }).filter(Boolean);
  const avgWeek = glicWeek.length ? Math.round(glicWeek.reduce((a,b)=>a+b,0)/glicWeek.length) : null;

  // Media misurazioni/giorno nella settimana
  const byDay = {};
  weekEntries.forEach(e => {
    const d = new Date(e.ts);
    const k = d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate());
    if (!byDay[k]) byDay[k]=0;
    if (e.type==='glicemia' && e.value) byDay[k]++;
    if ((e.type==='pasto'||e.type==='spuntino') && e.pre) byDay[k]++;
  });
  const activeDays = Object.values(byDay).filter(v=>v>0);
  const avgMisWeek = activeDays.length
    ? (Math.round(activeDays.reduce((a,b)=>a+b,0)/activeDays.length*10)/10)
    : null;

  // Sport settimana
  const sportWeek   = weekEntries.filter(e=>e.type==='sport');
  const sportCount   = sportWeek.length;
  const sportMinutes = sportWeek.reduce((a,e)=>a+(e.duration||0),0);
  const sportKcal    = sportWeek.reduce((a,e)=>a+(e.kcal||0),0);
  const sh = Math.floor(sportMinutes/60), sm = sportMinutes%60;
  const sportDurLbl  = sportMinutes>=60 ? sh+'h'+(sm?sm+'m':'') : (sportMinutes?sportMinutes+'m':'—');

  // Colore in base al range personale
  const gc = v => !v ? 'var(--txt)' : v>cfg.targetMax ? 'var(--r)' : v<cfg.targetMin ? 'var(--b)' : 'var(--g)';

  // Etichetta range
  const rangeLabel = v => {
    if (!v) return '';
    if (v > cfg.targetMax) return '<span style="color:var(--r)">&#x2B06; sopra range</span>';
    if (v < cfg.targetMin) return '<span style="color:var(--b)">&#x2B07; sotto range</span>';
    return '<span style="color:var(--g)">&#x2705; in range</span>';
  };

  sec.innerHTML =
    '<div class="sum-grid">' +

      // ── Box 1: glicemia oggi ──
      '<div class="sum-box glic">' +
        '<div class="sum-ico">&#x1F48A;</div>' +
        '<div style="display:flex;align-items:baseline;gap:3px">' +
          '<span class="sum-val" style="color:'+gc(avgToday)+'">'+(avgToday||'—')+'</span>' +
          (avgToday ? '<span class="sum-unit">mg/dL</span>' : '') +
        '</div>' +
        '<div class="sum-lbl">Glicemia oggi</div>' +
        '<div class="sum-sub">'+(countToday||0)+' misurazione'+(countToday!==1?'i':'')+
          (avgToday ? ' &middot; '+rangeLabel(avgToday) : '') +
        '</div>' +
      '</div>' +

      // ── Box 2: media settimanale ──
      '<div class="sum-box week">' +
        '<div class="sum-ico">&#x1F4C5;</div>' +
        '<div style="display:flex;align-items:baseline;gap:3px">' +
          '<span class="sum-val" style="color:'+gc(avgWeek)+'">'+(avgWeek||'—')+'</span>' +
          (avgWeek ? '<span class="sum-unit">mg/dL</span>' : '') +
        '</div>' +
        '<div class="sum-lbl">Media settimanale</div>' +
        '<div class="sum-sub">'+(glicWeek.length||0)+' mis. questa settimana' +
          (avgMisWeek ? '<br>~'+avgMisWeek+' mis./giorno' : '') +
        '</div>' +
      '</div>' +

      // ── Box 3: sport settimana — full width ──
      '<div class="sum-box sport sum-wide">' +
        '<div class="sum-lbl" style="margin-bottom:0">&#x1F3CB;&#xFE0F; Allenamenti questa settimana</div>' +
        '<div class="sum-sport-grid">' +
          '<div class="sum-sport-item">' +
            '<span class="sum-sport-v">'+(sportCount||'0')+'</span>' +
            '<span class="sum-sport-l">sessioni</span>' +
          '</div>' +
          '<div class="sum-sport-item">' +
            '<span class="sum-sport-v">'+(sportMinutes>0?sportDurLbl:'—')+'</span>' +
            '<span class="sum-sport-l">ore totali</span>' +
          '</div>' +
          '<div class="sum-sport-item">' +
            '<span class="sum-sport-v" style="color:var(--o)">'+(sportKcal>0?sportKcal:'—')+'</span>' +
            '<span class="sum-sport-l">kcal bruciate</span>' +
          '</div>' +
        '</div>' +
        (sportCount===0 ? '<div class="sum-sub" style="margin-top:6px;text-align:center">Nessun allenamento questa settimana</div>' : '') +
      '</div>' +

      // ── Box 4: passi oggi + settimana ──
      (function(){
        const todaySteps = getStepsForDay(getDK(cd));
        const wsteps = getWeekSteps();
        const wTotal = wsteps.reduce((a,s)=>a+s.steps,0);
        const wDays  = wsteps.length;
        const stride = todaySteps ? todaySteps.stride||75 : 75;
        const todayKm = todaySteps ? Math.round(todaySteps.steps*stride/100000*10)/10 : null;
        const weekStride = wsteps.length ? (wsteps.reduce((a,s)=>a+(s.stride||75),0)/wsteps.length) : 75;
        const weekKm = wTotal ? Math.round(wTotal*weekStride/100000*10)/10 : null;
        return '<div class="sum-box steps sum-wide">' +
          '<div style="display:flex;align-items:center;justify-content:space-between">' +
          '<div class="sum-lbl">\uD83D\uDC63 Passi</div>' +
          '<button onclick="openStepsModal()" style="background:none;border:1px solid var(--bdr);border-radius:7px;color:var(--txt2);font-size:.65rem;padding:3px 9px;cursor:pointer;">\u270F\uFE0F inserisci</button>' +
          '</div>' +
          '<div class="sum-sport-grid" style="margin-top:8px">' +
            '<div class="sum-sport-item">' +
              '<span class="sum-sport-v" style="color:var(--g)">'+(todaySteps?todaySteps.steps.toLocaleString('it'):'—')+'</span>' +
              '<span class="sum-sport-l">passi oggi</span>' +
            '</div>' +
            '<div class="sum-sport-item">' +
              '<span class="sum-sport-v" style="color:var(--g)">'+(todayKm!==null?todayKm+' km':'—')+'</span>' +
              '<span class="sum-sport-l">km oggi</span>' +
            '</div>' +
            '<div class="sum-sport-item">' +
              '<span class="sum-sport-v" style="color:var(--b)">'+(weekKm!==null?weekKm+' km':'—')+'</span>' +
              '<span class="sum-sport-l">'+(wTotal?wTotal.toLocaleString('it')+' passi·sett':'nessun dato')+'</span>' +
            '</div>' +
          '</div>' +
          (todaySteps?'':
            '<div class="sum-sub" style="margin-top:6px;text-align:center">Tocca ✏️ inserisci per aggiungere i passi di oggi</div>') +
        '</div>';
      })() +

    '</div>';
}


// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: TIMELINE
// renderTL(): genera la lista cronologica delle voci del giorno cd.
//   Filtra per data (getDK(cd)) e ordina per timestamp.
//
//   Per ogni voce e crea una card (.tli) con:
//   - Barra verticale sinistra (.tls) con orario + pallino colorato
//   - Wrapper swipe (.tlc-wrap) con dati per askDel (data-eid, data-label)
//   - Bottone cestino rosso (.tlc-del-bg) per swipe delete
//   - Card (.tlc) con contenuto specifico per tipo:
//
//     PASTO: tag Colazione/Pranzo/Cena (colori diversi tc/tp/tce)
//            + glicemia PRE grande con freccia trend a sinistra
//            + nome cibo (troncato 40 char) + kcal calcolate + macro chips a destra
//            ✂️ bottone modifica (apre panel) + bottone cestino
//
//     SPUNTINO: come pasto ma tag arancio "Spuntino"
//
//     GLICEMIA: tag azzurro "Glicemia · [momento]" (senza "Altro")
//               valore grande + freccia trend
//
//     INSULINA: tag viola con tipo (Bolo/Basale) + unità + nome farmaco
//
//     SPORT:    tag azzurro + nome attività + durata + kcal bruciate
//
//     ALCOOL:   tag arancio bruciato + nome bevanda × quantità + unità + kcal
//
//   dc: mappa tipo→colore per il pallino della barra verticale
//   trendMap: freccia→classe CSS colore (t-u2, t-u1, t-fl, t-d1, t-d2)
//   trendDisplay: freccia unicode → emoji direzionale visiva
//   es: serializzazione entry per passare a openPanel (oggetto JSON come stringa)
//
//   Dopo il render: requestAnimationFrame(attachSwipeDelete) per i gesti.
// ═══════════════════════════════════════════════════════════════
// Ogni card ha bottone modifica che riapre il panel precompilato
function renderTL(){
  renderSummary();
  const key=getDK(cd);
  const data=ld().filter(e=>{const d=new Date(e.ts);return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key;}).sort((a,b)=>a.ts-b.ts);
  const tl=document.getElementById('tl');
  if(!data.length){tl.innerHTML='<div class="tl-empty"><div class="ei">\uD83D\uDCCB</div>Nessuna voce per questo giorno</div>';return;}
  const dc={pasto:'var(--g)',spuntino:'var(--o)',glicemia:'var(--b)',insulina:'var(--p)',alcool:'var(--alc)',sport:'#29b6f6'};
  const trendMap={'↑↑':'t-u2','↑':'t-u1','→':'t-fl','↓':'t-d1','↓↓':'t-d2'};
  const trendDisplay={'↑↑':'⬆','↑':'↗','→':'→','↓':'↘','↓↓':'⬇'};
  tl.innerHTML=data.map((e,i)=>{
    const last=i===data.length-1;
    const miss=false; // POST non più obbligatoria
    const es=JSON.stringify(e).replace(/"/g,"'");
    let card='';
    if(e.type==='pasto'){
      const tg={Colazione:'tc',Pranzo:'tp',Cena:'tce'}[e.tipo]||'tc';
      const kcal = e.carbs||e.protein||e.fat ? Math.round((e.carbs||0)*4+(e.protein||0)*4+(e.fat||0)*9) : null;
      const foodShort = (e.food||'').substring(0,40);
      const nm='<div class="nchips">'+(e.carbs?'<span class="nchip">'+e.carbs+'g C</span>':'')+(e.protein?'<span class="nchip">'+e.protein+'g P</span>':'')+(e.fat?'<span class="nchip">'+e.fat+'g G</span>':'')+(e.fiber?'<span class="nchip">'+e.fiber+'g F</span>':'')+(e.boloPre?'<span class="nchip" style="background:rgba(206,147,216,.15);color:var(--p)">💉'+e.boloPre+'U</span>':'')+'</div>';
      const preBlock = e.pre ? '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap"><span class="tv big '+gcls(e.pre)+'" style="font-size:1.3rem;font-weight:700;line-height:1">'+e.pre+'</span><span style="font-size:.6rem;color:var(--txt2)">mg/dL</span>'+(e.trPRE?'<span class="tsb '+trendMap[e.trPRE]+'" style="font-size:.8rem;padding:1px 6px;border-radius:4px;background:var(--card2)">'+(trendDisplay[e.trPRE]||e.trPRE)+'</span>':'')+'</div>' : '';
      const rightBlock = '<div style="flex:1;min-width:0">'+(foodShort?'<div style="font-size:.78rem;color:var(--txt3);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+foodShort+'</div>':'')+(kcal?'<div style="font-size:.68rem;color:var(--o);margin-bottom:3px">'+kcal+' kcal</div>':'')+nm+'</div>';
      card='<div class="tlr1"><span class="tag '+tg+'">'+(e.tipo||'Pasto')+'</span><div style="display:flex;gap:2px"><button class="teb" onclick="event.stopPropagation();openPanel(\'pasto\','+es+')">&#x270F;&#xFE0F;</button><button class="teb-del" onclick="event.stopPropagation();askDel(\''+e.id+'\',\''+esc((e.food||'Pasto').substring(0,30))+'\')" title="Elimina">&#x1F5D1;</button></div></div><div style="display:flex;gap:10px;align-items:flex-start;margin-top:4px">'+(e.pre?'<div style="flex-shrink:0;min-width:52px">'+preBlock+'</div>':'')+''+rightBlock+'</div>';
    }else if(e.type==='spuntino'){
      const kcal = e.carbs||e.protein||e.fat ? Math.round((e.carbs||0)*4+(e.protein||0)*4+(e.fat||0)*9) : null;
      const foodShort = (e.food||'').substring(0,40);
      const nm='<div class="nchips">'+(e.carbs?'<span class="nchip">'+e.carbs+'g C</span>':'')+(e.protein?'<span class="nchip">'+e.protein+'g P</span>':'')+(e.fat?'<span class="nchip">'+e.fat+'g G</span>':'')+(e.fiber?'<span class="nchip">'+e.fiber+'g F</span>':'')+(e.boloPre?'<span class="nchip" style="background:rgba(206,147,216,.15);color:var(--p)">💉'+e.boloPre+'U</span>':'')+'</div>';
      const preBlock = e.pre ? '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap"><span class="tv big '+gcls(e.pre)+'" style="font-size:1.3rem;font-weight:700;line-height:1">'+e.pre+'</span><span style="font-size:.6rem;color:var(--txt2)">mg/dL</span>'+(e.trSPRE?'<span class="tsb '+trendMap[e.trSPRE]+'" style="font-size:.8rem;padding:1px 6px;border-radius:4px;background:var(--card2)">'+(trendDisplay[e.trSPRE]||e.trSPRE)+'</span>':'')+'</div>' : '';
      const rightBlock = '<div style="flex:1;min-width:0">'+(foodShort?'<div style="font-size:.78rem;color:var(--txt3);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+foodShort+'</div>':'')+(kcal?'<div style="font-size:.68rem;color:var(--o);margin-bottom:3px">'+kcal+' kcal</div>':'')+nm+'</div>';
      card='<div class="tlr1"><span class="tag ts2">Spuntino</span><div style="display:flex;gap:2px"><button class="teb" onclick="event.stopPropagation();openPanel(\'spuntino\','+es+')">&#x270F;&#xFE0F;</button><button class="teb-del" onclick="event.stopPropagation();askDel(\''+e.id+'\',\''+esc((e.food||'Spuntino').substring(0,30))+'\')" title="Elimina">&#x1F5D1;</button></div></div><div style="display:flex;gap:10px;align-items:flex-start;margin-top:4px">'+(e.pre?'<div style="flex-shrink:0;min-width:52px">'+preBlock+'</div>':'')+''+rightBlock+'</div>';
    }else if(e.type==='glicemia'){
      const cl=gcls(e.value),tc2=e.trend?trendMap[e.trend]||'':'';
      card='<div class="tlr1"><span class="tag tg">Glicemia'+(e.momento&&e.momento!=='Altro'?' \u00B7 '+e.momento:'')+'</span><div style="display:flex;gap:2px"><button class="teb" onclick="event.stopPropagation();openPanel(\'glicemia\','+es+')">&#x270F;&#xFE0F;</button><button class="teb-del" onclick="event.stopPropagation();askDel(\''+e.id+'\',\'Glicemia '+e.value+' mg/dL\')" title="Elimina">&#x1F5D1;</button></div></div><div class="tvs"><span class="tv big '+cl+'">'+(e.value)+' mg/dL</span>'+(e.trend?'<span class="tsb '+tc2+'" style="font-size:.9rem;padding:1px 8px;border-radius:5px;background:var(--card2)">'+(trendDisplay[e.trend]||e.trend)+'</span>':'')+'</div>';
    }else if(e.type==='insulina'){
      card='<div class="tlr1"><span class="tag ti">'+(e.tipoIns||'Insulina')+'</span><div style="display:flex;gap:2px"><button class="teb" onclick="event.stopPropagation();openPanel(\'insulina\','+es+')">&#x270F;&#xFE0F;</button><button class="teb-del" onclick="event.stopPropagation();askDel(\''+e.id+'\',\'Insulina '+e.units+'U\')" title="Elimina">&#x1F5D1;</button></div></div><div class="tvs"><span class="tv ins">'+e.units+'U</span>'+(e.insulinType?'<span class="tv" style="color:var(--txt2)">'+e.insulinType+'</span>':'')+'</div>';
    }else if(e.type==='sport'){
      const durLbl=e.duration>=60?Math.floor(e.duration/60)+'h'+(e.duration%60?e.duration%60+'m':''):e.duration+'min';
      card='<div class="tlr1"><span class="tag tsp">Sport</span><div style="display:flex;gap:2px"><button class="teb" onclick="event.stopPropagation();openPanel(\'sport\','+es+')">&#x270F;&#xFE0F;</button><button class="teb-del" onclick="event.stopPropagation();askDel(\''+e.id+'\',(e.label||e.sportName||\'Sport\'))" title="Elimina">&#x1F5D1;</button></div></div><div class="tl-food">'+(e.label||e.sportName||'Sport')+(e.note?' · '+e.note:'')+'</div><div class="tvs"><span class="tv sport">'+durLbl+'</span><span class="tv" style="color:var(--o)">'+e.kcal+' kcal bruciate</span></div>';
    }else if(e.type==='alcool'){
      card='<div class="tlr1"><span class="tag ta">Alcool</span><div style="display:flex;gap:2px"><button class="teb" onclick="event.stopPropagation();openPanel(\'alcool\','+es+')">&#x270F;&#xFE0F;</button><button class="teb-del" onclick="event.stopPropagation();askDel(\''+e.id+'\',(e.label||e.alcType||\'Alcool\'))" title="Elimina">&#x1F5D1;&#xFE0F;</button></div></div><div class="tvs"><span class="tv alc">'+(e.label||e.alcType)+(e.qty>1?' \u00D7'+e.qty:'')+'</span><span class="tv alc">'+e.units+'U</span><span class="tv" style="color:var(--o)">'+e.kcal+'kcal</span></div>';
    }
    const click='';
    return'<div class="tli"><div class="tls"><div class="tl-t">'+fmtT(e.ts)+'</div><div class="tl-d" style="background:'+(dc[e.type]||'#666')+'"></div>'+(!last?'<div class="tl-v"></div>':'')+'</div><div class="tlc-wrap" data-eid="'+e.id+'" data-label="'+esc(e.food||e.value||e.tipo||e.tipoIns||e.label||e.alcType||e.sportName||e.type||'voce').substring(0,30)+'"><div class="tlc-del-bg">&#x1F5D1;&#xFE0F;</div><div class="tlc" '+click+'>'+card+'</div></div></div>';
  }).join('');
  requestAnimationFrame(attachSwipeDelete);
  // Attach swipe-to-delete gesture on every card
  requestAnimationFrame(attachSwipeDelete);
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: STATISTICHE E GRAFICO
// toggleStats(): apre/chiude sezione con animazione
//
// renderStats(): popola #sgrid con media glicemia PRE per tipo pasto
//   (Colazione / Pranzo / Cena) colorata per range.
//
// switchChart(m, btn): cambia tab attiva e ridisegna il grafico
// drawChart(): dispatcher → drawDayChart() o drawPeriodChart(7/30)
//
// drawDayChart():
//   Grafico intraday su canvas #cv (height 110px, DPI-aware):
//   - Zone colorate sfondo: rosso >200, blu <70
//   - Linee orizzontali tratteggiate per 70/targetMin/targetMax/200
//   - Area fill gradiente verde sotto la curva
//   - Segmenti colorati: azzurro <70, verde in range, arancio >targetMax, rosso >200
//   - Punti cerchi colorati + orari sull'asse X
//   - Tooltip interattivo al click sul canvas (_pts array)
//   Fonti dati: glicemia dirette + PRE da pasti/spuntini
//
// drawPeriodChart(days):
//   Grafico period (7gg o 30gg) — media giornaliera per ogni giorno:
//   - Un punto per giorno (null = nessun dato)
//   - Label date sull'asse X (ogni 5 gg per 30gg, tutti per 7gg)
//   - Stessi segmenti colorati + valore sopra ogni punto
//   - Area fill gradiente
// ═══════════════════════════════════════════════════════════════ (Colazione/Pranzo/Cena)
// drawDayChart: grafico intraday con segmenti colorati
// drawPeriodChart: media giornaliera su 7 o 30 giorni
function toggleStats(){const t=document.getElementById('stT'),b=document.getElementById('stB');t.classList.toggle('open');b.classList.toggle('show');if(b.classList.contains('show'))renderStats();}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: RIEPILOGO MENSILE
// Sezione collassabile che mostra un'overview dell'intero mese.
//
// Stato globale:
//   _curMonth     → mese corrente visualizzato (0-11)
//   _curMonthYear → anno corrente visualizzato
//
// toggleMonthly(): apre/chiude la sezione, chiama renderMonthly()
// chMonth(dir):    naviga ±1 mese con wrap automatico (dic→gen, gen→dic)
//
// renderMonthly():
//   1. Titolo navigazione: "← Gennaio 2026 →"
//   2. Stat boxes (4 in griglia):
//      Media mensile mg/dL | Giorni con dati | Episodi bassi | Episodi alti
//   3. Intestazioni settimana (L M M G V S D)
//   4. Griglia calendario 7 colonne:
//      - Celle vuote per sfalsamento primo giorno (firstDow = giorno settimana del 1°)
//      - Ogni cella: numero giorno + media glicemia colorata + badge ▼/▲ eventi
//        + barra colorata bottom proporzionale al valore (40-350mg/dL)
//      - Celle cliccabili: onclick="goToDay(year, month+1, d)"
//   5. Grafico canvas mensile:
//      - Zona target verde, linee tratteggiate targetMin/targetMax
//      - Area fill gradiente, curva color-coded per range
//      - Punti + numeri giorno sull'asse X
//      - Solo giorni con dati vengono plottati
//
// goToDay(y, m, d):
//   Calcola l'offset cd = (target - today) / 86400000
//   poi salta alla timeline di quel giorno con scroll automatico.
//   FIX rispetto a versioni precedenti: cd è un intero offset,
//   NON un oggetto Date (quella causava il bug "undefined NaN").
// ═══════════════════════════════════════════════════════════════
let _curMonth = new Date().getMonth();
let _curMonthYear = new Date().getFullYear();

function toggleMonthly(){
  const t=document.getElementById('monthlyT'),b=document.getElementById('monthlyB');
  t.classList.toggle('open');b.classList.toggle('show');
  if(b.classList.contains('show')) renderMonthly();
}
function chMonth(dir){
  _curMonth+=dir;
  if(_curMonth>11){_curMonth=0;_curMonthYear++;}
  if(_curMonth<0){_curMonth=11;_curMonthYear--;}
  renderMonthly();
}
function renderMonthly(){
  const MESI=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  const GMESI=['L','M','M','G','V','S','D'];
  document.getElementById('monthlyTitle').textContent = MESI[_curMonth]+' '+_curMonthYear;
  const cfg=ldC();
  const data=ld();
  const year=_curMonthYear, month=_curMonth;

  // Calcola dati per ogni giorno del mese
  const daysInMonth = new Date(year,month+1,0).getDate();
  const dayData = {};
  for(let d=1;d<=daysInMonth;d++){
    const k=year+'-'+p2(month+1)+'-'+p2(d);
    const entries=data.filter(e=>{
      const dd=new Date(e.ts);
      return dd.getFullYear()===year&&dd.getMonth()===month&&dd.getDate()===d;
    });
    if(!entries.length){dayData[d]=null;continue;}
    const vals=entries.flatMap(e=>{
      const v=[];
      if(e.type==='glicemia'&&e.value)v.push(+e.value);
      if((e.type==='pasto'||e.type==='spuntino')&&e.pre)v.push(+e.pre);
      return v;
    }).filter(Boolean);
    const lowEvts=entries.filter(e=>(e.type==='glicemia'&&e.value<cfg.targetMin)||((e.type==='pasto'||e.type==='spuntino')&&e.pre&&+e.pre<cfg.targetMin)).length;
    const highEvts=entries.filter(e=>(e.type==='glicemia'&&e.value>cfg.targetMax)||((e.type==='pasto'||e.type==='spuntino')&&e.pre&&+e.pre>cfg.targetMax)).length;
    dayData[d]=vals.length?{avg:Math.round(vals.reduce((a,b)=>a+b)/vals.length),low:lowEvts,high:highEvts,count:vals.length}:null;
  }

  // Stat boxes mensili
  const allVals=Object.values(dayData).filter(Boolean).flatMap(d=>[d.avg]);
  const monthAvg=allVals.length?Math.round(allVals.reduce((a,b)=>a+b)/allVals.length):null;
  const totalLow=Object.values(dayData).filter(Boolean).reduce((s,d)=>s+d.low,0);
  const totalHigh=Object.values(dayData).filter(Boolean).reduce((s,d)=>s+d.high,0);
  const daysWithData=Object.values(dayData).filter(Boolean).length;
  const statsHtml=[
    {val:monthAvg?monthAvg+' mg/dL':'—', lbl:'Media mese',
     color: monthAvg ? (monthAvg<cfg.targetMin?'#ff5252':monthAvg>cfg.targetMax?'#ffab40':'#00e676') : 'var(--txt2)'},
    {val:daysWithData+'gg', lbl:'Giorni attivi', color:'var(--txt)'},
    {val:totalLow||'0', lbl:'Episodi bassi', color:'#ff5252'},
    {val:totalHigh||'0', lbl:'Episodi alti', color:'#ffab40'},
  ].map(s=>`<div style="background:var(--card);border:1px solid var(--bdr);border-radius:8px;padding:9px 6px;text-align:center">
    <div style="font-size:.9rem;font-weight:700;font-family:var(--mono);line-height:1;color:${s.color}">${s.val}</div>
    <div style="font-size:.58rem;color:var(--txt2);margin-top:3px;font-family:var(--sans)">${s.lbl}</div>
  </div>`).join('');
  document.getElementById('monthlyStats').innerHTML=statsHtml;

  // Intestazioni giorni settimana (Lun…Dom)
  document.getElementById('monthlyDayLabels').innerHTML=GMESI.map(g=>`<div class="mcal-wkday">${g}</div>`).join('');

  // Griglia calendario
  const firstDow=(new Date(year,month,1).getDay()+6)%7; // 0=Lun
  let gridHtml='';
  for(let i=0;i<firstDow;i++) gridHtml+='<div class="mcal-day empty"></div>';
  for(let d=1;d<=daysInMonth;d++){
    const dd=dayData[d];
    if(!dd){
      gridHtml+=`<div class="mcal-day"><div class="mcal-dn">${d}</div></div>`;
    } else {
      const cl=gcls(dd.avg);
      const avgColor = dd.avg<cfg.targetMin?'#ff5252':dd.avg>cfg.targetMax?'#ffab40':'#00e676';
      const barColor=avgColor;
      const pct=Math.min(100,Math.max(5,((dd.avg-40)/(350-40))*100));
      gridHtml+=`<div class="mcal-day" onclick="goToDay(${year},${month+1},${d})">
        <div class="mcal-dn">${d}</div>
        <div class="mcal-avg" style="color:${avgColor}">${dd.avg}</div>
        <div class="mcal-badges">${dd.low>0?`<span class="mcal-badge mcal-low">▼${dd.low}</span>`:''}${dd.high>0?`<span class="mcal-badge mcal-high">▲${dd.high}</span>`:''}</div>
        <div class="mcal-bar" style="background:${avgColor};width:${pct}%"></div>
      </div>`;
    }
  }
  document.getElementById('monthlyGrid').innerHTML=gridHtml;

  // Grafico mensile linea media giornaliera
  const canvas=document.getElementById('monthlyChart');
  if(!canvas)return;
  canvas.width=canvas.offsetWidth*2||600;
  const ctx=canvas.getContext('2d');
  const cw=canvas.width,ch=canvas.height;
  ctx.clearRect(0,0,cw,ch);
  ctx.fillStyle='#0d1117';ctx.fillRect(0,0,cw,ch);
  const pts=[];
  for(let d=1;d<=daysInMonth;d++) if(dayData[d]) pts.push({d,avg:dayData[d].avg});
  if(pts.length<2){
    ctx.fillStyle='#2a3a4a';ctx.font='24px sans-serif';ctx.textAlign='center';
    ctx.fillText('Nessun dato',cw/2,ch/2);return;
  }
  const PL=28,PR=8,PT=10,PB=20,pw=cw-PL-PR,ph=ch-PT-PB;
  const minV=50,maxV=Math.max(250,...pts.map(p=>p.avg))+20;
  const toX=d=>PL+((d-1)/(daysInMonth-1))*pw;
  const toY=v=>PT+ph-((v-minV)/(maxV-minV))*ph;
  // zona target
  ctx.fillStyle='rgba(0,230,118,0.07)';
  ctx.fillRect(PL,toY(cfg.targetMax),pw,toY(cfg.targetMin)-toY(cfg.targetMax));
  // linee orizzontali
  [cfg.targetMin,cfg.targetMax].forEach(v=>{
    ctx.strokeStyle=v===cfg.targetMin?'rgba(64,196,255,.25)':'rgba(255,171,64,.25)';
    ctx.lineWidth=1;ctx.setLineDash([3,5]);
    ctx.beginPath();ctx.moveTo(PL,toY(v));ctx.lineTo(cw-PR,toY(v));ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='bold 18px monospace';ctx.textAlign='left';
    ctx.fillText(v,0,toY(v)+6);
  });
  // area sotto la curva
  ctx.beginPath();ctx.moveTo(toX(pts[0].d),ch-PB);
  pts.forEach(p=>ctx.lineTo(toX(p.d),toY(p.avg)));
  ctx.lineTo(toX(pts[pts.length-1].d),ch-PB);ctx.closePath();
  const gr=ctx.createLinearGradient(0,PT,0,ch-PB);
  gr.addColorStop(0,'rgba(0,230,118,.15)');gr.addColorStop(1,'rgba(0,230,118,0)');
  ctx.fillStyle=gr;ctx.fill();
  // linea
  for(let i=0;i<pts.length-1;i++){
    const mid=(pts[i].avg+pts[i+1].avg)/2;
    ctx.strokeStyle=mid<cfg.targetMin?'#ff5252':mid>cfg.targetMax?'#ffab40':'#00e676';
    ctx.lineWidth=2.5;ctx.lineJoin='round';
    ctx.beginPath();ctx.moveTo(toX(pts[i].d),toY(pts[i].avg));ctx.lineTo(toX(pts[i+1].d),toY(pts[i+1].avg));ctx.stroke();
  }
  // punti e label
  pts.forEach(p=>{
    const x=toX(p.d),y2=toY(p.avg);
    const col=p.avg<cfg.targetMin?'#ff5252':p.avg>cfg.targetMax?'#ffab40':'#00e676';
    ctx.beginPath();ctx.arc(x,y2,3,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.5)';ctx.font='bold 16px monospace';ctx.textAlign='center';
    ctx.fillText(p.d,x,ch-5);
  });
}
function goToDay(y,m,d){
  const target=new Date(y,m-1,d);
  const today=new Date(); today.setHours(0,0,0,0); target.setHours(0,0,0,0);
  cd=Math.round((target-today)/86400000);
  setDL();renderTL();renderSummary();
  window.scrollTo({top:document.getElementById('tl')?.offsetTop||0,behavior:'smooth'});
}
function renderStats(){
  const data=ld();
  document.getElementById('sgrid').innerHTML=['Colazione','Pranzo','Cena'].map(tipo=>{
    const gv=data.filter(e=>e.type==='pasto'&&e.tipo===tipo&&e.pre).map(e=>+e.pre).filter(Boolean);
    const avg=gv.length?Math.round(gv.reduce((a,b)=>a+b,0)/gv.length):'&#8212;';
    const cfg2=ldC();
    const col=typeof avg==='number'?(avg>cfg2.targetMax?'var(--r)':avg>cfg2.targetMin?'var(--o)':'var(--g)'):'var(--txt2)';
    return'<div class="sbox"><span class="sbox-v" style="color:'+col+'">'+avg+'</span><span class="sbox-l">'+tipo+'<br>avg</span></div>';
  }).join('');
  // Preserve current tab selection
  if(!document.querySelector('.ctab.on'))document.querySelectorAll('.ctab').forEach((b,i)=>b.classList.toggle('on',i===0));
  drawChart();
}
function switchChart(m,btn){curChart=m;document.querySelectorAll('.ctab').forEach(b=>b.classList.remove('on'));btn.classList.add('on');drawChart();}
function drawChart(){curChart==='day'?drawDayChart():drawPeriodChart(curChart==='week'?7:30);}

// Chart tooltip
document.getElementById('cv').addEventListener('click',function(e){
  const pts=this._pts;
  const tip=document.getElementById('cvTip');
  if(!pts||!pts.length){tip.classList.remove('on');return;}
  const rect=this.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let closest=null,minD=30;
  pts.forEach(p=>{const d=Math.sqrt((p.x-mx)**2+(p.y-my)**2);if(d<minD){minD=d;closest=p;}});
  if(closest){
    const d=new Date(closest.t);
    const col=closest.v<70?'#ff5252':closest.v>200?'#ffab40':'#00e676';
    tip.style.color=col;
    tip.innerHTML='<b>'+closest.v+'</b> mg/dL &nbsp;·&nbsp; '+p2(d.getHours())+':'+p2(d.getMinutes())+(closest.label?'<br><span style="font-size:.65rem;opacity:.7">'+closest.label+'</span>':'');
    // Position tooltip
    const tw=120,th=32;
    let tx=closest.x-tw/2,ty=closest.y-th-8;
    if(tx<0)tx=2;if(tx+tw>this.offsetWidth)tx=this.offsetWidth-tw-2;
    if(ty<0)ty=closest.y+10;
    tip.style.left=tx+'px';tip.style.top=ty+'px';
    tip.classList.add('on');
    setTimeout(()=>tip.classList.remove('on'),2500);
  } else {
    tip.classList.remove('on');
  }
});
function drawDayChart(){
  const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
  const W=cv.offsetWidth||300,H=110,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  const key=getDK(cd),cfg=ldC();
  let pts=ld().filter(e=>{const d=new Date(e.ts);return e.type==='glicemia'&&d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key;}).map(e=>({v:e.value,t:e.ts}));
  ld().filter(e=>{const d=new Date(e.ts);return(e.type==='pasto'||e.type==='spuntino')&&d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate())===key;}).forEach(e=>{if(e.pre)pts.push({v:+e.pre,t:e.ts,label:(e.tipo||'Spuntino')+' PRE'});});
  pts.sort((a,b)=>a.t-b.t);
  const leg=document.getElementById('chartLegend');
  if(!pts.length){ctx.clearRect(0,0,W,H);ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='12px sans-serif';ctx.textAlign='center';ctx.fillText('Nessun dato oggi',W/2,H/2);leg.innerHTML='<span style="color:rgba(255,82,82,.7);font-size:.57rem">\u25A0 Alta</span><span style="color:rgba(255,171,64,.7);font-size:.57rem">\u25A0 Elevata (>'+cfg.targetMax+')</span><span style="color:rgba(0,230,118,.7);font-size:.57rem">\u25A0 Range</span><span style="color:rgba(64,196,255,.7);font-size:.57rem">\u25A0 Bassa</span>';return;}
  const vals=pts.map(p=>p.v),mx=Math.max(250,...vals)+20,mn=Math.max(40,Math.min(...vals)-20);
  const pL=28,pR=8,pT=8,pB=20,pw=W-pL-pR,ph=H-pT-pB;
  ctx.clearRect(0,0,W,H);
  const y200=pT+ph-((200-mn)/(mx-mn))*ph,y70=pT+ph-((70-mn)/(mx-mn))*ph;
  if(y200>pT&&y200<pT+ph){ctx.fillStyle='rgba(255,82,82,.05)';ctx.fillRect(pL,pT,pw,y200-pT);}
  if(y70<pT+ph&&y70>pT){ctx.fillStyle='rgba(64,196,255,.05)';ctx.fillRect(pL,y70,pw,pT+ph-y70);}
  [70,cfg.targetMin,cfg.targetMax,200].forEach(v=>{
    if(v<mn||v>mx)return;
    const y=pT+ph-((v-mn)/(mx-mn))*ph;
    ctx.strokeStyle=v===200?'rgba(255,82,82,.4)':v===70?'rgba(64,196,255,.4)':v===cfg.targetMax?'rgba(255,171,64,.3)':'rgba(0,230,118,.2)';
    ctx.lineWidth=1;ctx.setLineDash(v===70||v===200?[]:[2,4]);
    ctx.beginPath();ctx.moveTo(pL,y);ctx.lineTo(W-pR,y);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='7px monospace';ctx.textAlign='left';ctx.fillText(v,0,y+3);
  });
  if(pts.length>1){
    const xp=pts.map((_,i)=>pL+(i/(pts.length-1))*pw),yp=pts.map(p=>pT+ph-((p.v-mn)/(mx-mn))*ph);
    ctx.beginPath();ctx.moveTo(xp[0],pT+ph);pts.forEach((_,i)=>ctx.lineTo(xp[i],yp[i]));ctx.lineTo(xp[xp.length-1],pT+ph);ctx.closePath();
    const gr=ctx.createLinearGradient(0,pT,0,pT+ph);gr.addColorStop(0,'rgba(0,230,118,.15)');gr.addColorStop(1,'rgba(0,230,118,0)');ctx.fillStyle=gr;ctx.fill();
    // Colored segments
  for(let i=0;i<pts.length-1;i++){
    const v1=pts[i].v,v2=pts[i+1].v,vMid=(v1+v2)/2;
    const seg=vMid<70?'#ff5252':vMid>200?'#ffab40':vMid>cfg.targetMax?'#ffab40':'#00e676';
    ctx.strokeStyle=seg;ctx.lineWidth=2;ctx.lineJoin='round';
    ctx.beginPath();ctx.moveTo(xp[i],yp[i]);ctx.lineTo(xp[i+1],yp[i+1]);ctx.stroke();
  }
  pts.forEach((p,i)=>{const col=p.v<70?'#ff5252':p.v>200?'#ffab40':p.v>cfg.targetMax?'#ffab40':'#00e676';ctx.beginPath();ctx.arc(xp[i],yp[i],3.5,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();ctx.strokeStyle=col;ctx.lineWidth=1;ctx.stroke();});
    // Store points for tooltip
    cv._pts=pts.map((p,i)=>({x:xp[i],y:yp[i],v:p.v,t:p.t,label:p.label||null}));
    const step=pts.length>8?2:1;
    pts.forEach((p,i)=>{if(i%step!==0)return;const x=xp[i],d=new Date(p.t);ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='7px monospace';ctx.textAlign='center';ctx.fillText(p2(d.getHours())+':'+p2(d.getMinutes()),x,H-2);});
  }
  if(leg)leg.innerHTML='<span style="color:rgba(255,82,82,.7)">\u25A0 Alta (>200)</span><span style="color:rgba(255,171,64,.7)">\u25A0 Elevata (>'+cfg.targetMax+')</span><span style="color:rgba(0,230,118,.7)">\u25A0 Range</span><span style="color:rgba(64,196,255,.7)">\u25A0 Bassa (<70)</span>';
}
function drawPeriodChart(days){
  const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
  const W=cv.offsetWidth||300,H=110,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;ctx.scale(dpr,dpr);
  const cfg=ldC();
  const pts=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const k=d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate());
    const ee=ld().filter(e=>{const dd=new Date(e.ts);return dd.getFullYear()+'-'+p2(dd.getMonth()+1)+'-'+p2(dd.getDate())===k;});
    const vv=ee.flatMap(e=>{const v=[];if(e.type==='glicemia'&&e.value)v.push(+e.value);if((e.type==='pasto'||e.type==='spuntino')&&e.pre)v.push(+e.pre);return v;}).filter(Boolean);
    const avg=vv.length?Math.round(vv.reduce((a,b)=>a+b,0)/vv.length):null;
    pts.push({avg,lbl:d.getDate()%5===0||days<=7?p2(d.getDate())+'/'+p2(d.getMonth()+1):''});
  }
  const mx=Math.max(200,...pts.map(d=>d.avg||0))+10,mn=60;
  const pL=26,pR=6,pT=8,pB=18,pw=W-pL-pR,ph=H-pT-pB;
  ctx.clearRect(0,0,W,H);
  [70,140,200].forEach(v=>{
    if(v<mn||v>mx)return;
    const y=pT+ph-((v-mn)/(mx-mn))*ph;
    ctx.strokeStyle=v===200?'rgba(255,82,82,.3)':v===70?'rgba(64,196,255,.25)':'rgba(255,171,64,.2)';
    ctx.lineWidth=1;ctx.setLineDash([2,4]);ctx.beginPath();ctx.moveTo(pL,y);ctx.lineTo(W-pR,y);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,255,255,.25)';ctx.font='7px monospace';ctx.textAlign='left';ctx.fillText(v,0,y+3);
  });
  const xp=pts.map((_,i)=>pL+(i/(pts.length-1))*pw),yp=pts.map(p=>p.avg!==null?pT+ph-((p.avg-mn)/(mx-mn))*ph:null);
  const vis=yp.map((y,i)=>y!==null?{x:xp[i],y}:null).filter(Boolean);
  if(vis.length>=1){
    ctx.beginPath();ctx.moveTo(vis[0].x,pT+ph);vis.forEach(p=>ctx.lineTo(p.x,p.y));ctx.lineTo(vis[vis.length-1].x,pT+ph);ctx.closePath();
    const gr=ctx.createLinearGradient(0,pT,0,pT+ph);gr.addColorStop(0,'rgba(0,230,118,.15)');gr.addColorStop(1,'rgba(0,230,118,0)');ctx.fillStyle=gr;ctx.fill();
    // Colored segments for period chart
  for(let i=0;i<pts.length-1;i++){
    if(yp[i]===null||yp[i+1]===null)continue;
    const vMid=((pts[i].avg||0)+(pts[i+1].avg||0))/2;
    const seg=vMid<70?'#ff5252':vMid>200?'#ffab40':vMid>cfg.targetMax?'#ffab40':'#00e676';
    ctx.strokeStyle=seg;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(xp[i],yp[i]);ctx.lineTo(xp[i+1],yp[i+1]);ctx.stroke();
  }
  }
  // Dots always drawn (works for single point too)
  pts.forEach((p,i)=>{
    if(yp[i]===null)return;
    const col=p.avg<70?'#ff5252':p.avg>200?'#ff5252':p.avg>cfg.targetMax?'#ffab40':p.avg<cfg.targetMin?'#40c4ff':'#00e676';
    ctx.beginPath();ctx.arc(xp[i],yp[i],4,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=0.5;ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,.8)';ctx.font='bold 8px monospace';ctx.textAlign='center';
    ctx.fillText(p.avg,xp[i],yp[i]-7);
  });
  pts.forEach((p,i)=>{if(!p.lbl)return;ctx.fillStyle='rgba(255,255,255,.22)';ctx.font='7px monospace';ctx.textAlign='center';ctx.fillText(p.lbl,xp[i],H-2);});
  const leg2=document.getElementById('chartLegend');if(leg2)leg2.innerHTML='';
}

// ── ESPORTA CSV ─────────────────────────────────────────
// Scarica tutte le voci in formato CSV compatibile con Excel

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: WATER TRACKING 💧
// Storage: localStorage 'GL_water' → array di {date:'YYYY-MM-DD', ml, ts}
//
// ldWater(): legge array dal localStorage
// svWater(d): scrive array nel localStorage
// todayKey(): ritorna 'YYYY-MM-DD' per oggi (usato come chiave giornaliera)
// getWaterToday(): somma ml di tutte le voci di oggi
//
// openWaterModal(): apre il modal rapido di inserimento acqua
// closeWaterModal(): chiude il modal
//
// updateWaterUI(): aggiorna barra progresso + lista voci nel modal
//   - Mostra ml totali vs WATER_TARGET (2000ml default)
//   - Lista con bottoni delete per ogni sorso
//
// addWater(ml): aggiunge una voce {date, ml, ts} e aggiorna UI + strip
// addWaterCustom(): legge ml da input personalizzato e chiama addWater()
// deleteWaterEntry(ts): elimina voce per timestamp
// deleteWaterGroup(ml): elimina tutte le voci con quel ml (per bottone contatore)
// updateWaterCount(ml, newCount, oldCount): aggiusta il conteggio di un tipo
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
const WATER_TARGET = 2000; // ml default

function ldWater() {
  try { return JSON.parse(localStorage.getItem('GL_water')||'[]'); } catch(e){return[];}
}
function svWater(d){ localStorage.setItem('GL_water', JSON.stringify(d)); }

function todayKey(){
  const d=new Date(); return d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate());
}

function getWaterToday(){
  const k=todayKey();
  return ldWater().filter(e=>e.date===k).reduce((s,e)=>s+e.ml,0);
}

function openWaterModal(){
  document.getElementById('waterQuickModal').classList.add('on');
  updateWaterUI();
}
function closeWaterModal(){
  document.getElementById('waterQuickModal').classList.remove('on');
}

function updateWaterUI(){
  const total = getWaterToday();
  const cfg = ldC();
  const target = cfg.waterTarget || WATER_TARGET;
  document.getElementById('wqTotal').textContent = total + ' ml';
  document.getElementById('wqTarget').textContent = '/ '+target+'ml';
  const pct = Math.min(100, Math.round(total/target*100));
  document.getElementById('wqFill').style.width = pct+'%';
  // Raggruppa voci per ml — una card per quantità distinta
  const k = todayKey();
  const entries = ldWater().filter(e=>e.date===k);
  const logEl = document.getElementById('wqEntries');
  if(logEl){
    if(!entries.length){
      logEl.innerHTML = '<div class="wq-empty">Nessuna registrazione oggi</div>';
    } else {
      const groups = {};
      entries.forEach(e=>{
        if(!groups[e.ml]) groups[e.ml]={ml:e.ml,count:0};
        groups[e.ml].count++;
      });
      logEl.innerHTML = Object.values(groups).sort((a,b)=>b.ml-a.ml).map(g=>{
        return '<div class="wq-entry-card">' +
          '<span class="wq-entry-ml">💧 '+g.ml+' ml</span>' +
          '<div style="display:flex;align-items:center;gap:5px;margin-left:auto">' +
            '<span style="font-size:.7rem;color:var(--txt2)">×</span>' +
            '<input class="wq-count-inp" type="number" min="0" max="20" value="'+g.count+'" ' +
              'onchange="updateWaterCount('+g.ml+',parseInt(this.value)||0,'+g.count+')">' +
          '</div>' +
          '<button class="wq-entry-del" onclick="deleteWaterGroup('+g.ml+')" title="Rimuovi tutti">🗑</button>' +
        '</div>';
      }).join('');
    }
  }
}

function addWater(ml){
  const k = todayKey();
  const d = ldWater();
  d.push({date:k, ml, ts:new Date().toISOString()});
  svWater(d);
  updateWaterUI();
  toast('💧 +'+ml+'ml acqua');
  // Aggiorna anche strip/summary se presenti
  if(typeof renderStrip==='function') renderStrip();
  if(typeof renderSummary==='function') renderSummary();
}

function addWaterCustom(){
  const inp = document.getElementById('wqCustom');
  const ml = parseInt(inp.value)||0;
  if(ml<=0||ml>5000){ toast('Inserisci un valore valido (1-5000ml)'); return; }
  addWater(ml);
  inp.value='';
}

function deleteWaterEntry(ts){
  const d = ldWater().filter(e=>e.ts!==ts);
  svWater(d);
  updateWaterUI();
  if(typeof renderStrip==='function') renderStrip();
}

function deleteWaterGroup(ml){
  // Rimuove TUTTE le voci di oggi con quel ml
  const k=todayKey();
  const d=ldWater().filter(e=>!(e.date===k&&e.ml===ml));
  svWater(d);
  updateWaterUI();
  if(typeof renderStrip==='function') renderStrip();
  toast('🗑 Rimossi tutti i bicchieri da '+ml+'ml');
}

function updateWaterCount(ml, newCount, oldCount){
  const k=todayKey();
  const d=ldWater();
  const diff=newCount-oldCount;
  if(diff>0){
    // Aggiungi voci
    for(let i=0;i<diff;i++) d.push({date:k,ml,ts:new Date().toISOString()});
  } else if(diff<0){
    // Rimuovi |diff| voci di quel ml oggi
    let toRemove=Math.abs(diff);
    for(let i=d.length-1;i>=0&&toRemove>0;i--){
      if(d[i].date===k&&d[i].ml===ml){ d.splice(i,1); toRemove--; }
    }
  }
  svWater(d);
  updateWaterUI();
  if(typeof renderStrip==='function') renderStrip();
}

// ═══════════════════════════════════════════════════════════════
// 📈 OVERLAY CHART — glicemia sovrapposta N giorni
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: STORICO GRAFICO SOVRAPPOSTO (7/14/30gg)
// Modal a schermo intero con grafico a curve sovrapposte per confronto
// di più periodi temporali.
//
// openOverlayChart(): apre il modal #overlayChartModal
// closeOverlayChart(): chiude il modal
//
// drawOverlayChart(days, tabEl):
//   Disegna un grafico multi-periodo su canvas:
//   - Asse Y: range glicemico (minV-maxV con padding)
//   - Asse X: giorni del periodo
//   - Linee tratteggiate per targetMin, targetMax, 70, 200
//   - Zona verde target
//   - Per ogni giorno: punto colorato + label valore sopra
//   - Statistiche aggregate (media, min, max, deviazione std)
// ═══════════════════════════════════════════════════════════════
function openOverlayChart(){
  document.getElementById('overlayChartModal').classList.add('on');
  drawOverlayChart(7, document.querySelector('.oc-tab'));
}
function closeOverlayChart(){
  document.getElementById('overlayChartModal').classList.remove('on');
}

function drawOverlayChart(days, tabEl){
  // Aggiorna tabs
  document.querySelectorAll('.oc-tab').forEach(t=>t.classList.remove('on'));
  if(tabEl) tabEl.classList.add('on');

  const cv = document.getElementById('ocCanvas');
  if(!cv) return;
  const ctx = cv.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  const W = cv.parentElement.offsetWidth||320;
  const H = 200;
  cv.width = W*dpr; cv.height = H*dpr;
  cv.style.width = W+'px'; cv.style.height = H+'px';
  ctx.scale(dpr, dpr);

  const cfg = ldC();
  const allData = ld().filter(e=>e.type==='glicemia');

  // Raccogli dati per N giorni — bucket orari (0-23)
  // Per ogni ora calcoliamo la media di tutti i valori in quell'ora negli ultimi N giorni
  const buckets = Array.from({length:24}, ()=>[]);
  const now = new Date();

  // Dati per-giorno (per linee sovrapposte)
  const dayLines = [];
  for(let i=days-1;i>=0;i--){
    const d=new Date(now); d.setDate(d.getDate()-i);
    const k=d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate());
    const pts=allData.filter(e=>{
      const ed=new Date(e.ts);
      return ed.getFullYear()+'-'+p2(ed.getMonth()+1)+'-'+p2(ed.getDate())===k;
    }).map(e=>({ h:new Date(e.ts).getHours()+(new Date(e.ts).getMinutes()/60), v:parseFloat(e.value)||0 }))
     .filter(p=>p.v>0).sort((a,b)=>a.h-b.h);
    if(pts.length) dayLines.push({k, pts, dayOff:i});
    pts.forEach(p=>{ const h=Math.floor(p.h); if(h<24) buckets[h].push(p.v); });
  }

  // Media oraria
  const avgPts = buckets.map((b,h)=>({ h, avg: b.length ? Math.round(b.reduce((s,v)=>s+v,0)/b.length) : null })).filter(p=>p.avg!==null);

  // Scala Y
  const allVals = avgPts.map(p=>p.avg).concat(dayLines.flatMap(d=>d.pts.map(p=>p.v)));
  if(!allVals.length){
    ctx.fillStyle='rgba(255,255,255,.2)';
    ctx.font='13px sans-serif';
    ctx.textAlign='center';
    ctx.fillText('Nessun dato disponibile', W/2, H/2);
    document.getElementById('ocStats').innerHTML='';
    return;
  }
  const minV = Math.max(40, Math.min(...allVals)-20);
  const maxV = Math.min(400, Math.max(...allVals)+30);
  const toY = v=>H-8 - (v-minV)/(maxV-minV)*(H-20);
  const toX = h=>30 + (h/23)*(W-40);

  ctx.clearRect(0,0,W,H);

  // Zona target
  const tMin=cfg.targetMin||80, tMax=cfg.targetMax||180;
  ctx.fillStyle='rgba(0,230,118,.06)';
  ctx.fillRect(30,toY(tMax),W-40,toY(tMin)-toY(tMax));

  // Linee giorni singoli (grigio tenue)
  if(dayLines.length>1){
    const alpha = Math.max(0.08, 0.3/dayLines.length);
    dayLines.forEach(dl=>{
      if(dl.pts.length<2) return;
      ctx.beginPath();
      ctx.strokeStyle='rgba(255,255,255,'+alpha+')';
      ctx.lineWidth=1;
      dl.pts.forEach((p,i)=>{
        const x=toX(p.h), y=toY(p.v);
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.stroke();
    });
  }

  // Linea media (colore dinamico)
  if(avgPts.length>=2){
    ctx.beginPath();
    ctx.strokeStyle='rgba(128,203,196,1)';
    ctx.lineWidth=2.5;
    ctx.lineJoin='round';
    avgPts.forEach((p,i)=>{
      const x=toX(p.h), y=toY(p.avg);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();
    // Punti sulla media
    avgPts.forEach(p=>{
      const col=p.avg<tMin?'#ff5252':p.avg>tMax?'#ffab40':'#00e676';
      ctx.beginPath();
      ctx.arc(toX(p.h),toY(p.avg),3.5,0,Math.PI*2);
      ctx.fillStyle=col;
      ctx.fill();
    });
  }

  // Assi X (ore)
  ctx.fillStyle='rgba(255,255,255,.35)';
  ctx.font='9px sans-serif';
  ctx.textAlign='center';
  [0,6,12,18,23].forEach(h=>{
    ctx.fillText(h+'h', toX(h), H-1);
  });

  // Linee target labels
  ctx.fillStyle='rgba(0,230,118,.5)';
  ctx.textAlign='right';
  ctx.font='8px sans-serif';
  if(toY(tMin)>10&&toY(tMin)<H-10) ctx.fillText(tMin, 28, toY(tMin)+3);
  if(toY(tMax)>10&&toY(tMax)<H-10) ctx.fillText(tMax, 28, toY(tMax)+3);

  // Stats riepilogo
  const allValsFlat = dayLines.flatMap(d=>d.pts.map(p=>p.v));
  const mean = allValsFlat.length ? Math.round(allValsFlat.reduce((a,b)=>a+b)/allValsFlat.length) : 0;
  const inRange = allValsFlat.filter(v=>v>=tMin&&v<=tMax).length;
  const irPct = allValsFlat.length ? Math.round(inRange/allValsFlat.length*100) : 0;
  const maxVal = allValsFlat.length ? Math.max(...allValsFlat) : 0;
  const minVal = allValsFlat.length ? Math.min(...allValsFlat) : 0;
  const col=v=>v<tMin?'#ff5252':v>tMax?'#ffab40':'#00e676';
  document.getElementById('ocStats').innerHTML=[
    `<div class="oc-stat"><div class="oc-stat-v" style="color:${col(mean)}">${mean||'—'}</div><div class="oc-stat-l">Media mg/dL</div></div>`,
    `<div class="oc-stat"><div class="oc-stat-v" style="color:#00e676">${irPct}%</div><div class="oc-stat-l">In range</div></div>`,
    `<div class="oc-stat"><div class="oc-stat-v" style="color:#ff5252">${maxVal||'—'}</div><div class="oc-stat-l">Picco</div></div>`,
    `<div class="oc-stat"><div class="oc-stat-v" style="color:#29b6f6">${minVal||'—'}</div><div class="oc-stat-l">Minimo</div></div>`,
    `<div class="oc-stat"><div class="oc-stat-v">${allValsFlat.length}</div><div class="oc-stat-l">Misurazioni</div></div>`,
  ].join('');
  document.getElementById('ocLegend').innerHTML = `<span style="color:rgba(128,203,196,1)">━━</span> Media · <span style="color:rgba(255,255,255,.25)">━━</span> Giorni singoli · Ultimi ${days} giorni (${allValsFlat.length} valori)`;
}

// AC close + panel reset → built into pickAC and closePanel directly

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: SALVATAGGIO FILE UNIVERSALE
// saveFile(filename, dataOrBase64, mimeType):
//   Funzione asincrona che gestisce il download in modo cross-platform:
//
//   1. CAPACITOR NATIVO (Android/iOS):
//      Usa Capacitor.Filesystem.writeFile() per scrivere nella cartella
//      Download del dispositivo. Mostra toast con percorso file.
//
//   2. WEB BROWSER:
//      Crea un Blob, genera un URL temporaneo, simula click su <a>.
//      Gestisce sia base64 (per PDF) che dati diretti (per CSV).
//      Pulizia URL dopo 5 secondi per evitare memory leak.
// ═══════════════════════════════════════════════════════════════
// ── SALVATAGGIO FILE UNIVERSALE ──────────────────────────────
// Su browser: usa download link normale
// Su Capacitor APK: usa Filesystem plugin → cartella Downloads Android
// Richiede in AndroidManifest.xml:
//   <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
//                    android:maxSdkVersion="29"/>
//   <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>

async function saveFile(filename, dataOrBase64, mimeType) {
  const isNative = IS_NATIVE;
  const isPDF = mimeType === 'application/pdf';

  if (!isNative) {
    // ── BROWSER / PWA: download classico ──
    const isBase64 = typeof dataOrBase64 === 'string' && !dataOrBase64.startsWith('data:') && !dataOrBase64.startsWith('blob:');
    let href;
    if (isBase64) {
      const byteChars = atob(dataOrBase64);
      const byteArr = new Uint8Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) byteArr[i] = byteChars.charCodeAt(i);
      href = URL.createObjectURL(new Blob([byteArr], { type: mimeType }));
    } else if (typeof dataOrBase64 === 'string' && dataOrBase64.startsWith('data:')) {
      href = dataOrBase64;
    } else {
      href = URL.createObjectURL(new Blob([dataOrBase64], { type: mimeType }));
    }

    // Se è un PDF e abbiamo accesso FS, salva nella cartella Report
    if (isPDF && _fsReportDir) {
      // Estrai base64 puro
      const b64 = isBase64 ? dataOrBase64 : (typeof dataOrBase64 === 'string' && dataOrBase64.includes(',') ? dataOrBase64.split(',')[1] : null);
      if (b64) {
        const blobUrl = await fsSavePDF(b64, filename);
        if (blobUrl) {
          // Scarica anche normalmente (così va anche in Downloads)
          const a = document.createElement('a');
          a.href = href; a.download = filename; a.click();
          setTimeout(() => URL.revokeObjectURL(href), 5000);
          // Mostra dialog con pulsante Apri
          showPdfSavedDialog(blobUrl, filename);
          return true;
        }
      }
    }

    // Download standard (nessuna FS configurata, o non PDF)
    const a = document.createElement('a');
    a.href = href; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(href), 5000);
    return true;
  }

  // ── CAPACITOR NATIVE (Android/iOS) ──
  const FS = _capFS();
  if (!FS) { toast('⚠️ Plugin Filesystem non disponibile'); return false; }

  // Normalizza in base64 puro
  let base64 = dataOrBase64;
  if (typeof base64 === 'string' && base64.startsWith('data:')) {
    base64 = base64.split(',')[1];
  } else if (typeof base64 !== 'string') {
    const bytes = base64 instanceof Uint8Array ? base64 : new Uint8Array(base64);
    let bin = ''; bytes.forEach(b => bin += String.fromCharCode(b));
    base64 = btoa(bin);
  }

  // PDF → salva in GlicoLog/Report/ e mostra dialog "Apri"
  if (isPDF) {
    const uri = await fsSavePDF(base64, filename);
    if (uri) {
      showPdfSavedDialog(uri, filename);
      return true;
    }
    // Fallback se fsSavePDF fallisce: tenta DOWNLOADS
  }

  // File non-PDF (o fallback): salva in Downloads
  const targets = [
    { dir: 'DOWNLOADS', label: 'Download' },
    { dir: 'DOCUMENTS', label: 'Documenti' },
    { dir: 'DATA',      label: 'Storage app' },
  ];
  for (const target of targets) {
    try {
      await FS.writeFile({ path: filename, data: base64, directory: target.dir, recursive: true });
      toast('✅ Salvato in ' + target.label + ': ' + filename);
      return true;
    } catch(e) { /* prova il prossimo */ }
  }

  // Ultimo resort: Share
  try {
    const shr = _capShr();
    if (shr) {
      await FS.writeFile({ path: 'tmp_' + filename, data: base64, directory: 'CACHE', recursive: true });
      const { uri } = await FS.getUri({ path: 'tmp_' + filename, directory: 'CACHE' });
      await shr.share({ title: filename, files: [uri], dialogTitle: 'Salva o condividi' });
      return true;
    }
  } catch(e) {}

  toast('❌ Impossibile salvare il file.');
  return false;
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: ESPORTAZIONE PDF
// Genera un PDF multi-pagina con jsPDF (via CDN).
//
// openPdfModal() / closePdfModal(): gestiscono il modal di selezione
//   del periodo (Tutti i dati / Ultimi 30gg / 14gg / 7gg / Oggi).
//
// exportPDF(mode):
//   1. COVER PAGE: titolo, data export, range date del periodo
//
//   2. STATISTICHE (prima pagina):
//      - Range date, N° giorni con dati, N° misurazioni
//      - Media glicemia ± deviazione standard
//      - Time in Range % (valori nel range targetMin-targetMax)
//      - Distribuzione: % bassa/nel range/alta/molto alta
//
//   3. GRAFICO RIEPILOGATIVO (solo se periodo > 1 giorno):
//      Media giornaliera su canvas temporaneo → immagine nel PDF.
//      Zona target verde, linee orizzontali, segmenti colorati.
//
//   4. DIARIO GIORNALIERO — layout compatto 3 colonne (ispirato LibreView):
//      COLS=3 giorni affiancati per riga.
//      Ogni giorno: header colorato (Lun 26 Feb + media) +
//                   mini-chart canvas 28mm + badge eventi (⬇bassi, ⬆alti, 💉insulina)
//                   + lista eventi compatta max 8 righe
//                   + "+ N altri eventi…" se più di 8
//
//   5. MINI CHART GIORNO (helper interno):
//      Disegna un mini-grafico canvas H=40px per ogni giorno nel PDF.
//      Zona target, linee trattate, area fill, segmenti colorati.
//
//   6. SEZIONE MENSILE RIEPILOGO (ultima pagina):
//      Griglia 3×7 giorni del mese con media colorata.
//
// ═══════════════════════════════════════════════════════════════
// ── ESPORTA PDF ─────────────────────────────────────────────
// ── PDF PERIOD MODAL ────────────────────────────────────────
function openPdfModal() {
  // cd=0→oggi, cd=-1→ieri ecc. — usa getDK(cd) per avere YYYY-MM-DD
  const dkParts = getDK(cd).split('-'); // [yyyy, mm, dd]
  const dateObj = new Date(+dkParts[0], +dkParts[1]-1, +dkParts[2]);
  const wd = DI[dateObj.getDay()];
  const label = wd+' '+p2(dateObj.getDate())+'/'+p2(dateObj.getMonth()+1)+'/'+dateObj.getFullYear();
  document.getElementById('pdfOptGiornoSub').textContent = label;
  document.getElementById('pdfPeriodModal').style.display = 'flex';
}
function closePdfModal() {
  document.getElementById('pdfPeriodModal').style.display = 'none';
}

// ── ESPORTA PDF ─────────────────────────────────────────────
// mode: 'all' | '30gg' | '14gg' | '7gg' | 'giorno'
async function exportPDF(mode='all') {
  toast('Generazione PDF in corso...');
  if (!window.jspdf) {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const cfg = ldC();
  const now = new Date();

  // ─── Costanti layout ───────────────────────────────────────────
  const PW=210, PH=297, ML=14, MR=14, CW=182;
  let y = 0;

  // ─── Colori (palette chiara professionale) ──────────────────
  const C_BG       = [250,251,253];   // sfondo pagina quasi bianco
  const C_HDR      = [28,42,64];      // header blu scuro
  const C_HDR_TXT  = [255,255,255];
  const C_ACCENT   = [0,150,80];      // verde accent
  const C_LINE     = [210,218,228];   // linea separatore grigio chiaro
  const C_TXT      = [30,38,52];      // testo principale
  const C_TXT2     = [100,115,135];   // testo secondario
  const C_TXT3     = [155,168,185];   // testo terziario
  const C_GREEN    = [0,158,80];
  const C_ORANGE   = [220,130,0];
  const C_RED      = [210,45,45];
  const C_PURPLE   = [130,80,185];
  const C_BLUE     = [30,130,195];

  // ─── Helper: colore glicemia ───────────────────────────────
  const gColor = v => {
    const n = +v;
    if (!n) return C_TXT2;
    return n < cfg.targetMin ? C_RED : n > cfg.targetMax ? C_ORANGE : C_GREEN;
  };
  const fmtDate2 = ts => { const d=new Date(ts); return p2(d.getDate())+'/'+p2(d.getMonth()+1)+'/'+d.getFullYear(); };
  const fmtTime2 = ts => { const d=new Date(ts); return p2(d.getHours())+':'+p2(d.getMinutes()); };

  // ─── Range dati dal mode ───────────────────────────────────
  let fromTs = 0, toTs = Infinity;
  let modeLbl = 'Tutti i dati';
  if (mode==='7gg')  { const d=new Date(); d.setDate(d.getDate()-7);  d.setHours(0,0,0,0); fromTs=d.getTime(); modeLbl='Ultimi 7 giorni'; }
  if (mode==='14gg') { const d=new Date(); d.setDate(d.getDate()-14); d.setHours(0,0,0,0); fromTs=d.getTime(); modeLbl='Ultimi 14 giorni'; }
  if (mode==='30gg') { const d=new Date(); d.setDate(d.getDate()-30); d.setHours(0,0,0,0); fromTs=d.getTime(); modeLbl='Ultimi 30 giorni'; }
  if (mode==='giorno') {
    const dkP=getDK(cd).split('-');
    const d=new Date(+dkP[0],+dkP[1]-1,+dkP[2]); d.setHours(0,0,0,0);
    fromTs=d.getTime(); toTs=fromTs+86400000-1;
    modeLbl=DI[d.getDay()]+' '+p2(d.getDate())+'/'+p2(d.getMonth()+1)+'/'+d.getFullYear();
  }

  const allData = ld().filter(e => e.ts >= fromTs && e.ts <= toTs).sort((a,b)=>a.ts-b.ts);

  // ─── Sfondo pagina ──────────────────────────────────────────
  const paintBg = () => { doc.setFillColor(...C_BG); doc.rect(0,0,PW,PH,'F'); };

  // ─── Header pagina (dopo pag.1) ────────────────────────────
  const pageHeader = () => {
    doc.setFillColor(...C_HDR); doc.rect(0,0,PW,10,'F');
    doc.setTextColor(...C_HDR_TXT); doc.setFontSize(7); doc.setFont('helvetica','bold');
    doc.text('GlicoLog', ML, 6.8);
    doc.setFont('helvetica','normal'); doc.setFontSize(6.5);
    doc.text(modeLbl+' — esportato il '+fmtDate2(Date.now()), PW/2, 6.8, {align:'center'});
    doc.text('Pagina '+doc.internal.getCurrentPageInfo().pageNumber, PW-MR, 6.8, {align:'right'});
  };

  // ─── Footer pagina ─────────────────────────────────────────
  const pageFooter = () => {
    doc.setFillColor(...C_LINE); doc.rect(0, PH-8, PW, 8, 'F');
    doc.setTextColor(...C_TXT3); doc.setFontSize(6); doc.setFont('helvetica','italic');
    doc.text('Questo report è solo uno strumento di supporto — non sostituisce la valutazione del medico o del diabetologo.', PW/2, PH-3.5, {align:'center'});
  };

  // ─── Nuova pagina ──────────────────────────────────────────
  function newPage() {
    pageFooter();
    doc.addPage();
    paintBg();
    pageHeader();
    y = 16;
  }
  function checkY(need) { if (y + need > PH - 12) newPage(); }

  // ─── Linea orizzontale ──────────────────────────────────────
  const hLine = (lx=ML, rx=ML+CW, wt=0.25, col=C_LINE) => {
    doc.setDrawColor(...col); doc.setLineWidth(wt); doc.line(lx, y, rx, y);
  };

  // ─── Titolo sezione ─────────────────────────────────────────
  const sectionTitle = (title) => {
    checkY(10);
    doc.setFillColor(...C_HDR); doc.rect(ML, y, CW, 7, 'F');
    doc.setFillColor(...C_ACCENT); doc.rect(ML, y, 3, 7, 'F');
    doc.setTextColor(...C_HDR_TXT); doc.setFontSize(8.5); doc.setFont('helvetica','bold');
    doc.text(title.toUpperCase(), ML+6, y+4.8);
    y += 10;
  };

  // ════════════════════════════════════════════════════
  //  PAGINA 1 — COVER
  // ════════════════════════════════════════════════════
  paintBg();

  // Header cover blu grande
  doc.setFillColor(...C_HDR); doc.rect(0,0,PW,52,'F');
  doc.setFillColor(...C_ACCENT); doc.rect(0,50,PW,2,'F');

  // Titolo
  doc.setTextColor(...C_HDR_TXT); doc.setFontSize(32); doc.setFont('helvetica','bold');
  doc.text('GlicoLog', ML, 22);
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text('Diario personale per la gestione del diabete', ML, 31);

  // Sottotitolo con periodo
  doc.setFontSize(8.5); doc.setTextColor(160,200,230);
  doc.text(modeLbl, ML, 40);
  doc.text('Generato il '+fmtDate2(Date.now())+' alle '+fmtTime2(Date.now()), ML, 47);

  // Range target a destra
  doc.setTextColor(160,200,230); doc.setFontSize(7.5);
  doc.text('Target: '+cfg.targetMin+' - '+cfg.targetMax+' mg/dL', PW-MR, 40, {align:'right'});
  doc.text('FSI: '+cfg.fsi+'  |  Rapporto I:C = 1:'+cfg.ic, PW-MR, 47, {align:'right'});

  y = 62;

  // ─── STATISTICHE RIEPILOGATIVE ─────────────────────────────
  const allGlic = allData.flatMap(e => {
    const v=[];
    if(e.type==='glicemia'&&e.value) v.push(+e.value);
    if((e.type==='pasto'||e.type==='spuntino')&&e.pre) v.push(+e.pre);
    return v;
  });
  const avg = allGlic.length ? Math.round(allGlic.reduce((a,b)=>a+b)/allGlic.length) : null;
  const inRange = allGlic.filter(v=>v>=cfg.targetMin&&v<=cfg.targetMax).length;
  const irPct = allGlic.length ? Math.round(inRange/allGlic.length*100) : 0;
  const peakV = allGlic.length ? Math.max(...allGlic) : null;
  const minV  = allGlic.length ? Math.min(...allGlic) : null;
  const stdDev = allGlic.length>1 ? Math.round(Math.sqrt(allGlic.reduce((a,v)=>{const d=v-avg;return a+d*d;},0)/allGlic.length)) : null;
  const totalMeals = allData.filter(e=>e.type==='pasto'||e.type==='spuntino').length;
  const totalIns   = allData.filter(e=>e.type==='insulina').reduce((a,e)=>a+(+e.units||0),0);
  const totalDays  = new Set(allData.map(e=>fmtDate2(e.ts))).size;
  const totalSport = allData.filter(e=>e.type==='sport').length;
  const totalCarbs = allData.filter(e=>e.type==='pasto'||e.type==='spuntino').reduce((a,e)=>a+(+e.carbs||0),0);

  // 4 box statistiche principali
  const statBoxes = [
    { lbl:'Glicemia media',   val: avg ? avg+' mg/dL'    : '—', col: avg ? gColor(avg) : C_TXT2 },
    { lbl:'Tempo in range',   val: irPct+'%',              col: irPct>=70?C_GREEN:irPct>=50?C_ORANGE:C_RED },
    { lbl:'Valore massimo',   val: peakV ? peakV+' mg/dL': '—', col: peakV ? gColor(peakV) : C_TXT2 },
    { lbl:'Valore minimo',    val: minV  ? minV+' mg/dL' : '—', col: minV  ? gColor(minV)  : C_TXT2 },
  ];
  const bw = (CW-9)/4;
  statBoxes.forEach((b,i) => {
    const bx = ML + i*(bw+3);
    doc.setFillColor(255,255,255); doc.roundedRect(bx, y, bw, 20, 2,2,'F');
    doc.setDrawColor(...b.col); doc.setLineWidth(0.5); doc.rect(bx, y, bw, 1.5,'F');
    doc.setFillColor(...b.col); doc.rect(bx, y, bw, 1.5, 'F');
    doc.setTextColor(...b.col); doc.setFontSize(12.5); doc.setFont('helvetica','bold');
    doc.text(b.val, bx+bw/2, y+12, {align:'center'});
    doc.setTextColor(...C_TXT2); doc.setFontSize(6); doc.setFont('helvetica','normal');
    doc.text(b.lbl, bx+bw/2, y+17.5, {align:'center'});
  });
  y += 25;

  // Riga riassuntiva
  doc.setFillColor(240,244,250); doc.roundedRect(ML, y, CW, 10, 2, 2, 'F');
  doc.setTextColor(...C_TXT); doc.setFontSize(7.5); doc.setFont('helvetica','normal');
  const sumLine = totalDays+' giorni  |  '+allGlic.length+' misurazioni  |  '+totalMeals+' pasti/spuntini  |  '+totalIns+'U insulina  |  '+totalCarbs+'g carbo  |  '+totalSport+' sessioni sport'+(stdDev?'  |  Dev.std: '+stdDev+' mg/dL':'');
  doc.text(sumLine, ML+CW/2, y+6.5, {align:'center', maxWidth:CW-4});
  y += 15;

  // ─── GRAFICO MEDIE GIORNALIERE (se > 1 giorno) ──────────────
  if (mode !== 'giorno' && allGlic.length > 0) {
    doc.setFillColor(255,255,255); doc.roundedRect(ML, y, CW, 50, 2,2,'F');
    doc.setTextColor(...C_TXT); doc.setFontSize(8); doc.setFont('helvetica','bold');
    doc.text('Andamento glicemia — medie giornaliere', ML+4, y+6);
    // linea range target
    doc.setTextColor(...C_TXT2); doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.setFillColor(...C_GREEN); doc.rect(ML+CW-50, y+2.5, 4, 3, 'F');
    doc.text('In range ('+cfg.targetMin+'-'+cfg.targetMax+')', ML+CW-44, y+5.5);
    doc.setFillColor(...C_ORANGE); doc.rect(ML+CW-20, y+2.5, 4, 3, 'F');
    doc.text('Alto', ML+CW-14, y+5.5);

    try {
      const days2 = mode==='7gg'?7:mode==='14gg'?14:mode==='30gg'?30:60;
      const daysShow = Math.min(days2, 60);
      const CW2=560*2, CH2=100*2;
      const off = document.createElement('canvas');
      off.width=CW2; off.height=CH2;
      const ctx=off.getContext('2d'); ctx.scale(2,2);
      const W=CW2/2, H=CH2/2;
      ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H);
      const PL=32,PR=10,PT=8,PB=20,pw=W-PL-PR,ph=H-PT-PB;
      const pts=[];
      for(let i=daysShow-1;i>=0;i--){
        const d=new Date(); d.setDate(d.getDate()-i);
        const k=d.getFullYear()+'-'+p2(d.getMonth()+1)+'-'+p2(d.getDate());
        const dayD=allData.filter(e=>{const dd=new Date(e.ts);return dd.getFullYear()+'-'+p2(dd.getMonth()+1)+'-'+p2(dd.getDate())===k;});
        const vals=dayD.flatMap(e=>{const v=[];if(e.type==='glicemia'&&e.value)v.push(+e.value);if((e.type==='pasto'||e.type==='spuntino')&&e.pre)v.push(+e.pre);return v;});
        const a=vals.length?Math.round(vals.reduce((a,b)=>a+b)/vals.length):null;
        const showL = daysShow<=14 ? true : (i===0||i%7===0);
        pts.push({avg:a, lbl:showL?p2(d.getDate())+'/'+p2(d.getMonth()+1):''});
      }
      const allPtVals = pts.filter(p=>p.avg).map(p=>p.avg);
      const minY=Math.max(40,Math.min(...allPtVals)-20);
      const maxY=Math.min(400,Math.max(...allPtVals)+30);
      const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
      const toX=i=>PL+(pts.length>1?i/(pts.length-1):0.5)*pw;
      const toY=v=>PT+ph-clamp((v-minY)/(maxY-minY),0,1)*ph;
      // zona target verde trasparente
      ctx.fillStyle='rgba(0,160,80,0.08)';
      ctx.fillRect(PL, toY(cfg.targetMax), pw, toY(cfg.targetMin)-toY(cfg.targetMax));
      // linee guida
      [70, cfg.targetMin, cfg.targetMax, 200, 300].forEach(v=>{
        if(v<minY||v>maxY) return;
        ctx.strokeStyle = v===cfg.targetMin||v===cfg.targetMax ? 'rgba(0,160,80,.4)' : 'rgba(180,180,180,.5)';
        ctx.lineWidth=0.8; ctx.setLineDash([3,4]);
        ctx.beginPath(); ctx.moveTo(PL,toY(v)); ctx.lineTo(W-PR,toY(v)); ctx.stroke(); ctx.setLineDash([]);
        ctx.fillStyle='rgba(100,110,130,.7)'; ctx.font='9px Arial'; ctx.textAlign='right';
        ctx.fillText(v, PL-2, toY(v)+3.5);
      });
      // griglia colonne
      pts.forEach((p,i)=>{
        if(!p.lbl) return;
        const x=toX(i);
        ctx.strokeStyle='rgba(210,215,225,.6)'; ctx.lineWidth=0.5; ctx.setLineDash([]);
        ctx.beginPath(); ctx.moveTo(x,PT); ctx.lineTo(x,H-PB); ctx.stroke();
        ctx.fillStyle='rgba(100,110,130,.8)'; ctx.font='9px Arial'; ctx.textAlign='center';
        ctx.fillText(p.lbl, x, H-5);
      });
      // area riempimento
      const vis=pts.map((p,i)=>p.avg!=null?{x:toX(i),y:toY(p.avg),v:p.avg}:null).filter(Boolean);
      if(vis.length>=2){
        ctx.beginPath(); ctx.moveTo(vis[0].x,H-PB);
        vis.forEach(p=>ctx.lineTo(p.x,p.y));
        ctx.lineTo(vis[vis.length-1].x,H-PB); ctx.closePath();
        const gr=ctx.createLinearGradient(0,PT,0,H-PB);
        gr.addColorStop(0,'rgba(0,150,80,.15)'); gr.addColorStop(1,'rgba(0,150,80,.02)');
        ctx.fillStyle=gr; ctx.fill();
        // linea
        for(let i=0;i<vis.length-1;i++){
          const vm=(vis[i].v+vis[i+1].v)/2;
          ctx.strokeStyle=vm<cfg.targetMin?'#c82a2a':vm>cfg.targetMax?'#d47800':'#009850';
          ctx.lineWidth=2.5; ctx.lineJoin='round';
          ctx.beginPath(); ctx.moveTo(vis[i].x,vis[i].y); ctx.lineTo(vis[i+1].x,vis[i+1].y); ctx.stroke();
        }
      }
      // dot + valore
      vis.forEach(p=>{
        const col=p.v<cfg.targetMin?'#c82a2a':p.v>cfg.targetMax?'#d47800':'#009850';
        ctx.beginPath(); ctx.arc(p.x,p.y,3.5,0,Math.PI*2);
        ctx.fillStyle='#fff'; ctx.fill();
        ctx.strokeStyle=col; ctx.lineWidth=2; ctx.stroke();
      });
      const chartH=(H/W)*CW;
      doc.addImage(off.toDataURL('image/png'),'PNG',ML,y+9,CW,chartH-9);
    } catch(err) {}
    y += 52;
  }

  // ════════════════════════════════════════════════════
  //  PAGINE SUCCESSIVE — DIARIO GIORNALIERO
  // ════════════════════════════════════════════════════
  const dayMap = {};
  allData.forEach(e => { const k=fmtDate2(e.ts); if(!dayMap[k])dayMap[k]=[]; dayMap[k].push(e); });
  const sortedDays = Object.keys(dayMap).sort((a,b)=>{
    const [da,ma,ya]=a.split('/'); const [db,mb,yb]=b.split('/');
    return new Date(+ya,+ma-1,+da)-new Date(+yb,+mb-1,+db);
  });

  if (sortedDays.length > 0) {
    newPage();
    sectionTitle('Diario giornaliero');

    // Colonne tabella
    const C_ORA2=ML+1, C_TIPO2=ML+14, C_DET2=ML+40, C_GLIC2=ML+104, C_CARB2=ML+130, C_INS2=ML+152;

    sortedDays.forEach(dateKey => {
      const dayEntries = dayMap[dateKey].sort((a,b)=>a.ts-b.ts);
      const [dd,mm,yy] = dateKey.split('/');
      const weekday = DI[new Date(+yy,+mm-1,+dd).getDay()];
      const dayVals = dayEntries.flatMap(e=>{const v=[];if(e.type==='glicemia'&&e.value)v.push(+e.value);if((e.type==='pasto'||e.type==='spuntino')&&e.pre)v.push(+e.pre);return v;});
      const dayAvg = dayVals.length ? Math.round(dayVals.reduce((a,b)=>a+b)/dayVals.length) : null;
      const dayLow = dayEntries.filter(e=>(e.type==='glicemia'&&+e.value<cfg.targetMin)||((e.type==='pasto'||e.type==='spuntino')&&e.pre&&+e.pre<cfg.targetMin)).length;
      const dayHigh= dayEntries.filter(e=>(e.type==='glicemia'&&+e.value>cfg.targetMax)||((e.type==='pasto'||e.type==='spuntino')&&e.pre&&+e.pre>cfg.targetMax)).length;
      const dayIns = dayEntries.filter(e=>e.type==='insulina').reduce((a,e)=>a+(+e.units||0),0);
      const dayCarbs=dayEntries.filter(e=>e.type==='pasto'||e.type==='spuntino').reduce((a,e)=>a+(+e.carbs||0),0);

      // Stima altezza blocco giorno
      let blockH = 12; // header giorno
      dayEntries.forEach(e => {
        blockH += 5.5;
        if((e.type==='pasto'||e.type==='spuntino')&&(e.protein||e.fat||e.fiber)) blockH+=4;
        if(e.foods&&e.foods.length>1) blockH+=4;
      });
      blockH += 6; // padding fine

      checkY(Math.min(blockH, 80));

      // ── Header giorno ──────────────────────────────────────
      doc.setFillColor(235,240,250); doc.roundedRect(ML, y, CW, 9, 1.5,1.5,'F');
      doc.setFillColor(...C_ACCENT); doc.rect(ML, y, 3, 9, 'F');

      // Giorno e data
      doc.setTextColor(...C_HDR); doc.setFontSize(8.5); doc.setFont('helvetica','bold');
      doc.text(weekday.toUpperCase()+' '+dd+'/'+mm+'/'+yy, ML+6, y+6);

      // Media giorno
      if(dayAvg){
        const ac = gColor(dayAvg);
        doc.setTextColor(...ac); doc.setFontSize(8); doc.setFont('helvetica','bold');
        doc.text('media: '+dayAvg+' mg/dL', ML+60, y+6);
      }

      // Badge riepilogo a destra
      let bxr = ML+CW-1;
      if(dayIns>0){
        const bw2=22;
        doc.setFillColor(230,220,245); doc.roundedRect(bxr-bw2,y+1.5,bw2,6,1,1,'F');
        doc.setTextColor(...C_PURPLE); doc.setFontSize(6); doc.setFont('helvetica','bold');
        doc.text('INS '+dayIns+'U', bxr-bw2/2, y+5.8, {align:'center'});
        bxr-=bw2+2;
      }
      if(dayCarbs>0){
        const bw2=20;
        doc.setFillColor(220,240,230); doc.roundedRect(bxr-bw2,y+1.5,bw2,6,1,1,'F');
        doc.setTextColor(...C_GREEN); doc.setFontSize(6); doc.setFont('helvetica','bold');
        doc.text('C '+dayCarbs+'g', bxr-bw2/2, y+5.8, {align:'center'});
        bxr-=bw2+2;
      }
      if(dayLow>0){
        const bw2=14;
        doc.setFillColor(250,220,220); doc.roundedRect(bxr-bw2,y+1.5,bw2,6,1,1,'F');
        doc.setTextColor(...C_RED); doc.setFontSize(6.5); doc.setFont('helvetica','bold');
        // freccia giu
        doc.setDrawColor(...C_RED); doc.setLineWidth(0.6);
        doc.line(bxr-bw2+3, y+3.5, bxr-bw2+3, y+6.5);
        doc.line(bxr-bw2+3, y+6.5, bxr-bw2+1.8, y+5.2);
        doc.line(bxr-bw2+3, y+6.5, bxr-bw2+4.2, y+5.2);
        doc.text(String(dayLow), bxr-bw2+7, y+6, {align:'left'});
        bxr-=bw2+2;
      }
      if(dayHigh>0){
        const bw2=14;
        doc.setFillColor(255,238,200); doc.roundedRect(bxr-bw2,y+1.5,bw2,6,1,1,'F');
        doc.setTextColor(...C_ORANGE); doc.setFontSize(6.5); doc.setFont('helvetica','bold');
        // freccia su
        doc.setDrawColor(...C_ORANGE); doc.setLineWidth(0.6);
        doc.line(bxr-bw2+3, y+6.5, bxr-bw2+3, y+3.5);
        doc.line(bxr-bw2+3, y+3.5, bxr-bw2+1.8, y+4.8);
        doc.line(bxr-bw2+3, y+3.5, bxr-bw2+4.2, y+4.8);
        doc.text(String(dayHigh), bxr-bw2+7, y+6, {align:'left'});
      }
      y += 11;

      // ── Intestazione colonne (solo prima riga del giorno) ───
      doc.setFillColor(245,247,252); doc.rect(ML, y, CW, 5,'F');
      doc.setTextColor(...C_TXT3); doc.setFontSize(5); doc.setFont('helvetica','bold');
      doc.text('ORA',      C_ORA2, y+3.5);
      doc.text('TIPO',     C_TIPO2,y+3.5);
      doc.text('DETTAGLIO',C_DET2, y+3.5);
      doc.text('GLICEMIA', C_GLIC2,y+3.5);
      doc.text('CARBO',    C_CARB2,y+3.5);
      doc.text('INS.',     C_INS2, y+3.5);
      y += 6;

      // ── Righe eventi ─────────────────────────────────────────
      let alt=false;
      dayEntries.forEach(e => {
        let typeLabel='', typeCol=C_TXT2, detail='', glicStr='', carbStr='', insStr='';
        let hasExtra=false;

        if(e.type==='glicemia'){
          typeLabel='Glicemia'; typeCol=gColor(+e.value||0);
          const momento=(e.momento&&e.momento!=='Altro')?e.momento:'';
          detail=[momento,e.trend||''].filter(Boolean).join(' ');
          if(e.value) glicStr=(+e.value)+' mg/dL';
        } else if(e.type==='pasto'){
          typeLabel=e.tipo||'Pasto'; typeCol=C_GREEN;
          detail=(e.food||'').substring(0,38);
          if(e.pre&&+e.pre) glicStr=(+e.pre)+' mg/dL';
          if(e.carbs&&+e.carbs) carbStr=(+e.carbs)+'g';
          if(e.boloPre&&+e.boloPre) insStr=(+e.boloPre)+'U';
          hasExtra=!!(e.foods&&e.foods.length>1)||(!!e.protein||!!e.fat||!!e.fiber);
        } else if(e.type==='spuntino'){
          typeLabel='Spuntino'; typeCol=C_ORANGE;
          detail=(e.food||'').substring(0,38);
          if(e.pre&&+e.pre) glicStr=(+e.pre)+' mg/dL';
          if(e.carbs&&+e.carbs) carbStr=(+e.carbs)+'g';
          if(e.boloPre&&+e.boloPre) insStr=(+e.boloPre)+'U';
          hasExtra=!!(e.foods&&e.foods.length>1)||(!!e.protein||!!e.fat||!!e.fiber);
        } else if(e.type==='insulina'){
          typeLabel=(e.tipoIns||'Insulina').substring(0,12); typeCol=C_PURPLE;
          detail=(e.insulinType||'').substring(0,38);
          insStr=(e.units||0)+'U';
        } else if(e.type==='sport'){
          typeLabel='Sport'; typeCol=C_BLUE;
          const dur=e.duration>=60?Math.floor(e.duration/60)+'h'+(e.duration%60?e.duration%60+'m':''):e.duration+'m';
          detail=((e.label||e.sportName||'')+' '+dur+(e.kcal?' - '+e.kcal+' kcal':'')).trim().substring(0,42);
        } else if(e.type==='acqua'){
          typeLabel='Acqua'; typeCol=C_BLUE;
          detail=(e.ml||'')+'ml';
        } else if(e.type==='alcool'){
          typeLabel='Alcool'; typeCol=[180,90,30];
          detail=(e.label||e.alcType||'').substring(0,28)+(e.qty>1?' x'+e.qty:'');
          carbStr=(+e.units||0).toFixed(1)+'U alc';
        } else return;

        const rH=5.5;
        checkY(rH + (hasExtra?7:0));

        // Sfondo alternato leggero
        if(alt){ doc.setFillColor(248,250,253); doc.rect(ML,y,CW,rH,'F'); }
        alt=!alt;

        // Linea sottile
        doc.setDrawColor(...C_LINE); doc.setLineWidth(0.15); doc.line(ML,y+rH,ML+CW,y+rH);

        const ry = y + 3.8; // baseline testo
        doc.setFontSize(6.5); doc.setFont('helvetica','normal');
        doc.setTextColor(...C_TXT2); doc.text(fmtTime2(e.ts), C_ORA2, ry);
        doc.setTextColor(...typeCol); doc.setFont('helvetica','bold');
        doc.text(typeLabel, C_TIPO2, ry);
        doc.setTextColor(...C_TXT); doc.setFont('helvetica','normal');
        if(detail) doc.text(detail, C_DET2, ry, {maxWidth:C_GLIC2-C_DET2-3});
        if(glicStr){
          doc.setTextColor(...gColor(parseFloat(glicStr))); doc.setFont('helvetica','bold');
          doc.text(glicStr, C_GLIC2, ry);
        }
        if(carbStr){ doc.setTextColor(180,120,0); doc.setFont('helvetica','normal'); doc.text(carbStr, C_CARB2, ry); }
        if(insStr){ doc.setTextColor(...C_PURPLE); doc.setFont('helvetica','bold'); doc.text(insStr, C_INS2, ry); }

        y += rH;

        // Riga secondaria: lista cibi + macro
        if(hasExtra){
          checkY(4.5);
          doc.setFontSize(5.5); doc.setFont('helvetica','italic'); doc.setTextColor(...C_TXT3);
          let extraLines=[];
          if(e.foods&&e.foods.length>1){
            extraLines.push(e.foods.slice(0,6).join(', ')+(e.foods.length>6?' ...':''));
          }
          const mp=[];
          if(e.protein&&+e.protein) mp.push('Proteine: '+e.protein+'g');
          if(e.fat&&+e.fat)         mp.push('Grassi: '+e.fat+'g');
          if(e.fiber&&+e.fiber)     mp.push('Fibre: '+e.fiber+'g');
          if(mp.length) extraLines.push(mp.join('   '));
          extraLines.forEach(ln => {
            checkY(4.5);
            doc.text(ln, C_DET2+2, y+3, {maxWidth:C_INS2-C_DET2+20});
            y+=4;
          });
        }
      });

      // Micro-spazio fine giorno
      y += 4;
      doc.setDrawColor(195,205,220); doc.setLineWidth(0.4); doc.line(ML,y,ML+CW,y);
      y += 4;
    });
  }

  // ════════════════════════════════════════════════════
  //  FOOTER FINALE + NUMERI PAGINA
  // ════════════════════════════════════════════════════
  pageFooter();
  const totalPages = doc.internal.getNumberOfPages();
  for(let i=1;i<=totalPages;i++){
    doc.setPage(i);
    doc.setTextColor(...C_TXT3); doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.text(i+' / '+totalPages, PW-MR, PH-4, {align:'right'});
  }

  const gd_parts = getDK(cd).split('-');
  const gd = new Date(+gd_parts[0], +gd_parts[1]-1, +gd_parts[2]);
  const suffix = mode==='giorno'
    ? '_giorno_'+gd.getFullYear()+p2(gd.getMonth()+1)+p2(gd.getDate())
    : (mode==='all' ? '_completo' : '_'+mode);
  const filename='glucolog'+suffix+'_'+now.getFullYear()+p2(now.getMonth()+1)+p2(now.getDate())+'.pdf';
  const pdfBase64 = doc.output('datauristring').split(',')[1];
  await saveFile(filename, pdfBase64, 'application/pdf');
}


// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: ESPORTAZIONE CSV
// exportCSV(): genera un file CSV compatibile con Excel/Google Sheets.
//   Colonne: Data, Ora, Tipo, Momento/Tipo pasto, Valore/Cibo,
//            Trend, Carbo, Proteine, Grassi, Fibre, Bolo PRE,
//            Bolo POST, Unità insulina, Tipo insulina
//   Usa BOM UTF-8 (\uFEFF) per compatibilità Excel su Windows.
//   Chiama saveFile() per il download.
// ═══════════════════════════════════════════════════════════════
async function exportCSV(){
  const rows=[['Data','Ora','Tipo','Dettaglio','Pre','Post','Unit\u00E0','Farmaco','Carbo g','Prot g','Grassi g','Fibre g','Alcool U','Kcal']];
  ld().sort((a,b)=>a.ts-b.ts).forEach(e=>{
    const d=new Date(e.ts),dt=p2(d.getDate())+'/'+p2(d.getMonth()+1)+'/'+d.getFullYear(),t=p2(d.getHours())+':'+p2(d.getMinutes());
    if(e.type==='pasto')rows.push([dt,t,e.tipo||'Pasto',e.food||'',e.pre||'',e.post||'','','',e.carbs||'',e.protein||'',e.fat||'',e.fiber||'','','']);
    if(e.type==='spuntino')rows.push([dt,t,'Spuntino',e.food||'',e.pre||'',e.post||'','','',e.carbs||'',e.protein||'',e.fat||'',e.fiber||'','','']);
    if(e.type==='glicemia')rows.push([dt,t,'Glicemia',e.momento||'',e.value||'','','','','','','','','','']);
    if(e.type==='insulina')rows.push([dt,t,'Insulina',e.tipoIns||'','','',e.units||'',e.insulinType||'','','','','','','']);
    if(e.type==='alcool')rows.push([dt,t,'Alcool',e.label||'','','','','','','','','',e.units||'',e.kcal||'']);
  });
  const csvContent = rows.map(r=>r.map(c=>'"'+c+'"').join(',')).join('\n');
  const csvFilename = 'glucolog_'+new Date().toISOString().slice(0,10)+'.csv';
  await saveFile(csvFilename, csvContent, 'text/csv;charset=utf-8');
  toast('📥 CSV esportato');
}

async function exportCSV_unused(){}

// ── TOAST ───────────────────────────────────────────────
// Navigazione giorni solo tramite pulsanti ‹ ›, swipe disabilitato
let tt2;
// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: TOAST NOTIFICATION
// toast(m): mostra una notifica temporanea in basso per 2.5 secondi.
//   Aggiunge .on alla div #toast (che applica la transizione CSS).
//   Usa clearTimeout(tt2) per resettare il timer se chiamata di nuovo
//   prima che la precedente finisca.
// ═══════════════════════════════════════════════════════════════
function toast(m){const el=document.getElementById('toast');el.textContent=m;el.classList.add('on');clearTimeout(tt2);tt2=setTimeout(()=>el.classList.remove('on'),2500);}


// ── RICERCA NUTRIZIONALE VIA API ────────────────────────
// Priorità: 1) DB locale integrato → 2) OpenFoodFacts (IT)
// → 3) USDA FoodData Central (EN, con dizionario IT→EN)
// Mostra fino a 6 risultati con selezione porzione
// State per panel
const nutState = { P: null, S: null }; // selected food data per panel

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: RICERCA NUTRIZIONALE API
// searchNutrition(inputId, pre):
//   Cerca il cibo inserito in inputId nelle API nutrizionali.
//   Strategia a cascata:
//   1. Database locale FOODDB0 + personalizzato (ldDB()) — istantaneo
//   2. OpenFoodFacts API — database prodotti con barcode
//   3. USDA FoodData Central API — database ufficiale USA
//   Mostra i risultati in #nutResP o #nutResS con macronutrienti
//   e fonte (Local / OpenFoodFacts / USDA).
//
// fetchNutrition(query):
//   Fetch effettivo alle API con timeout e fallback.
//   Normalizza i risultati nelle stesse unità (per 100g).
//
// selectNutResult(idx, pre):
//   Seleziona un risultato dai search results:
//   - Popola il campo grammi con la porzione di default
//   - Mostra il box porzione per confermare i grammi
//   - Gestisce bevande (unità ml) vs alimenti solidi (unità g)
// ═══════════════════════════════════════════════════════════════
async function searchNutrition(inputId, pre) {
  const query = document.getElementById(inputId).value.trim();
  if (!query || query.length < 2) { toast('Scrivi il nome del cibo prima'); return; }

  const resDiv = document.getElementById('nutRes' + pre);
  const portDiv = document.getElementById('nutPort' + pre);
  const loadDiv = document.getElementById('loading' + pre);
  if(loadDiv) loadDiv.classList.add('on');
  resDiv.classList.remove('on');
  resDiv.innerHTML = '';
  portDiv.classList.remove('on');

  try {
    const results = await fetchNutrition(query);
    if(loadDiv) loadDiv.classList.remove('on');

    if (!results.length) {
      resDiv.innerHTML = '<div class="nut-err">Nessun risultato — prova con un termine più semplice (es. "pasta", "pollo")</div>';
      resDiv.classList.add('on');
      return;
    }

    resDiv.innerHTML = '<div class="nut-res-hdr">Seleziona il cibo più adatto (valori per 100g)</div>' +
      results.slice(0, 6).map((r, i) =>
        '<div class="nut-res-item" onclick="selectNutResult(' + i + ',\'' + pre + '\')">' +
          '<div class="nut-res-name">' + esc(r.name) + '</div>' +
          '<div class="nut-res-macros">' +
            '<span class="nut-res-m c">C ' + r.carbs + 'g</span>' +
            '<span class="nut-res-m p">P ' + r.protein + 'g</span>' +
            '<span class="nut-res-m g">G ' + r.fat + 'g</span>' +
            (r.fiber ? '<span class="nut-res-m f">F ' + r.fiber + 'g</span>' : '') +
            '<span class="nut-res-m k">' + r.kcal + ' kcal</span>' +
            '<span class="nut-res-src">' + r.source + '</span>' +
          '</div>' +
        '</div>'
      ).join('');

    // Store results in state
    nutState[pre] = results;
    resDiv.classList.add('on');

  } catch (err) {
    if(loadDiv) loadDiv.classList.remove('on');
    resDiv.innerHTML = '<div class="nut-err">Errore di rete — controlla la connessione</div>';
    resDiv.classList.add('on');
  }
}

// Italian→English dictionary for USDA lookup
const IT_EN = {
  'caffè macchiato':'espresso macchiato', 'cappuccino':'cappuccino coffee',
  'caffè':'espresso coffee', 'pizza':'pizza margherita', 'pizza margherita':'pizza margherita',
  'pasta':'pasta cooked', 'riso':'rice cooked', 'pane':'bread white',
  'pollo':'chicken breast cooked', 'manzo':'beef ground cooked',
  'salmone':'salmon cooked', 'tonno':'tuna canned', 'uova':'egg whole cooked',
  'latte':'milk whole', 'yogurt':'yogurt plain', 'yogurt greco':'yogurt greek',
  'mela':'apple raw', 'banana':'banana raw', 'arancia':'orange raw',
  'insalata':'lettuce raw', 'patate':'potato cooked', 'carote':'carrots cooked',
  'cioccolato':'chocolate dark', 'biscotti':'cookies', 'gelato':'ice cream',
  'formaggio':'cheese cheddar', 'mozzarella':'mozzarella cheese',
  'prosciutto':'ham cooked', 'salmone':'salmon atlantic cooked',
  'olio':'oil olive', 'burro':'butter', 'noci':'walnuts', 'mandorle':'almonds',
  'avocado':'avocado raw', 'fagioli':'beans cooked', 'ceci':'chickpeas cooked',
  'lenticchie':'lentils cooked', 'brodo':'broth chicken'
};

async function fetchNutrition(query) {
  const q = query.toLowerCase().trim();
  const results = [];

  // 1. Search local built-in DB first (exact + partial matches)
  const db = ldDB();
  const localMatches = Object.keys(db).filter(k => k.includes(q) || q.includes(k));
  localMatches.forEach(k => {
    const e = db[k];
    results.push({
      name: k.charAt(0).toUpperCase() + k.slice(1),
      carbs: e.c||0, protein: e.p||0, fat: e.g||0, fiber: e.f||0,
      kcal: e.k || Math.round((e.c||0)*4+(e.p||0)*4+(e.g||0)*9),
      source: '📱 DB'
    });
  });

  // 2. OpenFoodFacts with Italian language filter (good for Italian products)
  try {
    const offUrl = 'https://world.openfoodfacts.org/cgi/search.pl?' +
      'search_terms=' + encodeURIComponent(query) +
      '&json=1&page_size=8&search_simple=1&action=process' +
      '&lc=it&fields=product_name,nutriments';
    const r = await fetch(offUrl, { headers: { 'User-Agent': 'GlicoLog/1.0' } });
    if (r.ok) {
      const data = await r.json();
      (data.products || []).forEach(p => {
        const nm = p.nutriments || {};
        const name = (p.product_name||'').trim();
        if (!name || name.length < 2) return;
        const carbs = nm['carbohydrates_100g'];
        const protein = nm['proteins_100g'];
        if (carbs == null && protein == null) return;
        if (!carbs && !protein && !nm['fat_100g']) return; // skip empty
        results.push({
          name: name,
          carbs: Math.round((carbs||0)*10)/10,
          protein: Math.round((protein||0)*10)/10,
          fat: Math.round((nm['fat_100g']||0)*10)/10,
          fiber: Math.round((nm['fiber_100g']||0)*10)/10,
          kcal: Math.round(nm['energy-kcal_100g'] || nm['energy_100g']/4.18 || 0),
          source: 'OFF'
        });
      });
    }
  } catch(e) {}

  // 3. USDA with translated query (for generic ingredients)
  if (results.length < 3) {
    const enQ = IT_EN[q] || query;
    try {
      const usdaUrl = 'https://api.nal.usda.gov/fdc/v1/foods/search?' +
        'query=' + encodeURIComponent(enQ) +
        '&api_key=DEMO_KEY&dataType=SR%20Legacy,Foundation%20Food&pageSize=5';
      const r = await fetch(usdaUrl);
      if (r.ok) {
        const data = await r.json();
        (data.foods || []).forEach(f => {
          const n = {};
          (f.foodNutrients || []).forEach(fn => {
            if (fn.nutrientId === 1003) n.protein = fn.value;
            if (fn.nutrientId === 1004) n.fat = fn.value;
            if (fn.nutrientId === 1005) n.carbs = fn.value;
            if (fn.nutrientId === 1079) n.fiber = fn.value;
            if (fn.nutrientId === 1008) n.kcal = fn.value;
          });
          if (n.carbs != null || n.protein != null) {
            // Show translated name + original query for context
            const displayName = f.description.toLowerCase().includes(enQ.toLowerCase())
              ? f.description : f.description + ' (' + enQ + ')';
            results.push({
              name: displayName,
              carbs: Math.round((n.carbs||0)*10)/10,
              protein: Math.round((n.protein||0)*10)/10,
              fat: Math.round((n.fat||0)*10)/10,
              fiber: Math.round((n.fiber||0)*10)/10,
              kcal: Math.round(n.kcal || ((n.carbs||0)*4+(n.protein||0)*4+(n.fat||0)*9)),
              source: 'USDA'
            });
          }
        });
      }
    } catch(e) {}
  }

  // Deduplicate by name, sort: local DB first, then completeness
  const seen = new Set();
  return results.filter(r => {
    const k = r.name.toLowerCase().slice(0,20);
    if (seen.has(k)) return false;
    seen.add(k); return true;
  }).sort((a,b) => {
    if (a.source==='📱 DB' && b.source!=='📱 DB') return -1;
    if (b.source==='📱 DB' && a.source!=='📱 DB') return 1;
    const sA=(a.carbs>0?1:0)+(a.protein>0?1:0)+(a.fat>0?1:0)+(a.fiber>0?1:0)+(a.kcal>0?1:0);
    const sB=(b.carbs>0?1:0)+(b.protein>0?1:0)+(b.fat>0?1:0)+(b.fiber>0?1:0)+(b.kcal>0?1:0);
    return sB-sA;
  }).slice(0,6);
}

function selectNutResult(idx, pre) {
  const food = nutState[pre][idx];
  if (!food) return;

  // Hide results, show portion selector
  document.getElementById('nutRes' + pre).classList.remove('on');
  document.getElementById('nutPortName' + pre).textContent = food.name;
  document.getElementById('nutPort' + pre).classList.add('on');
  // Aggiorna UI in base al tipo (cibo/bevanda)
  updatePortionUI(pre, food.name, isDrinkName(food.name || ''));
  // Riapplica il nome nel title (updatePortionUI ricrea l'HTML)
  const pn = document.getElementById('nutPortName'+pre);
  if (pn) pn.textContent = food.name;

  // Store selected food on state
  nutState[pre + '_selected'] = food;

  // Scroll to portion box
  setTimeout(() => document.getElementById('nutPort' + pre).scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
}

// applyPortion: see MULTI-FOOD ROWS section below

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}


// ── CHECK GLICEMIA INLINE NEL PASTO ────────────────────
// Avviso colorato in tempo reale mentre si digita
// la glicemia PRE nel form pasto/spuntino
function onMealGlicInput(val, pre) {
  const n = parseInt(val), warnEl = document.getElementById('mealGlicWarn' + pre);
  if (!n || !warnEl) return;
  if (n < 70) {
    warnEl.style.display = 'block';
    warnEl.style.background = 'rgba(255,82,82,.12)';
    warnEl.style.border = '1px solid rgba(255,82,82,.3)';
    warnEl.style.color = '#ff5252';
    warnEl.innerHTML = '&#128308; <strong>Ipoglicemia!</strong> ' + n + ' mg/dL &mdash; considera ' + (ldC().carbFactor||15) + 'g di zuccheri rapidi prima di mangiare.';
  } else if (n > 200) {
    warnEl.style.display = 'block';
    warnEl.style.background = 'rgba(255,171,64,.1)';
    warnEl.style.border = '1px solid rgba(255,171,64,.3)';
    warnEl.style.color = '#ffab40';
    const cfg = ldC(), exc = n - Math.round((cfg.targetMin+cfg.targetMax)/2);
    const u = roundBoloForIns(exc/cfg.fsi, cfg.insRapida);
    warnEl.innerHTML = '&#128992; <strong>Glicemia alta!</strong> ' + n + ' mg/dL &mdash; valuta ' + u + 'U di ' + cfg.insRapida + ' (FSI ' + cfg.fsi + ').';
  } else {
    warnEl.style.display = 'none';
    warnEl.innerHTML = '';
  }
}


// ── RIGHE ALIMENTO MULTIPLE ────────────────────────────
// Ogni pasto può avere N alimenti; ogni riga ha input testo
// + bottone ricerca API + autocomplete + rimozione
let foodRowCount = {P:0, S:0};

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: SISTEMA FOOD ROWS (righe multiple alimento)
// Ogni pannello pasto/spuntino supporta N righe alimento con:
//   - Input nome + autocomplete (showAC)
//   - Input grammi inline + unità (g o ml per bevande)
//   - Chips macro calcolate per la porzione specifica
//   - Bottone elimina riga
//
// foodRowCount['P'/'S']: contatore ID progressivo per le righe
//
// addFoodRow(pre, prefill):
//   Aggiunge una nuova riga .food-row al container #foodRowsP/S.
//   Se prefill è fornito (es. in fillE), precompila nome/grammi.
//   Allega event listener input per autocomplete e ricalcolo macro.
//
// removeFoodRow(rowId, pre):
//   Rimuove la riga con id=rowId e ricalcola i totali.
//
// initFoodRows(pre):
//   Azzera il container e aggiunge la prima riga vuota.
//
// getFoodNames(pre):
//   Legge tutti i nomi dalla food rows (per il campo food del save).
//
// searchNutritionRow(inputId, pre, idx, btn):
//   Avvia ricerca API per una specifica riga (wrapper di searchNutrition).
//
// recalcFoodRowEl(rowEl, pre, idx):
//   Per una riga specifica: legge grammi + dati per-100g dal dataset,
//   calcola macro proporzionali (grammi/100 × macroNutrient100g),
//   aggiorna le chips visuali e i totali aggregati.
//
// recalcAllRows(pre):
//   Chiama recalcFoodRowEl su tutte le righe e aggiorna i campi
//   macro aggregati mPC/mPP/mPG/mPF (o S).
//
// isDrinkName(name): true se il nome suggerisce una bevanda (latte, succo, ecc.)
//
// getFoodList(pre):
//   Ritorna array di oggetti {name, isDrink, grams, c100, p100, g100, f100}
//   per tutte le righe. Usato da savePasto/saveSpunt.
//
// updatePortionUI(pre, foodName, isDrink):
//   Aggiorna il box porzione (testo, unità ml/g, bottoni bevanda).
//
// setBevUnit(pre, ml, label):
//   Seleziona una porzione predefinita per bevanda (es. 33cl lattina).
//
// calcSugarCarbs(pre):
//   Converte cucchiaini di zucchero → grammi carboidrati (1 tsp = 4g).
//
// renderFoodList(entry):
//   Genera HTML lista alimenti per la timeline (nome + porzione).
//
// applyPortion(pre):
//   Conferma i grammi inseriti nel box porzione → popola i campi macro
//   proporzionali e aggiorna la riga selezionata.
// ═══════════════════════════════════════════════════════════════
function addFoodRow(pre, prefill) {
  const container = document.getElementById('foodRows'+pre);
  const idx = ++foodRowCount[pre];
  const rowId   = 'fr'+pre+idx;
  const inputId = 'iF'+pre+idx;
  const acId    = 'acFR'+pre+idx;
  const gramsId = 'frg'+pre+idx;
  const unitId  = 'fru'+pre+idx;
  const macId   = 'frm'+pre+idx;

  const row = document.createElement('div');
  row.className = 'food-row';
  row.id = rowId;
  if (prefill) {
    row.dataset.c100 = prefill.c100||0;
    row.dataset.p100 = prefill.p100||0;
    row.dataset.g100 = prefill.g100||0;
    row.dataset.f100 = prefill.f100||0;
    row.dataset.isDrink = prefill.isDrink?'1':'';
    row.dataset.sugarCarbs = prefill.sugarCarbs||0;
  }

  const isFirst = idx === 1;
  row.innerHTML =
    '<div class="fr-top">' +
      '<div class="fr-name-wrap">' +
        '<input class="fi fr-name-inp" id="'+inputId+'" type="text" placeholder="Cerca alimento…" autocomplete="off"' +
               ' oninput="showAC(this.value,&apos;'+acId+'&apos;,&apos;'+pre+'&apos;)" autocorrect="off" spellcheck="false">' +
        '<div class="ac" id="'+acId+'"></div>' +
      '</div>' +
      '<div class="fr-right">' +
        '<div class="fr-qty-wrap">' +
          '<input class="fi fr-qty-inp" id="'+gramsId+'" type="number" inputmode="decimal"' +
                 ' placeholder="100" oninput="recalcAllRows(&apos;'+pre+'&apos;)">' +
          '<span class="fr-unit" id="'+unitId+'">g</span>' +
        '</div>' +
        '<button class="fr-del-btn" title="Rimuovi" onclick="removeFoodRow(&apos;'+rowId+'&apos;,&apos;'+pre+'&apos;)">×</button>' +
      '</div>' +
    '</div>' +
    '<div class="fr-macros" id="'+macId+'"></div>';

  container.appendChild(row);

  if (prefill) {
    setTimeout(() => {
      const inp = document.getElementById(inputId);
      if (inp) inp.value = prefill.name || '';
      const gramsEl = document.getElementById(gramsId);
      if (gramsEl) gramsEl.value = prefill.grams || '';
      const unitEl = document.getElementById(unitId);
      if (unitEl) unitEl.textContent = prefill.isDrink ? 'ml' : 'g';
      recalcAllRows(pre);
    }, 30);
  }
}

function removeFoodRow(rowId, pre) {
  const el = document.getElementById(rowId);
  if (!el) return;

  const container = document.getElementById('foodRows' + pre);
  const allRows = container ? container.querySelectorAll('.food-row') : [];
  const isFirst = allRows.length > 0 && allRows[0].id === rowId;

  if (isFirst) {
    // Prima riga: svuota i campi invece di rimuoverla
    const inp = el.querySelector('input[type="text"]');
    const qty = el.querySelector('input[type="number"]');
    const unit = el.querySelector('.fr-unit');
    const macros = el.querySelector('.fr-macros');
    if (inp)    inp.value = '';
    if (qty)    qty.value = '';
    if (unit)   unit.textContent = 'g';
    if (macros) macros.innerHTML = '';
    // Reset dataset nutritional values
    el.dataset.c100 = 0; el.dataset.p100 = 0;
    el.dataset.g100 = 0; el.dataset.f100 = 0;
    el.dataset.isDrink = ''; el.dataset.sugarCarbs = 0;
    // Close any open autocomplete
    el.querySelectorAll('.ac.on').forEach(ac => ac.classList.remove('on'));
  } else {
    el.remove();
  }

  recalcAllRows(pre);
}

function initFoodRows(pre) {
  // Reset rows
  foodRowCount[pre] = 0;
  document.getElementById('foodRows'+pre).innerHTML = '';
  addFoodRow(pre);
}

function getFoodNames(pre) {
  const rows = document.getElementById('foodRows'+pre);
  if (!rows) return '';
  const names = [];
  rows.querySelectorAll('input[type="text"]').forEach(inp => {
    const v = inp.value.trim();
    if (v) names.push(v);
  });
  return names.join(', ');
}

// Modified showAC to work with dynamic row inputs
// showAC e pickACrow deduplicati — usare le versioni sopra

// function searchNutritionRow(inputId, pre, idx, btn) {
//   // Set active search context and call main search
//   nutState['activeInput'] = inputId;
//   nutState['activeIdx'] = idx;
//   nutState['callerBtn'+pre] = btn || null;
//   searchNutrition(inputId, pre);
// }

// Override applyPortion to also fill food name in the active row



// ── Arrotondamento bolo in base al tipo insulina ─────────────
// Insuline senza mezze unità (Humalog, NovoRapid, Apidra, Fiasp, Lyumjev, Toujeo, Lantus...):
//   arrotonda al numero intero più vicino, con preferenza verso il basso se bassa/stabile
//   e verso l'alto se alta/in salita.
// Insuline con mezze unità (es. FlexPen mezze, NovoPen Echo): arrotonda a 0.5U.
// Se insRapida non è specificata, usa intero.
const HALF_UNIT_INSULINS = ['novopenecho','flexpen','novopen echo','half unit'];
function roundBoloForIns(rawU, insRapida) {
  if (rawU <= 0) return 0;
  const name = (insRapida||'').toLowerCase();
  const isHalf = HALF_UNIT_INSULINS.some(k => name.includes(k));
  if (isHalf) return Math.round(rawU * 2) / 2;
  return Math.round(rawU); // interi per Humalog, NovoRapid, Apidra, Fiasp, Toujeo, ecc.
}

// ── RICALCOLO MACRO PER RIGA E TOTALE ─────────────────────────
// recalcAllRows(pre): ricalcola tutti i total macro fields
// sommando i contributi di ogni riga con grammi e dati per 100g

function recalcFoodRowEl(rowEl, pre, idx) {
  const gramsEl = document.getElementById('frg'+pre+idx);
  const macEl   = document.getElementById('frm'+pre+idx);
  const unitEl  = document.getElementById('fru'+pre+idx);
  if (!gramsEl || !macEl) return { c:0, p:0, g:0, f:0 };
  const grams = parseFloat(gramsEl.value) || 0;
  const c100 = parseFloat(rowEl.dataset.c100)||0;
  const p100 = parseFloat(rowEl.dataset.p100)||0;
  const g100 = parseFloat(rowEl.dataset.g100)||0;
  const f100 = parseFloat(rowEl.dataset.f100)||0;
  const factor = grams / 100;
  const cv = Math.round(c100*factor*10)/10;
  const pv = Math.round(p100*factor*10)/10;
  const gv = Math.round(g100*factor*10)/10;
  const fv = Math.round(f100*factor*10)/10;
  // Aggiorna mini chips nella riga
  macEl.innerHTML = (grams > 0 && (c100||p100||g100)) ? [
    cv?'<span class="food-row-mac-chip">C <span>'+cv+'g</span></span>':'',
    pv?'<span class="food-row-mac-chip">P <span>'+pv+'g</span></span>':'',
    gv?'<span class="food-row-mac-chip">G <span>'+gv+'g</span></span>':'',
    fv?'<span class="food-row-mac-chip">F <span>'+fv+'g</span></span>':''
  ].filter(Boolean).join('') : '<span style="font-size:.66rem;color:var(--txt2)">inserisci grammi →</span>';
  return { c:cv, p:pv, g:gv, f:fv };
}

function recalcAllRows(pre) {
  const container = document.getElementById('foodRows'+pre);
  if (!container) return;
  let totC=0, totP=0, totG=0, totF=0;
  container.querySelectorAll('.food-row').forEach(row => {
    // Estrai idx dall'id del row (frP1 → 1, frS2 → 2)
    const m = row.id.match(/^fr[PS](\d+)$/);
    if (!m) return;
    const idx = parseInt(m[1]);
    const res = recalcFoodRowEl(row, pre, idx);
    totC += res.c; totP += res.p; totG += res.g; totF += res.f;
  });
  // Aggiorna i campi totale
  const suffix = pre === 'P' ? 'P' : 'S';
  const setMacro = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = val > 0 ? Math.round(val*10)/10 : '';
  };
  setMacro('m'+suffix+'C', totC);
  setMacro('m'+suffix+'P', totP);
  setMacro('m'+suffix+'G', totG);
  setMacro('m'+suffix+'F', totF);
  // ── Calcolo automatico bolo insulinico dai carboidrati ──
  if (totC > 0) {
    const cfg = ldC();
    const ic = parseFloat(cfg.ic) || 10;
    const rawBolo = totC / ic;
    const boloCalc = roundBoloForIns(rawBolo, cfg.insRapida);
    const boloFieldId = pre === 'P' ? 'iBP' : 'iSBP';
    const boloEl = document.getElementById(boloFieldId);
    if (boloEl && !boloEl.dataset.manualOverride) {
      boloEl.value = boloCalc > 0 ? boloCalc : '';
      boloEl.title = 'Auto: '+totC+'g ÷ 1:'+ic+' = '+boloCalc+'U (arrotondato per '+( cfg.insRapida||'insulina')+')';
    }
  }
}

// ── BEVANDA: unità e zucchero ────────────────────────────────
// Lista di parole chiave per riconoscere automaticamente una bevanda
const DRINK_KEYWORDS = ['latte','caffè','caffe','cappuccino','tè','te','tisana','acqua',
  'succo','coca','aranciata','sprite','birra','vino','limonata','smoothie','shake',
  'proteico','energy','red bull','monster','bevanda','drink','juice','cola','fanta',
  'gatorade','kefir','yogurt da bere','latte di','bevanda di'];

function isDrinkName(name) {
  const n = name.toLowerCase();
  return DRINK_KEYWORDS.some(k => n.includes(k));
}

// Restituisce array [{name, isDrink}] da tutte le righe alimento
function getFoodList(pre) {
  const rows = document.getElementById('foodRows' + pre);
  if (!rows) return [];
  const list = [];
  rows.querySelectorAll('.food-row').forEach((row, i) => {
    const inp = row.querySelector('input[type="text"]');
    if (!inp || !inp.value.trim()) return;
    const m = row.id.match(/^fr[PS](\d+)$/);
    const idx = m ? m[1] : (i+1);
    const gramsEl = document.getElementById('frg'+pre+idx);
    const grams = gramsEl ? (parseFloat(gramsEl.value)||null) : null;
    list.push({
      name: inp.value.trim(),
      isDrink: isDrinkName(inp.value.trim()),
      grams,
      c100: parseFloat(row.dataset.c100)||null,
      p100: parseFloat(row.dataset.p100)||null,
      g100: parseFloat(row.dataset.g100)||null,
      f100: parseFloat(row.dataset.f100)||null,
      sugarCarbs: parseFloat(row.dataset.sugarCarbs)||0
    });
  });
  return list;
}

// Quando l'utente seleziona un alimento dalla ricerca API
// controlla se è una bevanda e mostra UI appropriata
function updatePortionUI(pre, foodName, isDrink) {
  const title  = document.getElementById('nutPortTitle' + pre);
  const bevDiv = document.getElementById('bevUnits' + pre);
  const unit   = document.getElementById('nutUnit' + pre);
  const sugarRow = document.getElementById('sugarRow' + pre);
  const gramsInput = document.getElementById('nutGrams' + pre);

  if (isDrink || isDrinkName(foodName || '')) {
    if (title) title.innerHTML = '🥤 Quanti ne hai bevuto? <span id="nutPortName'+pre+'" style="color:var(--nut)"></span>';
    if (bevDiv) bevDiv.style.display = 'flex';
    if (unit)   unit.textContent = 'ml';
    if (gramsInput) gramsInput.placeholder = 'ml (es. 200)';
    if (sugarRow) sugarRow.style.display = 'flex';
  } else {
    if (title) title.innerHTML = '⚖️ Quanti grammi? <span id="nutPortName'+pre+'" style="color:var(--nut)"></span>';
    if (bevDiv) bevDiv.style.display = 'none';
    if (unit)   unit.textContent = 'g';
    if (gramsInput) gramsInput.placeholder = 'es. 80';
    if (sugarRow) sugarRow.style.display = 'none';
  }
}

// Imposta ml da bottone rapido bevanda
function setBevUnit(pre, ml, label) {
  document.getElementById('nutGrams' + pre).value = ml;
  // Deseleziona tutti, seleziona quello cliccato
  document.querySelectorAll('#bevUnits'+pre+' .bev-btn').forEach(b => b.classList.remove('on'));
  event.target.classList.add('on');
}

// Calcola carbo da cucchiaini di zucchero (1 cucchiaino ≈ 4g zucchero = 4g carbo)
function calcSugarCarbs(pre) {
  const tsp = parseFloat(document.getElementById('sugarTeasp' + pre).value) || 0;
  const carbs = Math.round(tsp * 4 * 10) / 10;
  document.getElementById('sugarCarbs' + pre).textContent = carbs;
}

// Renderizza lista alimenti nella timeline card — una riga per alimento
function renderFoodList(entry) {
  // Supporta sia il nuovo campo foods[] che il vecchio campo food (stringa)
  if (entry.foods && entry.foods.length > 0) {
    const rows = entry.foods.map(f => {
      const icon = f.isDrink ? '🥤' : '🍽️';
      return '<div class="tf" style="margin-bottom:1px">' + icon + ' ' + esc(f.name) + '</div>';
    }).join('');
    return rows;
  }
  // Fallback retrocompatibile: vecchio campo food stringa
  if (entry.food) {
    const names = entry.food.split(',').map(s => s.trim()).filter(Boolean);
    return names.map(n => '<div class="tf">' + esc(n) + '</div>').join('');
  }
  return '';
}

// ── PASSI ────────────────────────────────────────────────────
// Storage: {ts, steps, stride} salvato in localStorage key 'GL_steps'

const STEPS_KEY = 'GL_steps';

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: TRACKER PASSI
// Storage: localStorage 'GL_steps' → array di {date:'YYYY-MM-DD', steps, stride, kcal}
//
// ldSteps() / svSteps(arr): read/write localStorage
//
// openStepsModal(): apre il modal di inserimento manuale passi
// closeStepsModal(): chiude il modal
//
// updateStepsKmPreview(): aggiorna preview km/kcal in tempo reale
//   mentre l'utente digita. Usa stride (lunghezza passo, default 75cm)
//   e peso dalla config per calcolare kcal ≈ passi × peso × 0.0005.
//
// saveSteps(): salva/aggiorna la voce passi del giorno corrente (getDK(cd)).
//   Chiude il modal e aggiorna strip + summary.
//
// getStepsForDay(dateKey): ritorna la voce passi per una specifica data
// getWeekSteps(): ritorna array delle voci dalla settimana corrente
// ═══════════════════════════════════════════════════════════════
function ldSteps() {
  try { return JSON.parse(localStorage.getItem(STEPS_KEY)) || []; } catch(e) { return []; }
}
function svSteps(arr) {
  localStorage.setItem(STEPS_KEY, JSON.stringify(arr));
}

// Apre il modal inserimento passi
function openStepsModal() {
  const today = getDK(0);
  const existing = ldSteps().find(s => s.date === today);
  document.getElementById('stepsInput').value = existing ? existing.steps : '';
  document.getElementById('strideInput').value = existing ? (existing.stride || 75) : 75;
  updateStepsKmPreview();
  // Mostra pulsante sync solo se Health Connect è disponibile
  const hasHC = !!(window.Capacitor?.Plugins?.HealthConnect);
  const btnSync = document.getElementById('btnSyncHealth');
  const hint = document.getElementById('stepsModalHint');
  if (btnSync) btnSync.style.display = hasHC ? 'block' : 'none';
  if (hint) hint.textContent = hasHC
    ? 'Sincronizza automaticamente da Health Connect oppure inserisci manualmente.'
    : 'Inserisci manualmente i passi del giorno.';
  document.getElementById('stepsModal').classList.add('on');
}
function closeStepsModal() {
  document.getElementById('stepsModal').classList.remove('on');
}

// Aggiorna anteprima km in tempo reale
function updateStepsKmPreview() {
  const steps = parseInt(document.getElementById('stepsInput').value) || 0;
  const stride = parseFloat(document.getElementById('strideInput').value) || 75;
  const km = Math.round(steps * stride / 100000 * 10) / 10;
  const prev = document.getElementById('stepsKmPreview');
  if (prev) prev.textContent = steps > 0 ? '→ ' + km + ' km circa' : '';
}

// Salva i passi di oggi
function saveSteps() {
  const steps = parseInt(document.getElementById('stepsInput').value);
  const stride = parseFloat(document.getElementById('strideInput').value) || 75;
  if (!steps || steps < 0) { toast('Inserisci un numero di passi valido'); return; }
  const today = getDK(0);
  const arr = ldSteps().filter(s => s.date !== today);
  arr.push({ date: today, steps, stride, ts: Date.now() });
  svSteps(arr);
  closeStepsModal();
  renderSummary();
  toast('✅ ' + steps.toLocaleString('it') + ' passi salvati');
}

// Ottieni passi per una data (YYYY-MM-DD)
function getStepsForDay(dateKey) {
  return ldSteps().find(s => s.date === dateKey) || null;
}

// Ottieni steps settimana corrente
function getWeekSteps() {
  const now = new Date();
  const dow = now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() - (dow===0?6:dow-1));
  monday.setHours(0,0,0,0);
  return ldSteps().filter(s => new Date(s.date) >= monday);
}

function applyPortion(pre) {
  const food = nutState[pre + '_selected'];
  let grams = parseFloat(document.getElementById('nutGrams' + pre).value);
  if (!food) { toast('Seleziona prima un alimento'); return; }
  if (!grams || grams <= 0) { toast('Inserisci la quantità'); return; }
  // Zucchero aggiunto (bevanda)
  const sugarTsp = parseFloat(document.getElementById('sugarTeasp'+pre)?.value) || 0;
  const sugarCarbs = Math.round(sugarTsp * 4 * 10) / 10;
  const isDrink = isDrinkName(food.name||'');

  // Trova la riga attiva tramite activeInput id (es. "iFP2" → rowId "frP2")
  const activeInputId = nutState['activeInput']; // es. "iFP2"
  let targetRow = null, targetIdx = null;
  if (activeInputId) {
    // Formato: iF{pre}{idx} → frg{pre}{idx}
    const m = activeInputId.match(/^iF([PS])(\d+)$/);
    if (m) {
      targetIdx = m[2];
      const rowId = 'fr'+m[1]+m[2];
      targetRow = document.getElementById(rowId);
      // Imposta nome nella riga se vuoto
      const inp = document.getElementById(activeInputId);
      if (inp && !inp.value.trim()) inp.value = food.name;
    }
  }

  if (targetRow && targetIdx) {
    // ── NUOVO: salva per-100g sul row, imposta grammi, mostra detail
    targetRow.dataset.c100 = food.carbs || 0;
    targetRow.dataset.p100 = food.protein || 0;
    targetRow.dataset.g100 = food.fat || 0;
    targetRow.dataset.f100 = food.fiber || 0;
    targetRow.dataset.isDrink = isDrink ? '1' : '';
    // Zucchero extra: aggiungi ai carbo per 100g proporzionalmente
    // (lo aggiungiamo direttamente come carbo extra fisso nella riga)
    targetRow.dataset.sugarCarbs = sugarCarbs;

    const gramsEl = document.getElementById('frg'+pre+targetIdx);
    if (gramsEl) gramsEl.value = grams;
    const unitEl = document.getElementById('fru'+pre+targetIdx);
    if (unitEl) unitEl.textContent = isDrink ? 'ml' : 'g';
    const detEl = document.getElementById('frd'+pre+targetIdx);
    if (detEl) detEl.style.display = 'block';
    recalcAllRows(pre);
  } else {
    // Fallback: accumula come prima (nessuna riga attiva trovata)
    const factor = grams / 100;
    const addTo = (id, val) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.value = Math.round(((parseFloat(el.value)||0) + val*factor)*10)/10;
    };
    addTo('m'+pre+'C', food.carbs);
    addTo('m'+pre+'P', food.protein);
    addTo('m'+pre+'G', food.fat);
    addTo('m'+pre+'F', food.fiber);
    if (sugarCarbs > 0) {
      const cEl = document.getElementById('m'+pre+'C');
      if (cEl) cEl.value = Math.round(((parseFloat(cEl.value)||0) + sugarCarbs)*10)/10;
    }
  }

  learnFood(food.name.toLowerCase(), food.carbs, food.protein, food.fat, food.fiber);
  document.getElementById('nutPort' + pre).classList.remove('on');
  toast('✅ Aggiunto ' + grams + (isDrink?'ml':'g') + ' · +' + Math.round((food.carbs||0)*grams/100*10)/10 + 'g C');
}


// ── TRACCIAMENTO SPORT ─────────────────────────────────
// Calcola kcal = MET × peso(kg) × ore
// Le kcal bruciate vengono sommate al budget calorico giornaliero
const SPORTMET = {}; // built from select options dynamically

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: TRACKER SPORT / ATTIVITÀ FISICA
// updSportKcal(): aggiorna il box preview kcal bruciate in tempo reale
//   in base al tipo di sport e alla durata inserita.
//   Usa una mappa di MET (Metabolic Equivalent of Task) per ogni sport,
//   moltiplicata per peso e durata: kcal = MET × peso × ore.
//
// saveSport(): salva la voce sport con:
//   - tipo attività (corsa, ciclismo, nuoto, palestra, ecc.)
//   - durata in minuti
//   - nota libera
//   - kcal calcolate
// ═══════════════════════════════════════════════════════════════
function updSportKcal() {
  const sel = document.getElementById('iSportType');
  const dur = parseInt(document.getElementById('iSportDur').value) || 60;
  if (!sel.value) { document.getElementById('sportKcalBox').classList.remove('on'); return; }
  const [name, metStr] = sel.value.split('|');
  const met = parseFloat(metStr) || 5;
  const cfg = ldC();
  const weight = cfg.weight || 80;
  // Kcal = MET × weight(kg) × hours
  const kcal = Math.round(met * weight * (dur / 60));
  const newTotal = (cfg.kcal || 2000) + kcal;
  document.getElementById('sportKcalVal').textContent = kcal + ' kcal';
  document.getElementById('sportNewKcal').textContent = newTotal + ' kcal oggi';
  document.getElementById('sportKcalBox').classList.add('on');
}

function saveSport() {
  const sel = document.getElementById('iSportType');
  if (!sel.value) { toast('Seleziona il tipo di attività'); return; }
  const [sportName, metStr] = sel.value.split('|');
  const label = sel.options[sel.selectedIndex].text;
  const dur = parseInt(document.getElementById('iSportDur').value) || 60;
  const note = document.getElementById('iSportNote').value.trim();
  const cfg = ldC();
  const kcal = Math.round(parseFloat(metStr) * (cfg.weight||80) * (dur/60));
  const data = ld(), eid = document.getElementById('eiSP').value;
  const entry = { sportType: sel.value, sportName, label, duration: dur, kcal, note, ts: getTs('tSP_t') };
  if (eid) {
    const i = data.findIndex(e => e.id === eid);
    if (i > -1) data[i] = Object.assign({}, data[i], entry);
  } else {
    data.push(Object.assign({ id: uid(), type: 'sport' }, entry));
  }
  sv(data); closePanel(); renderTL(); renderStrip();
  const durLbl = dur >= 60 ? Math.floor(dur/60)+'h'+(dur%60?''+dur%60+'m':'') : dur+'min';
  toast('🏃 ' + label + ' · ' + durLbl + ' · ' + kcal + ' kcal');
}


// ── BARCODE SCANNER ──
// Su APK Capacitor: getUserMedia() triggera automaticamente il popup
// di permesso nativo Android, purché CAMERA sia nel manifest.
// Non serve dialog JS custom — il sistema operativo gestisce tutto.
let scanStream = null, scanAnimFrame = null, scanPre = null;
let barcodeDetector = null;

// Apre lo scanner: su APK Android chiede i permessi nativamente
// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: BARCODE SCANNER
// Scanner EAN/QR per la ricerca nutrizionale tramite codice a barre.
// Usa la libreria ZXing (caricata lazy via loadZXing()).
//
// openScanner(pre): apre overlay camera fullscreen (.scan-ov.on)
//   e avvia il loop di scansione.
//
// scanLoop(): loop requestAnimationFrame che legge frame dalla camera
//   e li passa a ZXing per il decode. Si ferma quando trova un barcode.
//
// loadZXing(): carica ZXing dalla CDN se non già caricato.
//
// startZXing(): configura il decoder per EAN-13/EAN-8/QR e avvia la camera.
//
// handleBarcode(barcode):
//   1. Cerca il prodotto su OpenFoodFacts API (barcode = EAN/UPC)
//   2. Se trovato: mostra il risultato con nome, marca e macronutrienti
//   3. Se non trovato: mostra messaggio e permette ricerca manuale
//
// closeScanner(): ferma camera, nasconde overlay, cleanup.
//
// manualBarcode(): permette inserimento manuale del codice se la camera
//   non riesce a leggere (pulsante nel bottom hint).
// ═══════════════════════════════════════════════════════════════
async function openScanner(pre) {
  scanPre = pre;
  try {
    // Prova BarcodeDetector nativa (Chrome Android 83+, iOS 17+)
    if ('BarcodeDetector' in window) {
      barcodeDetector = new BarcodeDetector({
        formats: ['ean_13','ean_8','upc_a','upc_e','code_128','qr_code']
      });
    }
    // getUserMedia: su APK Capacitor triggera il dialog Android nativo
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width:{ideal:1280}, height:{ideal:720} }
    });
    scanStream = stream;
    document.getElementById('scanOv').classList.add('on');
    const video = document.getElementById('scanVideo');
    video.srcObject = stream;
    video.play();
    if (barcodeDetector) {
      scanLoop(); // usa API nativa, zero latency
    } else {
      loadZXing(); // fallback CDN ZXing
    }
  } catch(e) {
    if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
      // Permesso negato dall'utente
      toast('\u26A0\uFE0F Accesso fotocamera negato. Abilita dai Permessi app.');
    } else if (e.name === 'NotFoundError') {
      toast('\u274C Fotocamera non trovata sul dispositivo.');
    } else {
      toast('\u274C Fotocamera non disponibile: ' + e.message);
    }
  }
}

// Loop di scansione con BarcodeDetector nativa (requestAnimationFrame)
function scanLoop() {
  const video = document.getElementById('scanVideo');
  if (!video.readyState || video.readyState < 2) {
    scanAnimFrame = requestAnimationFrame(scanLoop);
    return;
  }
  barcodeDetector.detect(video).then(codes => {
    if (codes.length > 0 && codes[0].rawValue) {
      handleBarcode(codes[0].rawValue);
    } else {
      scanAnimFrame = requestAnimationFrame(scanLoop);
    }
  }).catch(() => { scanAnimFrame = requestAnimationFrame(scanLoop); });
}

// Carica ZXing da CDN come fallback per dispositivi senza BarcodeDetector
function loadZXing() {
  if (document.getElementById('zxingScript')) { startZXing(); return; }
  const script = document.createElement('script');
  script.id = 'zxingScript';
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.20.0/zxing.min.js';
  script.onload = startZXing;
  script.onerror = () => toast('Libreria scanner non caricata. Inserisci il barcode manualmente.');
  document.head.appendChild(script);
}

function startZXing() {
  try {
    const video = document.getElementById('scanVideo');
    const codeReader = new ZXing.BrowserMultiFormatReader();
    codeReader.decodeFromVideoElement(video, (result, err) => {
      if (result) { codeReader.reset(); handleBarcode(result.getText()); }
    });
  } catch(e) { toast('Scanner non supportato. Usa il barcode manuale.'); }
}

// Riceve il barcode letto, cerca su OpenFoodFacts e precompila la riga
async function handleBarcode(barcode) {
  cancelAnimationFrame(scanAnimFrame);
  toast('\uD83D\uDCE6 Codice: ' + barcode + ' \u2014 ricerca...');
  try {
    const url = 'https://world.openfoodfacts.org/api/v0/product/' + barcode + '.json';
    const r = await fetch(url, { headers: { 'User-Agent': 'GlicoLog/1.0' } });
    const data = await r.json();
    if (data.status === 1 && data.product) {
      const p = data.product;
      const nm = p.nutriments || {};
      const name = (p.product_name_it || p.product_name || p.generic_name || 'Prodotto sconosciuto').trim();
      const carbs   = nm['carbohydrates_100g'] ?? null;
      const protein = nm['proteins_100g'] ?? null;
      const fat     = nm['fat_100g'] ?? null;
      const fiber   = nm['fiber_100g'] ?? null;
      const kcal    = nm['energy-kcal_100g'] || Math.round((carbs||0)*4+(protein||0)*4+(fat||0)*9);
      const food = {
        name,
        carbs:   Math.round((carbs||0)*10)/10,
        protein: Math.round((protein||0)*10)/10,
        fat:     Math.round((fat||0)*10)/10,
        fiber:   Math.round((fiber||0)*10)/10,
        kcal:    Math.round(kcal||0),
        source:  '\uD83D\uDCE6 Barcode'
      };
      closeScanner();
      // Aggiunge riga alimento e precompila nome + mostra selettore porzione
      addFoodRow(scanPre);
      setTimeout(() => {
        const rows = document.getElementById('foodRows' + scanPre);
        const inputs = rows.querySelectorAll('input[type="text"]');
        const lastInput = inputs[inputs.length - 1];
        if (lastInput) lastInput.value = name;
        nutState[scanPre + '_selected'] = food;
        nutState['activeInput'] = lastInput ? lastInput.id : null;
        document.getElementById('nutPortName' + scanPre).textContent = name;
        document.getElementById('nutPort' + scanPre).classList.add('on');
        // Mostra anteprima macro nella results div
        const resDiv = document.getElementById('nutRes' + scanPre);
        resDiv.innerHTML =
          '<div class="nut-res-hdr">\uD83D\uDCF7 ' + esc(name) + ' (da barcode)</div>' +
          '<div class="nut-res-item" onclick="selectNutResult(0,\'' + scanPre + '\')">' +
            '<div class="nut-res-name">' + esc(name) + ' <span style="font-size:.6rem;color:var(--txt2)">per 100g</span></div>' +
            '<div class="nut-res-macros">' +
              '<span class="nut-res-m c">C ' + food.carbs + 'g</span>' +
              '<span class="nut-res-m p">P ' + food.protein + 'g</span>' +
              '<span class="nut-res-m g">G ' + food.fat + 'g</span>' +
              (food.fiber ? '<span class="nut-res-m f">F ' + food.fiber + 'g</span>' : '') +
              '<span class="nut-res-m k">' + food.kcal + ' kcal</span>' +
              '<span class="nut-res-src">\uD83D\uDCE6 Barcode</span>' +
            '</div>' +
          '</div>';
        nutState[scanPre] = [food];
        resDiv.classList.add('on');
        document.getElementById('nutPort' + scanPre).scrollIntoView({behavior:'smooth',block:'nearest'});
      }, 200);
      toast('\u2705 ' + name + ' trovato!');
    } else {
      toast('\u26A0\uFE0F Prodotto non trovato. Codice: ' + barcode);
      scanLoop(); // riprende la scansione
    }
  } catch(e) {
    toast('\u274C Errore di rete. Riprova.');
    scanLoop();
  }
}

// Chiude lo scanner e rilascia la camera
function closeScanner() {
  document.getElementById('scanOv').classList.remove('on');
  if (scanStream) { scanStream.getTracks().forEach(t => t.stop()); scanStream = null; }
  cancelAnimationFrame(scanAnimFrame);
  barcodeDetector = null;
}

// Fallback: inserimento manuale del barcode senza camera
function manualBarcode() {
  const code = prompt('Inserisci il codice a barre (EAN-13):');
  if (code && code.trim()) { handleBarcode(code.trim()); }
}


// ── PULL-TO-REFRESH ───────────────────────────────────────
// Trascina verso il basso dalla cima per ricaricare i dati.
// La freccia ruota quando si raggiunge la soglia (~40px).
// Al rilascio: ri-renderizza timeline, strip, nutrizione, stats.
(function(){
  let startY=0, pulling=false;
  const bar=document.getElementById('ptrBar');
  const THRESHOLD=40;
  document.addEventListener('touchstart',e=>{
    if(document.querySelector('.panel.on')||document.querySelector('.scan-ov.on'))return;
    if(window.scrollY>0)return;
    startY=e.touches[0].clientY; pulling=true;
  },{passive:true});
  document.addEventListener('touchmove',e=>{
    if(!pulling)return;
    const dy=e.touches[0].clientY-startY;
    if(dy<=0){bar.style.height='0';bar.classList.remove('ready');return;}
    const h=Math.min(dy*0.4,52);
    bar.style.height=h+'px';
    bar.classList.toggle('ready',h>=THRESHOLD);
  },{passive:true});
  document.addEventListener('touchend',()=>{
    if(!pulling)return; pulling=false;
    const isReady=bar.classList.contains('ready');
    bar.style.height='0'; bar.classList.remove('ready');
    if(isReady){
      toast('\u21BA Aggiornamento...');
      setTimeout(()=>{
        renderTL();renderStrip();renderNut();renderAlcWeek();
        if(document.getElementById('stB').classList.contains('show'))renderStats();
        toast('\u2705 Aggiornato');
      },300);
    }
  },{passive:true});
})();


// ── HEALTH CONNECT (passi automatici) ────────────────────────
// Legge i passi da Android Health Connect via plugin Capacitor
// @pianissimoproject/capacitor-health-connect
// Usato solo quando l'app gira come APK nativo (window.Capacitor presente)
// In PWA browser il box passi usa inserimento manuale.

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: HEALTH CONNECT (Android) / HEALTHKIT (iOS)
// Integrazione con l'app di salute del dispositivo tramite Capacitor.
//
// syncStepsFromHealth():
//   Legge i passi del giorno corrente da Android Health Connect
//   (o Apple HealthKit su iOS) tramite il plugin Capacitor.
//   Converte il dato e lo salva con saveSteps().
//   Richiede il permesso READ_STEPS in AndroidManifest.xml.
//
// openHealthSettings():
//   Apre le impostazioni di Health Connect sul dispositivo per
//   permettere all'utente di concedere/revocare i permessi.
//
// NOTA: Zepp/Amazfit → Health Connect non è garantito su tutti
//   i dispositivi. Verificare in Health Connect → Fonti dei dati.
// ═══════════════════════════════════════════════════════════════
// Rimuove dal localStorage i record passi con valori impossibili
// (artefatti da bug filtro ISO date — vengono resettati e risincronizzati)
// Rimuove dal localStorage i record passi con valori impossibili
function cleanBadStepRecords() {
  const arr = ldSteps();
  const cleaned = arr.filter(s => s.steps > 0 && s.steps <= 80000);
  if (cleaned.length < arr.length) {
    svSteps(cleaned);
    console.log('cleanBadStepRecords: rimossi ' + (arr.length - cleaned.length) + ' record corrotti');
  }
}

// ═══════════════════════════════════════════════════════════════
// syncStepsFromHealth()
//
// Legge i passi ESCLUSIVAMENTE da Google Health (Android).
// Usa dataOriginFilter per filtrare una sola fonte — nessun
// double-counting possibile. Il plugin @pianissimoproject/
// capacitor-health-connect 0.7.1 supporta:
//   readRecords({ type, timeRangeFilter, dataOriginFilter })
// dove dataOriginFilter è un array di package name Android.
//
// Google Health package: com.google.android.apps.healthdata
//
// Flusso permessi corretto:
//   1. checkHealthPermissions — non apre dialog
//   2. requestHealthPermissions — apre dialog SOLO se necessario
// ═══════════════════════════════════════════════════════════════
const HEALTH_PACKAGE = 'com.google.android.apps.healthdata';

async function syncStepsFromHealth() {
  try {
    if (!window.Capacitor?.Plugins?.HealthConnect) return;
    const HC = window.Capacitor.Plugins.HealthConnect;

    // 1. Verifica che Health Connect sia installato
    let avail;
    try { avail = await HC.checkAvailability(); } catch(e) { return; }
    if (!avail || avail.availability !== 'Available') return;

    // 2. Controlla permessi SENZA aprire dialog
    let hasPerms = false;
    try {
      const check = await HC.checkHealthPermissions({ read: ['Steps'], write: [] });
      hasPerms = check?.hasAllPermissions === true;
    } catch(e) {
      console.warn('checkHealthPermissions error:', e);
    }

    // 3. Richiedi permessi SOLO se non già concessi (apre dialog Android)
    if (!hasPerms) {
      try {
        await HC.requestHealthPermissions({ read: ['Steps'], write: [] });
      } catch(e) {
        console.warn('requestHealthPermissions failed:', e);
        return;
      }
    }

    // 4. Range: da lunedì della settimana corrente a oggi
    const now = new Date();
    const dow = now.getDay();
    const monday = new Date(now);
    monday.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1));
    monday.setHours(0, 0, 0, 0);

    const stepsArr = ldSteps();
    let updated = false;

    for (let d = new Date(monday); d <= now; d.setDate(d.getDate() + 1)) {
      const dayStart = new Date(d);
      dayStart.setHours(0, 0, 0, 0);
      const dayEnd = new Date(d);
      dayEnd.setHours(23, 59, 59, 999);
      const dateKey = dayStart.getFullYear() + '-' + p2(dayStart.getMonth() + 1) + '-' + p2(dayStart.getDate());

      try {
        // Legge SOLO da Google Health — nessun double-counting possibile
        const result = await HC.readRecords({
          type: 'Steps',
          timeRangeFilter: {
            type: 'between',
            startTime: dayStart.toISOString(),  // ISO string richiesta dal plugin
            endTime:   dayEnd.toISOString()
          },
          dataOriginFilter: [HEALTH_PACKAGE]    // unica fonte autorizzata
        });

        if (result?.records?.length) {
          // Somma r.count (campo confermato dal Serializer.kt del plugin)
          const totalSteps = result.records.reduce((sum, r) => {
            return sum + (typeof r.count === 'number' ? r.count : 0);
          }, 0);

          // Sanity: max fisiologico umano ~80.000 passi/giorno
          if (totalSteps > 0 && totalSteps <= 80000) {
            const existing = stepsArr.findIndex(s => s.date === dateKey);
            const entry = { date: dateKey, steps: totalSteps, stride: 75, ts: Date.now(), fromHealth: true };
            if (existing >= 0) stepsArr[existing] = entry;
            else stepsArr.push(entry);
            updated = true;
          } else if (totalSteps > 80000) {
            console.warn('syncStepsFromHealth: valore impossibile ignorato (' + totalSteps + ' per ' + dateKey + ')');
          }
        }
      } catch(e) {
        console.warn('readRecords error per ' + dateKey + ':', e);
      }
    }

    if (updated) {
      svSteps(stepsArr);
      renderSummary();
      const todayData = stepsArr.find(s => s.date === getDK(0));
      if (todayData) {
        toast('👟 ' + todayData.steps.toLocaleString('it') + ' passi sincronizzati');
      }
    }
  } catch(e) {
    console.warn('Health Connect sync error:', e);
  }
}


// Apri Health Connect settings (per gestione permessi)
async function openHealthSettings() {
  if (window.Capacitor?.Plugins?.HealthConnect) {
    try { await window.Capacitor.Plugins.HealthConnect.openHealthConnectSetting(); } catch(e) {}
  }
}

// ── INIZIALIZZAZIONE ────────────────────────────────────
// Eseguito al caricamento: renderizza tutte le sezioni
// ═══════════════════════════════════════════════════════════════
// INIZIALIZZAZIONE APP
// Sequenza di avvio: imposta label giorno → renderizza timeline →
//   strip chip → barra alcool settimanale → sezione nutrizione →
//   statistiche → grafico → box riepilogo → sezione mensile
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: ONBOARDING PRIMO AVVIO
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: FILE SYSTEM — DOPPIO BINARIO WEB + CAPACITOR APK
//
// BROWSER (Chrome/Edge desktop & Android):
//   usa showDirectoryPicker() → FileSystemDirectoryHandle
//   persistenza handle in IndexedDB tra sessioni
//
// APK CAPACITOR (Android/iOS):
//   usa Capacitor Filesystem Plugin → path fisso in Documents
//   GlicoLog/Data-Non_Eliminare/glicolog_data.json  (backup JSON)
//   GlicoLog/Report/<filename>.pdf                  (PDF esportati)
//   Nessuna scelta cartella: tutto è automatico e trasparente
// ═══════════════════════════════════════════════════════════════

// ── Rilevamento ambiente ─────────────────────────────────────────
// IS_NATIVE: true se l'app gira come APK Capacitor (non browser)
// Valutato a parse-time — window.Capacitor è iniettato dal bridge prima del JS
const IS_NATIVE = !!(
  window.Capacitor &&
  typeof window.Capacitor.isNativePlatform === 'function' &&
  window.Capacitor.isNativePlatform()
);
const _capFS  = () => (IS_NATIVE && window.Capacitor?.Plugins?.Filesystem) ? window.Capacitor.Plugins.Filesystem : null;
const _capShr = () => IS_NATIVE ? (window.Capacitor?.Plugins?.Share)      : null;
const CAP_DIR_DOC = 'DOCUMENTS';
const NATIVE_DATA_PATH   = 'GlicoLog/Data-Non_Eliminare/glicolog_data.json';
const NATIVE_REPORT_DIR  = 'GlicoLog/Report/';

// ── Stato FS (Web) ───────────────────────────────────────────────
let _fsRoot      = null;  // FileSystemDirectoryHandle root
let _fsDataDir   = null;  // FileSystemDirectoryHandle Data-Non_Eliminare
let _fsReportDir = null;  // FileSystemDirectoryHandle Report

// ── Stato FS (Native) ────────────────────────────────────────────
let _fsNativeReady = false;  // true quando Capacitor FS è configurato e funzionante

// ── Helper unificato ─────────────────────────────────────────────
const _fsReady = () => _fsNativeReady || !!_fsDataDir;

// ── IndexedDB (solo Web, per persistere FileSystemDirectoryHandle) ──
const IDB_NAME = 'GlicoLogFS', IDB_STORE = 'handles', IDB_KEY_HANDLE = 'rootHandle';
function _openIDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(IDB_NAME, 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE);
    req.onsuccess = e => res(e.target.result);
    req.onerror   = e => rej(e.target.error);
  });
}
async function _idbSet(key, val) {
  const db = await _openIDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(val, key);
    tx.oncomplete = res; tx.onerror = e => rej(e.target.error);
  });
}
async function _idbGet(key) {
  const db = await _openIDB();
  return new Promise((res, rej) => {
    const tx = db.transaction(IDB_STORE, 'readonly');
    const req = tx.objectStore(IDB_STORE).get(key);
    req.onsuccess = e => res(e.target.result);
    req.onerror   = e => rej(e.target.error);
  });
}
async function _verifyFSPermission(handle, mode = 'readwrite') {
  const opts = { mode };
  if ((await handle.queryPermission(opts)) === 'granted') return true;
  if ((await handle.requestPermission(opts)) === 'granted') return true;
  return false;
}

// ── Native: richiedi permessi storage Android ────────────────────
async function _nativeRequestPermissions() {
  const FS = _capFS();
  if (!FS) return false;
  try {
    const perm = await FS.requestPermissions();
    return !perm?.publicStorage || perm.publicStorage === 'granted';
  } catch(e) {
    return true; // Android 10+ non richiede permesso esplicito per Documents
  }
}

// ── Native: crea cartelle GlicoLog se non esistono ───────────────
async function _nativeEnsureDirs() {
  const FS = _capFS();
  if (!FS) return false;
  try {
    // GlicoLog/Data-Non_Eliminare
    await FS.mkdir({ path: 'GlicoLog/Data-Non_Eliminare', directory: CAP_DIR_DOC, recursive: true });
  } catch(e) { /* già esistente, ok */ }
  try {
    // GlicoLog/Report
    await FS.mkdir({ path: 'GlicoLog/Report', directory: CAP_DIR_DOC, recursive: true });
  } catch(e) { /* già esistente, ok */ }
  return true;
}

// ═══════════════════════════════════════════════════════════════
// fsRestoreAccess()
//   WEB: ripristina FileSystemDirectoryHandle da IndexedDB
//   NATIVE: verifica che Capacitor FS sia disponibile
// ═══════════════════════════════════════════════════════════════
async function fsRestoreAccess() {
  if (IS_NATIVE) {
    const FS = _capFS();
    if (!FS) return false;
    // Crea cartelle se mancano (idempotente)
    await _nativeEnsureDirs();
    _fsNativeReady = true;
    return true;
  }
  // Browser: ripristina handle da IndexedDB
  try {
    const rootHandle = await _idbGet(IDB_KEY_HANDLE);
    if (!rootHandle) return false;
    const ok = await _verifyFSPermission(rootHandle);
    if (!ok) return false;
    _fsRoot      = rootHandle;
    _fsReportDir = await _fsRoot.getDirectoryHandle('Report',               { create: true });
    _fsDataDir   = await _fsRoot.getDirectoryHandle('Data-Non_Eliminare',   { create: true });
    return true;
  } catch(e) {
    console.warn('fsRestoreAccess (web) failed:', e);
    return false;
  }
}

// ═══════════════════════════════════════════════════════════════
// initFSAccess(fromOnboarding)
//   WEB: apre showDirectoryPicker, crea struttura GlicoLog
//   NATIVE: richede permessi, crea dirs — nessun picker
// ═══════════════════════════════════════════════════════════════
async function initFSAccess(fromOnboarding = false) {
  if (IS_NATIVE) {
    // Native: tutto automatico
    const ok = await _nativeRequestPermissions();
    if (!ok) { toast('⚠️ Permesso storage negato — abilita in Impostazioni > App > GlicoLog'); return false; }
    await _nativeEnsureDirs();
    _fsNativeReady = true;
    _fsUpdateStatusUI();
    toast('✅ Archiviazione automatica configurata!');
    await fsMergeFromBackup();
    await fsSaveData();
    if (fromOnboarding) checkOnbReady();
    return true;
  }
  // Browser: selezione cartella manuale
  try {
    if (!('showDirectoryPicker' in window)) {
      toast('⚠️ Usa Chrome o Edge per questa funzione');
      return false;
    }
    const baseDir   = await window.showDirectoryPicker({ mode: 'readwrite', startIn: 'documents' });
    _fsRoot         = await baseDir.getDirectoryHandle('GlicoLog',             { create: true });
    _fsReportDir    = await _fsRoot.getDirectoryHandle('Report',               { create: true });
    _fsDataDir      = await _fsRoot.getDirectoryHandle('Data-Non_Eliminare',   { create: true });
    await _idbSet(IDB_KEY_HANDLE, _fsRoot);
    _fsUpdateStatusUI();
    toast('✅ Cartella GlicoLog configurata!');
    await fsMergeFromBackup();
    await fsSaveData();
    if (fromOnboarding) checkOnbReady();
    return true;
  } catch(e) {
    if (e.name !== 'AbortError') toast('⚠️ Errore: ' + e.message);
    return false;
  }
}

// ── Aggiorna UI stato FS (onboarding + profilo) ─────────────────
function _fsUpdateStatusUI() {
  const configured = _fsReady();
  const isNative   = IS_NATIVE;

  // Onboarding: mostra box corretto in base all'ambiente
  const fsBox = document.getElementById('onbFsBox');
  const fsNativeBox = document.getElementById('onbFsNativeBox');
  if (isNative) {
    if (fsBox) fsBox.style.display = 'none';
    if (fsNativeBox) fsNativeBox.style.display = '';
  } else {
    if (fsBox) fsBox.style.display = '';
    if (fsNativeBox) fsNativeBox.style.display = 'none';
  }

  // Status text onboarding (web)
  const el = document.getElementById('fsStatusOnb');
  if (el) {
    el.textContent = configured ? '✅ Cartella GlicoLog configurata!' : '';
    el.style.display = configured ? 'block' : 'none';
  }
  // Pulsante onboarding (web)
  const btn = document.getElementById('onbFsBtn');
  if (btn) {
    btn.textContent = configured ? '✅ Cartella selezionata — cambia' : '📂 Seleziona cartella →';
    btn.style.background  = configured ? 'rgba(0,230,118,.15)' : 'var(--card)';
    btn.style.borderColor = configured ? 'rgba(0,230,118,.4)'  : 'var(--bdr2)';
    btn.style.color       = configured ? 'var(--g)'            : 'var(--b)';
  }
  // Avviso "obbligatoria" nell'onboarding (web)
  const fsWarn = document.getElementById('onbFsRequired');
  if (fsWarn) fsWarn.style.display = (configured || isNative) ? 'none' : 'block';
  // Pannello profilo
  const lbl  = document.getElementById('fsProfileLbl');
  const pbtn = document.getElementById('fsProfileBtn');
  if (lbl) {
    lbl.textContent = isNative
      ? '✅ Backup automatico su Documents/GlicoLog/ — sempre attivo.'
      : configured
        ? '✅ Backup automatico attivo. Cartella GlicoLog configurata.'
        : '⚠️ Non configurata. Scegli una cartella per il backup e i report PDF.';
  }
  if (pbtn) {
    pbtn.textContent = isNative ? '📂 Richiedi permessi storage' : (configured ? '📂 Riconfigura cartella' : '📂 Scegli cartella');
    pbtn.style.display = isNative && _fsNativeReady ? 'none' : '';
  }
}

// ═══════════════════════════════════════════════════════════════
// fsSaveData() — salva tutto nel JSON di backup
// ═══════════════════════════════════════════════════════════════
async function fsSaveData() {
  const payload = JSON.stringify({ data: ld(), cfg: ldC(), ts: Date.now(), v: 2 }, null, 2);
  if (IS_NATIVE) {
    const FS = _capFS();
    if (!FS || !_fsNativeReady) return;
    try {
      await FS.writeFile({
        path: NATIVE_DATA_PATH, data: payload,
        directory: CAP_DIR_DOC, recursive: true, encoding: 'utf8'
      });
    } catch(e) { console.warn('fsSaveData (native) error:', e); }
    return;
  }
  // Web
  if (!_fsDataDir) return;
  try {
    const fh = await _fsDataDir.getFileHandle('glicolog_data.json', { create: true });
    const writable = await fh.createWritable();
    await writable.write(payload);
    await writable.close();
  } catch(e) { console.warn('fsSaveData (web) error:', e); }
}

// ═══════════════════════════════════════════════════════════════
// fsMergeFromBackup() — legge il JSON e mergia in localStorage
// ═══════════════════════════════════════════════════════════════
async function fsMergeFromBackup() {
  let text = null;
  if (IS_NATIVE) {
    const FS = _capFS();
    if (!FS) return false;
    try {
      const res = await FS.readFile({
        path: NATIVE_DATA_PATH, directory: CAP_DIR_DOC, encoding: 'utf8'
      });
      text = res.data;
    } catch(e) {
      // File non esiste ancora — prima installazione
      console.warn('fsMergeFromBackup (native): file not found yet');
      return false;
    }
  } else {
    if (!_fsDataDir) return false;
    try {
      const fh   = await _fsDataDir.getFileHandle('glicolog_data.json');
      const file = await fh.getFile();
      text = await file.text();
    } catch(e) {
      console.warn('fsMergeFromBackup (web):', e.message);
      return false;
    }
  }

  if (!text) return false;
  try {
    const parsed = JSON.parse(text);
    if (!parsed || !Array.isArray(parsed.data)) return false;

    // Mergia entries per ID — vince il timestamp più recente
    const localArr = ld();
    const map = {};
    localArr.forEach(e => { if (e.id) map[e.id] = e; });
    let added = 0;
    parsed.data.forEach(e => {
      if (!e.id) return;
      if (!map[e.id])                          { map[e.id] = e; added++; }
      else if ((e.ts||0) > (map[e.id].ts||0)) { map[e.id] = e; }
    });
    const merged = Object.values(map);
    localStorage.setItem(KEY, JSON.stringify(merged));

    // Mergia cfg solo se il backup è più recente
    if (parsed.cfg && (!ldC().__ts || parsed.cfg.__ts > ldC().__ts)) {
      svC(Object.assign(ldC(), parsed.cfg, { __ts: Date.now() }));
    }
    if (added > 0) {
      toast('📂 ' + added + ' voci ripristinate dal backup!');
      renderTL(); renderStrip(); renderNut(); renderSummary();
    } else if (parsed.cfg && merged.length > 0) {
      // Cfg aggiornata ma nessuna entry nuova — riaggiorna comunque i target display
      renderStrip(); renderNut();
    }
    return merged.length > 0;
  } catch(e) {
    console.warn('fsMergeFromBackup parse error:', e);
    return false;
  }
}

// ═══════════════════════════════════════════════════════════════
// fsSavePDF(base64data, filename) — salva il PDF nella cartella Report
//   WEB    → FileSystemDirectoryHandle.getFileHandle + createWritable
//   NATIVE → Capacitor Filesystem.writeFile in Documents/GlicoLog/Report/
//   Ritorna: blobUrl (web) | uri nativo (native) | null se errore
// ═══════════════════════════════════════════════════════════════
async function fsSavePDF(base64data, filename) {
  if (IS_NATIVE) {
    const FS = _capFS();
    if (!FS || !_fsNativeReady) return null;
    try {
      await FS.writeFile({
        path: NATIVE_REPORT_DIR + filename,
        data: base64data,
        directory: CAP_DIR_DOC,
        recursive: true
        // niente encoding → base64 binario
      });
      // Ottieni URI nativo per aprire il file
      const uriRes = await FS.getUri({
        path: NATIVE_REPORT_DIR + filename,
        directory: CAP_DIR_DOC
      });
      return uriRes.uri;
    } catch(e) {
      console.warn('fsSavePDF (native) error:', e);
      return null;
    }
  }
  // Web
  if (!_fsReportDir) return null;
  try {
    const byteChars = atob(base64data);
    const byteArr   = new Uint8Array(byteChars.length);
    for (let i = 0; i < byteChars.length; i++) byteArr[i] = byteChars.charCodeAt(i);
    const blob = new Blob([byteArr], { type: 'application/pdf' });
    const fh   = await _fsReportDir.getFileHandle(filename, { create: true });
    const writable = await fh.createWritable();
    await writable.write(blob);
    await writable.close();
    return URL.createObjectURL(blob);
  } catch(e) {
    console.warn('fsSavePDF (web) error:', e);
    return null;
  }
}

// ═══════════════════════════════════════════════════════════════
// showPdfSavedDialog(urlOrUri, filename)
//   WEB    → dialog con link "Apri" (blobUrl)
//   NATIVE → toast con pulsante "Apri" che usa Share plugin
// ═══════════════════════════════════════════════════════════════
function showPdfSavedDialog(urlOrUri, filename) {
  const old = document.getElementById('pdfSavedDialog');
  if (old) old.remove();
  const d = document.createElement('div');
  d.id = 'pdfSavedDialog';
  d.style.cssText = 'position:fixed;bottom:calc(22px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--bdr2);border-radius:14px;padding:13px 16px;z-index:9980;display:flex;align-items:center;gap:12px;box-shadow:0 8px 30px rgba(0,0,0,.6);max-width:92vw';
  // Etichetta
  const lbl = document.createElement('span');
  lbl.style.cssText = 'font-size:.8rem;color:var(--txt3);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
  lbl.innerHTML = '&#x2705; PDF in <strong style="color:var(--g)">GlicoLog/Report/</strong>';
  d.appendChild(lbl);
  // Pulsante "Apri": link per web, Share per native
  if (IS_NATIVE) {
    const btn = document.createElement('button');
    btn.textContent = 'Apri';
    btn.style.cssText = 'background:var(--g);color:#000;border:none;border-radius:8px;font-size:.82rem;font-weight:700;padding:8px 14px;cursor:pointer;flex-shrink:0;white-space:nowrap;font-family:var(--sans)';
    btn.onclick = async () => {
      try {
        // window.open con '_system' -> Capacitor lo converte in Intent Android
        // apre il PDF con il viewer predefinito del dispositivo (no share sheet)
        if (window.open(urlOrUri, '_system') === null) {
          // Fallback: share se window.open non funziona
          const shr = _capShr();
          if (shr) await shr.share({ title: filename, url: urlOrUri, dialogTitle: 'Apri PDF con…' });
          else toast('Apri da Documents/GlicoLog/Report/');
        }
        d.remove();
      } catch(e) {
        console.warn('open pdf error', e);
        toast('Apri da Documents/GlicoLog/Report/');
      }
    };
    d.appendChild(btn);
  } else {
    const a = document.createElement('a');
    a.href = urlOrUri; a.target = '_blank';
    a.style.cssText = 'background:var(--g);color:#000;border-radius:8px;font-size:.82rem;font-weight:700;padding:8px 14px;text-decoration:none;flex-shrink:0;white-space:nowrap';
    a.textContent = 'Apri';
    d.appendChild(a);
  }
  // Pulsante chiudi
  const x = document.createElement('button');
  x.textContent = '×';
  x.style.cssText = 'background:none;border:none;color:var(--txt2);font-size:1.2rem;cursor:pointer;padding:2px 6px;flex-shrink:0';
  x.onclick = () => { d.remove(); if (!IS_NATIVE) URL.revokeObjectURL(urlOrUri); };
  d.appendChild(x);
  document.body.appendChild(d);
  setTimeout(() => { if (d.parentNode) { d.remove(); if (!IS_NATIVE) URL.revokeObjectURL(urlOrUri); } }, 5000);
}

// ═══════════════════════════════════════════════════════════════
// SEZIONE JS: ONBOARDING PRIMO AVVIO
// ═══════════════════════════════════════════════════════════════
const onbSg = {};

function pSegOnb(b, k) {
  const p = b.closest('.seg');
  if (p) p.querySelectorAll('.sb').forEach(x => x.classList.remove('on'));
  b.classList.add('on');
  onbSg[k] = b.dataset.v;
  const hid = document.getElementById(k);
  if (hid) hid.value = b.dataset.v;
  checkOnbReady();
}

function checkOnbReady() {
  // Sull'APK la FS è sempre disponibile automaticamente
  const fsOk   = IS_NATIVE || _fsReady();
  const age    = document.getElementById('onbAge')?.value;
  const weight = document.getElementById('onbWeight')?.value;
  const height = document.getElementById('onbHeight')?.value;
  const sex    = onbSg['onbSex'];
  const act    = onbSg['onbAct'];
  const goal   = onbSg['onbGoal'];
  const tMin   = document.getElementById('onbMin')?.value;
  const tMax   = document.getElementById('onbMax')?.value;
  const fsi    = document.getElementById('onbFsi')?.value;
  const ic     = document.getElementById('onbIc')?.value;
  const ready  = fsOk && age && weight && height && sex && act && goal && tMin && tMax && fsi && ic;
  const btn    = document.getElementById('onbSaveBtn');
  if (btn) btn.classList.toggle('ready', !!ready);
  const fsWarn = document.getElementById('onbFsRequired');
  if (fsWarn) fsWarn.style.display = fsOk ? 'none' : 'block';
}

function saveOnboarding() {
  if (!IS_NATIVE && !_fsReady()) { toast('⚠️ Seleziona prima la cartella GlicoLog'); return; }
  const age       = parseInt(document.getElementById('onbAge').value);
  const weight    = parseFloat(document.getElementById('onbWeight').value);
  const height    = parseInt(document.getElementById('onbHeight').value);
  const sex       = onbSg['onbSex'];
  const activity  = parseFloat(onbSg['onbAct']);
  const goal      = onbSg['onbGoal'];
  const targetMin = parseInt(document.getElementById('onbMin').value);
  const targetMax = parseInt(document.getElementById('onbMax').value);
  const fsi       = parseInt(document.getElementById('onbFsi').value);
  const ic        = parseFloat(document.getElementById('onbIc').value);
  const insRapida = document.getElementById('onbInsR').value || 'Humalog';
  const insBasale = document.getElementById('onbInsB').value || '';
  if (!age||!weight||!height||!sex||!activity||!goal||!targetMin||!targetMax||!fsi||!ic) {
    toast('⚠️ Compila tutti i campi obbligatori'); return;
  }
  const macros = calcMacros(age, sex, weight, height, activity, goal);
  svC(Object.assign(ldC(), { age, weight, height, sex, activity, goal,
    targetMin, targetMax, fsi, ic, insRapida, insBasale,
    alcMax: 5, __ts: Date.now(), ...macros }));
  const onbEl = document.getElementById('onbOverlay');
  if (onbEl) { onbEl.classList.remove('on'); onbEl.style.background = ''; onbEl.style.color = ''; }
  localStorage.setItem('glicolog_onboarded', '1'); // compatibilità versioni precedenti
  fsSaveData();
  toast('✅ Profilo salvato — benvenuto in GlicoLog!');
  renderNut(); renderStrip(); renderSummary();
}

// ═══════════════════════════════════════════════════════════════
// appInit() — sequenza di avvio
// 1. Ripristina accesso FS (silenzioso)
// 2. Mergia JSON di backup con localStorage
// 3. Aggiorna UI FS
// 4. Mostra onboarding se profilo mancante
// ═══════════════════════════════════════════════════════════════
// ── hasProfile: controlla se l'utente ha già configurato l'app ──────
// Profilo valido = campi personali obbligatori tutti presenti e non-zero.
// Con DEF ripulito dai default personali, su nuovo dispositivo questi sono
// tutti undefined/falsy → onboarding viene mostrato correttamente.
function _hasProfile() {
  // Vecchio flag di compatibilità (versioni precedenti dell'app)
  if (localStorage.getItem('glicolog_onboarded') === '1') return true;
  // Legge RAW da localStorage (senza i fallback di rendering di ldC)
  // così su nuovo dispositivo i campi sono davvero undefined
  let raw = {};
  try { raw = JSON.parse(localStorage.getItem(CFGKEY)) || {}; } catch {}
  return !!(
    raw.weight    && raw.weight    > 0 &&
    raw.height    && raw.height    > 0 &&
    raw.fsi       && raw.fsi       > 0 &&
    raw.targetMin && raw.targetMax      &&
    raw.sex
  );
}

async function appInit() {
  try {
    // 1. Tenta accesso FS (tollerante: se fallisce, app funziona comunque)
    let fsOk = false;
    try {
      fsOk = await fsRestoreAccess();
    } catch(e) {
      console.warn('fsRestoreAccess failed:', e);
    }

    // 2. Mergia dati dal JSON backup
    if (fsOk) {
      try { await fsMergeFromBackup(); } catch(e) { console.warn('fsMergeFromBackup failed:', e); }
    }

    // 3. Aggiorna UI FS
    try { _fsUpdateStatusUI(); } catch(e) {}

    // 4. Mostra onboarding SOLO se profilo davvero mancante
    if (!_hasProfile()) {
      const overlay = document.getElementById('onbOverlay');
      if (overlay) {
        overlay.classList.add('on');
        // Forza background visibile in caso di CSS var failure su vecchie WebView
        overlay.style.background = '#0d0d0d';
        overlay.style.color = '#fff';
      }
      checkOnbReady();
    }
  } catch(e) {
    console.error('appInit critical error:', e);
    // Non bloccare l'app per nessun motivo
  }
  // Pulisci eventuali record passi corrotti salvati in precedenza
  try { cleanBadStepRecords(); } catch(e) {}
}

function addFSButtonToProfile() { _fsUpdateStatusUI(); }

setDL();renderTL();renderStrip();renderAlcWeek();renderNut();renderStats();drawChart();renderSummary();
appInit();
setTimeout(_fsUpdateStatusUI, 500);

// Sync passi Health Connect (solo APK)
document.addEventListener('deviceready', async () => {
  // Retry FS se i plugin non erano pronti al primo appInit
  if (IS_NATIVE && !_fsNativeReady) {
    try {
      const ok = await fsRestoreAccess();
      if (ok) {
        await fsMergeFromBackup();
        _fsUpdateStatusUI();
      }
    } catch(e) { console.warn('deviceready FS retry failed:', e); }
  }
  setTimeout(syncStepsFromHealth, 1500);
}, false);
if (window.Capacitor) setTimeout(syncStepsFromHealth, 2000);

</script>
</body>
</html>